<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify å®æ—¶åˆ†æä»ªè¡¨ç›˜</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --spotify-green: #1DB954;
      --bg-primary: #0a0a0a;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #252525;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-tertiary: rgba(255, 255, 255, 0.4);
      --border-color: rgba(255, 255, 255, 0.08);
      --success: #1DB954;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* é¡¶éƒ¨å¯¼èˆªæ  */
    .navbar {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 16px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
    }

    .navbar-content {
      max-width: 1800px;
      margin: 0 auto;
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand-logo {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, var(--spotify-green), #1ed760);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(29, 185, 84, 0.3);
    }

    .brand-logo svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    .brand-info h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .brand-info p {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    .navbar-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .lang-switch {
      display: flex;
      gap: 4px;
      background: var(--bg-tertiary);
      padding: 4px;
      border-radius: 8px;
    }

    .lang-btn {
      padding: 6px 12px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .lang-btn:hover {
      color: var(--text-primary);
    }

    .lang-btn.active {
      background: var(--spotify-green);
      color: white;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(29, 185, 84, 0.1);
      border: 1px solid rgba(29, 185, 84, 0.2);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--spotify-green);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: var(--spotify-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(29, 185, 84, 0.7); }
      50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(29, 185, 84, 0); }
    }

    /* ä¸»å®¹å™¨ */
    .container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 32px;
    }

    /* åˆ†åŒºæ ‡é¢˜ */
    .section {
      margin-bottom: 48px;
    }

    .section-header {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 800;
      letter-spacing: -0.5px;
      margin-bottom: 8px;
    }

    .section-subtitle {
      font-size: 14px;
      color: var(--text-tertiary);
    }

    /* ========== é¦–å±é‡ç‚¹æ•°æ®åŒº ========== */
    .hero-section {
      margin-bottom: 48px;
    }

    /* æ ¸å¿ƒæŒ‡æ ‡è¡Œ */
    .hero-main {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 1200px) {
      .hero-main {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .hero-main {
        grid-template-columns: 1fr;
      }
    }

    /* ç»Ÿä¸€çš„æŒ‡æ ‡å¡ç‰‡ */
    .metric-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      border-color: rgba(29, 185, 84, 0.3);
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--spotify-green), #1ed760);
    }


    .metric-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 36px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1;
      margin-bottom: 16px;
    }

    .metric-compare {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .metric-compare-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 12px;
    }

    .metric-compare-label {
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .metric-compare-value {
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 4px;
      text-align: right;
    }

    .metric-change {
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .metric-change.up {
      color: #1DB954;
      background: rgba(29, 185, 84, 0.15);
    }

    .metric-change.down {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.15);
    }

    /* æ—¶æ®µæ’è¡Œè¡¨æ ¼ */
    .hourly-table {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden;
    }

    .hourly-row {
      display: grid;
      grid-template-columns: 80px 120px 1fr 100px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      align-items: center;
      transition: background 0.2s;
    }

    .hourly-row:last-child {
      border-bottom: none;
    }

    .hourly-row:hover {
      background: var(--bg-tertiary);
    }

    .hourly-row.header {
      background: var(--bg-tertiary);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .hourly-rank {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .hourly-rank.top3 {
      color: var(--spotify-green);
    }

    .hourly-time {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .hourly-regions {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .hourly-region {
      background: var(--bg-tertiary);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .hourly-avg {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      text-align: right;
    }

    .hourly-bar-container {
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }

    .hourly-bar {
      height: 100%;
      background: var(--spotify-green);
      border-radius: 2px;
    }

    @media (max-width: 768px) {
      .hourly-row {
        grid-template-columns: 60px 1fr 80px;
      }
      .hourly-regions {
        display: none;
      }
    }

    /* æ¯æ—¥æ•°æ®è¡¨æ ¼ */
    .daily-table {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden;
    }

    .daily-row {
      display: grid;
      grid-template-columns: 120px 1fr 1fr 1fr 100px;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border-color);
      align-items: center;
      transition: background 0.2s;
    }

    .daily-row:last-child {
      border-bottom: none;
    }

    .daily-row:hover {
      background: var(--bg-tertiary);
    }

    .daily-row.header {
      background: var(--bg-tertiary);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .daily-date {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .daily-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .daily-streams {
      font-size: 15px;
      font-weight: 700;
      color: var(--spotify-green);
    }

    .daily-samples {
      font-size: 12px;
      color: var(--text-tertiary);
      text-align: right;
    }

    .load-more-btn {
      width: 100%;
      padding: 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s;
    }

    .load-more-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--spotify-green);
      color: var(--spotify-green);
    }

    .load-more-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .daily-row {
        grid-template-columns: 90px 1fr 1fr 1fr;
      }
      .daily-samples {
        display: none;
      }
    }

    /* é‚®ä»¶è®¾ç½®æ¨¡æ€æ¡† */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      width: 100%;
      max-width: 500px;
      padding: 32px;
      position: relative;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 24px;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--spotify-green);
      box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
    }

    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      cursor: pointer;
    }

    .form-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: var(--spotify-green);
    }

    .form-checkbox span {
      font-size: 14px;
      color: var(--text-primary);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--bg-primary);
      border-color: var(--text-tertiary);
    }

    .btn-primary {
      background: var(--spotify-green);
      border: none;
      color: white;
    }

    .btn-primary:hover {
      background: #1ed760;
      transform: translateY(-1px);
    }

    .email-status {
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .email-status.enabled {
      background: rgba(29, 185, 84, 0.1);
      border: 1px solid rgba(29, 185, 84, 0.3);
      color: var(--spotify-green);
    }

    .email-status.disabled {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--danger);
    }

    /* ç®€åŒ–çš„å½“å‰å¬ä¼—å¡ç‰‡ */
    .current-card {
      background: linear-gradient(135deg, #1DB954, #1ed760);
      border: none;
      border-radius: 20px;
      padding: 32px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(29, 185, 84, 0.3);
    }

    .current-card .metric-label {
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      margin-bottom: 12px;
    }

    .current-card .metric-value {
      color: white;
      font-size: 56px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .current-card .metric-subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 13px;
    }

    /* Facebooké£æ ¼æ—¥æœŸé€‰æ‹©å™¨ */
    .date-picker-container {
      position: relative;
    }

    .date-picker-trigger {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 180px;
    }

    .date-picker-trigger:hover {
      border-color: var(--spotify-green);
    }

    .date-picker-trigger svg {
      width: 16px;
      height: 16px;
      fill: var(--text-secondary);
    }

    .date-picker-trigger .arrow {
      margin-left: auto;
      transition: transform 0.2s;
    }

    .date-picker-trigger.open .arrow {
      transform: rotate(180deg);
    }

    .date-picker-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 280px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      z-index: 100;
      display: none;
      max-height: 400px;
      overflow-y: auto;
    }

    .date-picker-dropdown.open {
      display: block;
    }

    .date-picker-section {
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .date-picker-section:last-child {
      border-bottom: none;
    }

    .date-picker-section-title {
      padding: 8px 16px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .date-picker-option {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .date-picker-option:hover {
      background: var(--bg-tertiary);
    }

    .date-picker-option.active {
      background: rgba(29, 185, 84, 0.1);
      color: var(--spotify-green);
    }

    .date-picker-option .check {
      margin-left: auto;
      opacity: 0;
    }

    .date-picker-option.active .check {
      opacity: 1;
    }

    /* è‡ªå®šä¹‰æ—¥æœŸè¾“å…¥ */
    .custom-date-inputs {
      padding: 12px 16px;
      display: none;
    }

    .custom-date-inputs.show {
      display: block;
    }

    .custom-date-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .custom-date-inputs input[type="date"] {
      flex: 1;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
    }

    .custom-date-inputs input[type="date"]:focus {
      outline: none;
      border-color: var(--spotify-green);
    }

    .custom-date-apply {
      width: 100%;
      padding: 10px;
      background: var(--spotify-green);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .custom-date-apply:hover {
      background: #1ed760;
    }

    /* å…³é”®æŒ‡æ ‡ç½‘æ ¼ - ä¿ç•™ç”¨äºfallback */
    .key-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    /* å½“å‰å¬ä¼—å¡ç‰‡ï¼ˆç‰¹æ®Šæ ·å¼ï¼‰ */
    .key-metric-card.primary {
      background: linear-gradient(135deg, #1DB954, #1ed760);
      border: none;
      box-shadow: 0 10px 30px rgba(29, 185, 84, 0.3);
    }

    .key-metric-card.primary::before {
      display: none;
    }

    .key-metric-card.primary .key-metric-label,
    .key-metric-card.primary .key-metric-value,
    .key-metric-card.primary .key-metric-subtitle,
    .key-metric-card.primary .key-metric-trend {
      color: white;
    }

    .key-metric-trend {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 8px;
    }

    .key-metric-trend-icon {
      font-size: 18px;
    }

    .key-metric-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 32px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .key-metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      border-color: rgba(29, 185, 84, 0.3);
    }

    .key-metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--spotify-green), #1ed760);
    }

    .key-metric-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .key-metric-value {
      font-size: 48px;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 12px;
      letter-spacing: -2px;
    }

    .key-metric-subtitle {
      font-size: 14px;
      color: var(--text-tertiary);
    }

    .key-metric-trend {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(29, 185, 84, 0.15);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      color: var(--spotify-green);
      margin-top: 12px;
    }

    .key-metric-trend.negative {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    /* ========== å›¾è¡¨åŒºåŸŸ ========== */
    .chart-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .chart-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .chart-subtitle {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .time-selector {
      display: flex;
      gap: 6px;
      background: var(--bg-tertiary);
      padding: 4px;
      border-radius: 10px;
    }

    .time-btn,
    .chart-type-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .time-btn:hover,
    .chart-type-btn:hover {
      color: var(--text-primary);
    }

    .time-btn.active,
    .chart-type-btn.active {
      background: var(--spotify-green);
      color: white;
    }

    .chart-container {
      position: relative;
      height: 400px;
    }

    /* ========== è¯¦ç»†ç»Ÿè®¡åŒºåŸŸ ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      background: var(--bg-tertiary);
      border-color: rgba(29, 185, 84, 0.2);
    }

    .stat-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .stat-hour {
      font-size: 18px;
      font-weight: 700;
    }

    .stat-timezones {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
      line-height: 1.4;
    }

    .stat-timezone {
      display: inline-block;
      margin-right: 8px;
    }

    /* æ—¶æ®µåˆ†æå¡ç‰‡ */
    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .insight-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      gap: 16px;
      transition: all 0.3s ease;
    }

    .insight-card:hover {
      background: var(--bg-tertiary);
      border-color: rgba(29, 185, 84, 0.3);
    }

    .insight-card.highlight {
      background: linear-gradient(135deg, rgba(29, 185, 84, 0.15), rgba(29, 185, 84, 0.05));
      border-color: rgba(29, 185, 84, 0.3);
    }

    .insight-card.peak {
      border-left: 3px solid var(--spotify-green);
    }

    .insight-icon {
      font-size: 32px;
      flex-shrink: 0;
    }

    .insight-content {
      flex: 1;
    }

    .insight-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .insight-detail {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .insight-subdetail {
      font-size: 13px;
      color: var(--text-secondary);
      opacity: 0.8;
    }

    .insight-value {
      font-size: 13px;
      color: var(--spotify-green);
      font-weight: 600;
      margin-top: 8px;
    }

    .insight-tag {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(29, 185, 84, 0.2);
      color: var(--spotify-green);
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .insight-tag.low {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .insight-summary {
      background: var(--bg-tertiary);
      border-radius: 16px;
      padding: 24px;
      margin-top: 24px;
    }

    .summary-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .summary-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .summary-list li {
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 14px;
    }

    .summary-list li:last-child {
      border-bottom: none;
    }

    .summary-list strong {
      color: var(--spotify-green);
    }

    .stat-badge {
      padding: 4px 12px;
      background: rgba(29, 185, 84, 0.15);
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      color: var(--spotify-green);
      text-transform: uppercase;
    }

    .stat-badge.low {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .stat-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
    }

    .stat-change {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--danger);
    }

    .stat-change.neutral {
      color: var(--text-tertiary);
    }

    /* ========== æ•°æ®åˆ†æåŒºåŸŸ ========== */
    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }

    .analysis-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 32px;
    }

    .analysis-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .analysis-subtitle {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-bottom: 24px;
    }

    .analysis-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .analysis-row:last-child {
      border-bottom: none;
    }

    .analysis-metric {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .analysis-value {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .analysis-number {
      font-size: 24px;
      font-weight: 700;
    }

    .analysis-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: rgba(29, 185, 84, 0.15);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      color: var(--spotify-green);
    }

    .analysis-trend.negative {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    /* æ“ä½œæŒ‰é’® */
    .actions-section {
      margin-top: 64px;
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 16px 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .action-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--spotify-green);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(29, 185, 84, 0.2);
    }

    .action-btn.danger {
      border-color: rgba(239, 68, 68, 0.3);
    }

    .action-btn.danger:hover {
      border-color: var(--danger);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.2);
    }

    .action-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* é¡µè„š */
    .footer {
      text-align: center;
      padding: 48px 32px;
      color: var(--text-tertiary);
      font-size: 13px;
      border-top: 1px solid var(--border-color);
      margin-top: 64px;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
      flex-direction: column;
      gap: 16px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(29, 185, 84, 0.1);
      border-top-color: var(--spotify-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* é”™è¯¯æç¤º */
    .alert {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .alert-icon {
      font-size: 28px;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 700;
      color: var(--danger);
      margin-bottom: 4px;
    }

    .alert-message {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .alert-action {
      padding: 10px 20px;
      background: var(--danger);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .alert-action:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    /* å“åº”å¼ */
    @media (max-width: 1200px) {
      .key-metrics {
        grid-template-columns: repeat(2, 1fr);
      }

      .analysis-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .navbar-content {
        padding: 0 20px;
        flex-wrap: wrap;
        gap: 12px;
      }

      .primary-value {
        font-size: 64px;
      }

      .key-metric-value {
        font-size: 36px;
      }

      .key-metrics {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- å¯¼èˆªæ  -->
  <nav class="navbar">
    <div class="navbar-content">
      <div class="brand">
        <div class="brand-logo">
          <svg viewBox="0 0 24 24"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
        </div>
        <div class="brand-info">
          <h1 data-i18n="app.title">å®æ—¶åˆ†æ</h1>
          <p data-i18n="app.subtitle">Spotify å¬ä¼—è¿½è¸ªä»ªè¡¨ç›˜</p>
        </div>
      </div>
      <div class="navbar-actions">
        <div class="lang-switch">
          <button class="lang-btn active" data-lang="zh">ä¸­æ–‡</button>
          <button class="lang-btn" data-lang="en">English</button>
        </div>
        <div class="status-badge" id="status-badge">
          <span class="status-dot"></span>
          <span data-i18n="status.live">å®æ—¶ç›‘æ§</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- ä¸»å®¹å™¨ -->
  <div class="container">

    <!-- é”™è¯¯æç¤º -->
    <div id="error-alert" style="display: none;"></div>

    <!-- ========== ç¬¬ä¸€éƒ¨åˆ†ï¼šæ•°æ®æ¦‚è§ˆ ========== -->
    <section class="hero-section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.overview">æ•°æ®æ¦‚è§ˆ</h2>
        <p class="section-subtitle" data-i18n="section.overviewDesc">å®æ—¶æ•°æ®ä¸å†å²å¯¹æ¯” <span style="opacity: 0.6; font-size: 12px;" data-i18n="timezone.utc">(UTCæ—¶åŒº)</span></p>
      </div>

      <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
      <div id="hero-content">
        <div class="loading">
          <div class="spinner"></div>
          <p data-i18n="loading">åŠ è½½ä¸­...</p>
        </div>
      </div>
    </section>

    <!-- ========== ç¬¬äºŒéƒ¨åˆ†ï¼šå›¾è¡¨åŒºåŸŸ ========== -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.charts">è¶‹åŠ¿å›¾è¡¨</h2>
        <p class="section-subtitle" data-i18n="section.chartsDesc">æ•°æ®å¯è§†åŒ–åˆ†æ</p>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title" data-i18n="chart.timeline">å¬ä¼—è¶‹åŠ¿</div>
            <div class="chart-subtitle" id="chart-subtitle" data-i18n="chart.timelineDesc">å®æ—¶å¬ä¼—æ•°é‡å˜åŒ– (UTC)</div>
          </div>
          <div style="display: flex; gap: 12px; align-items: center;">
            <!-- Facebooké£æ ¼æ—¥æœŸé€‰æ‹©å™¨ -->
            <div class="date-picker-container">
              <div class="date-picker-trigger" id="date-picker-trigger" onclick="toggleDatePicker()">
                <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg>
                <span id="date-picker-label">ä»Šå¤©</span>
                <svg class="arrow" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
              </div>
              <div class="date-picker-dropdown" id="date-picker-dropdown">
                <!-- æœ€è¿‘ä½¿ç”¨ -->
                <div class="date-picker-section" id="recent-used-section" style="display: none;">
                  <div class="date-picker-section-title" data-i18n="date.recentlyUsed">æœ€è¿‘ä½¿ç”¨</div>
                  <div id="recent-used-options"></div>
                </div>
                <!-- é¢„è®¾èŒƒå›´ -->
                <div class="date-picker-section">
                  <div class="date-picker-section-title" data-i18n="date.presets">æ—¥æœŸèŒƒå›´</div>
                  <div class="date-picker-option" data-range="today" onclick="selectDateRange('today')">
                    <span data-i18n="date.today">ä»Šå¤©</span>
                    <span class="check">âœ“</span>
                  </div>
                  <div class="date-picker-option" data-range="yesterday" onclick="selectDateRange('yesterday')">
                    <span data-i18n="date.yesterday">æ˜¨å¤©</span>
                    <span class="check">âœ“</span>
                  </div>
                  <div class="date-picker-option" data-range="todayYesterday" onclick="selectDateRange('todayYesterday')">
                    <span data-i18n="date.todayYesterday">ä»Šå¤©å’Œæ˜¨å¤©</span>
                    <span class="check">âœ“</span>
                  </div>
                  <div class="date-picker-option" data-range="last7days" onclick="selectDateRange('last7days')">
                    <span data-i18n="date.last7days">è¿‡å» 7 å¤©</span>
                    <span class="check">âœ“</span>
                  </div>
                  <div class="date-picker-option" data-range="last14days" onclick="selectDateRange('last14days')">
                    <span data-i18n="date.last14days">è¿‡å» 14 å¤©</span>
                    <span class="check">âœ“</span>
                  </div>
                  <div class="date-picker-option" data-range="last28days" onclick="selectDateRange('last28days')">
                    <span data-i18n="date.last28days">è¿‡å» 28 å¤©</span>
                    <span class="check">âœ“</span>
                  </div>
                  <div class="date-picker-option" data-range="last30days" onclick="selectDateRange('last30days')">
                    <span data-i18n="date.last30days">è¿‡å» 30 å¤©</span>
                    <span class="check">âœ“</span>
                  </div>
                  <div class="date-picker-option" data-range="thisWeek" onclick="selectDateRange('thisWeek')">
                    <span data-i18n="date.thisWeek">æœ¬å‘¨</span>
                    <span class="check">âœ“</span>
                  </div>
                  <div class="date-picker-option" data-range="lastWeek" onclick="selectDateRange('lastWeek')">
                    <span data-i18n="date.lastWeek">ä¸Šå‘¨</span>
                    <span class="check">âœ“</span>
                  </div>
                  <div class="date-picker-option" data-range="thisMonth" onclick="selectDateRange('thisMonth')">
                    <span data-i18n="date.thisMonth">æœ¬æœˆ</span>
                    <span class="check">âœ“</span>
                  </div>
                  <div class="date-picker-option" data-range="lastMonth" onclick="selectDateRange('lastMonth')">
                    <span data-i18n="date.lastMonth">ä¸Šæœˆ</span>
                    <span class="check">âœ“</span>
                  </div>
                  <div class="date-picker-option" data-range="maximum" onclick="selectDateRange('maximum')">
                    <span data-i18n="date.maximum">å…¨éƒ¨æ•°æ®</span>
                    <span class="check">âœ“</span>
                  </div>
                  <div class="date-picker-option" data-range="custom" onclick="toggleCustomDate()">
                    <span data-i18n="date.custom">è‡ªå®šä¹‰</span>
                    <span class="check">âœ“</span>
                  </div>
                </div>
                <!-- è‡ªå®šä¹‰æ—¥æœŸè¾“å…¥ -->
                <div class="custom-date-inputs" id="custom-date-inputs">
                  <div class="custom-date-row">
                    <input type="date" id="custom-start-date">
                    <input type="date" id="custom-end-date">
                  </div>
                  <button class="custom-date-apply" onclick="applyCustomDate()" data-i18n="date.apply">åº”ç”¨</button>
                </div>
              </div>
            </div>
            <div class="time-selector">
              <button class="chart-type-btn active" data-type="raw" data-i18n="chart.raw">åŸå§‹</button>
              <button class="chart-type-btn" data-type="smooth" data-i18n="chart.smooth">å¹³æ»‘</button>
            </div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="main-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- ========== æ—¶æ®µåˆ†æ ========== -->
    <section class="section" id="hourly-section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.hourlyStats">æ—¶æ®µåˆ†æ</h2>
        <p class="section-subtitle" data-i18n="section.hourlyStatsDesc">å„å°æ—¶å¹³å‡å¬ä¼—æ’è¡Œ (UTC)</p>
      </div>
      <div id="hourly-ranking"></div>
    </section>

    <!-- ========== æ¯æ—¥æ•°æ® ========== -->
    <section class="section" id="daily-section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.dailyStats">æ¯æ—¥æ•°æ®</h2>
        <p class="section-subtitle" data-i18n="section.dailyStatsDesc">å†å²æ¯æ—¥å¹³å‡ã€å³°å€¼ä¸é¢„æµ‹æ’­æ”¾é‡</p>
      </div>
      <div id="daily-data"></div>
    </section>

    <!-- ========== å¿«æ·æ“ä½œ ========== -->
    <section class="actions-section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.actions">å¿«æ·æ“ä½œ</h2>
      </div>
      <div class="actions-grid">
        <a href="/api/download/csv" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
          <span data-i18n="action.export">å¯¼å‡º CSV</span>
        </a>
        <button onclick="openEmailSettings()" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
          <span data-i18n="action.email">é‚®ä»¶é€šçŸ¥</span>
        </button>
        <button onclick="handleLogin()" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
          <span data-i18n="action.login">é‡æ–°ç™»å½•</span>
        </button>
        <button onclick="handleClearData()" class="action-btn danger">
          <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          <span data-i18n="action.clear">æ¸…ç©ºæ•°æ®</span>
        </button>
      </div>
    </section>

    <!-- é¡µè„š -->
    <footer class="footer" data-i18n="footer">
      Spotify å®æ—¶åˆ†æ Â· Powered by Claude Code
    </footer>
  </div>

  <!-- é‚®ä»¶è®¾ç½®æ¨¡æ€æ¡† -->
  <div id="email-modal" class="modal-overlay">
    <div class="modal">
      <button class="modal-close" onclick="closeEmailModal()">&times;</button>
      <div class="modal-title">ğŸ“§ é‚®ä»¶é€šçŸ¥è®¾ç½®</div>

      <div id="email-status" class="email-status disabled">åŠ è½½ä¸­...</div>

      <div class="form-group">
        <label class="form-checkbox">
          <input type="checkbox" id="email-enabled">
          <span data-i18n="email.enable">å¯ç”¨é‚®ä»¶é€šçŸ¥</span>
        </label>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">SMTP æœåŠ¡å™¨</label>
          <input type="text" id="email-host" class="form-input" placeholder="smtp.gmail.com">
        </div>
        <div class="form-group">
          <label class="form-label">ç«¯å£</label>
          <input type="number" id="email-port" class="form-input" placeholder="587">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">å‘ä»¶é‚®ç®±</label>
        <input type="email" id="email-user" class="form-input" placeholder="your-email@gmail.com">
      </div>

      <div class="form-group">
        <label class="form-label">é‚®ç®±å¯†ç  / åº”ç”¨ä¸“ç”¨å¯†ç </label>
        <input type="password" id="email-pass" class="form-input" placeholder="ç•™ç©ºåˆ™ä¸æ›´æ”¹">
      </div>

      <div class="form-group">
        <label class="form-label">æ¥æ”¶é€šçŸ¥é‚®ç®±</label>
        <input type="email" id="email-to" class="form-input" placeholder="notifications@example.com">
      </div>

      <div class="form-group">
        <label class="form-checkbox">
          <input type="checkbox" id="email-secure">
          <span>ä½¿ç”¨ SSL/TLS (ç«¯å£465æ—¶å¯ç”¨)</span>
        </label>
      </div>

      <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 12px; margin-bottom: 16px; font-size: 12px; color: var(--text-secondary);">
        <strong>æç¤ºï¼š</strong>Gmail ç”¨æˆ·éœ€è¦ä½¿ç”¨ <a href="https://myaccount.google.com/apppasswords" target="_blank" style="color: var(--spotify-green);">åº”ç”¨ä¸“ç”¨å¯†ç </a>ã€‚ä¿®æ”¹ä»…åœ¨å½“å‰ä¼šè¯æœ‰æ•ˆï¼Œæ°¸ä¹…ä¿®æ”¹è¯·ç¼–è¾‘ .env æ–‡ä»¶ã€‚
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="testEmail()">å‘é€æµ‹è¯•</button>
        <button class="btn btn-secondary" onclick="closeEmailModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveEmailSettings()">ä¿å­˜è®¾ç½®</button>
      </div>
    </div>
  </div>

  <script>
    // ========== å›½é™…åŒ– ==========
    const i18n = {
      zh: {
        'app.title': 'å®æ—¶åˆ†æ',
        'app.subtitle': 'Spotify å¬ä¼—è¿½è¸ªä»ªè¡¨ç›˜',
        'status.live': 'å®æ—¶ç›‘æ§',
        'status.error': 'çŠ¶æ€å¼‚å¸¸',
        'loading': 'åŠ è½½ä¸­...',
        'section.overview': 'æ ¸å¿ƒæ¦‚è§ˆ',
        'section.overviewDesc': 'æœ€é‡è¦çš„å®æ—¶æ•°æ®ä¸€ç›®äº†ç„¶',
        'timezone.utc': '(UTCæ—¶åŒº)',
        'section.charts': 'è¶‹åŠ¿å›¾è¡¨',
        'section.chartsDesc': 'æ•°æ®å¯è§†åŒ–åˆ†æ',
        'section.hourlyStats': 'æ—¶æ®µåˆ†æ',
        'section.hourlyStatsDesc': 'å„æ—¶åŒºé«˜å³°ä½è°·æ—¶æ®µæ´å¯Ÿ',
        'section.analysis': 'æ·±åº¦åˆ†æ',
        'section.analysisDesc': 'ä¸å†å²æ•°æ®å¯¹æ¯”åˆ†æ',
        'section.actions': 'å¿«æ·æ“ä½œ',
        'chart.timeline': 'å¬ä¼—è¶‹åŠ¿',
        'chart.timelineDesc': 'å®æ—¶å¬ä¼—æ•°é‡å˜åŒ– (UTC)',
        'chart.raw': 'åŸå§‹',
        'chart.smooth': 'å¹³æ»‘',
        'time.1h': '1å°æ—¶',
        'time.6h': '6å°æ—¶',
        'time.12h': '12å°æ—¶',
        'time.24h': '24å°æ—¶',
        'time.all': 'å…¨éƒ¨',
        'action.stats': 'ç»Ÿè®¡ API',
        'action.recent': 'æœ€è¿‘æ•°æ®',
        'action.export': 'å¯¼å‡º CSV',
        'action.login': 'é‡æ–°ç™»å½•',
        'action.clear': 'æ¸…ç©ºæ•°æ®',
        'action.email': 'é‚®ä»¶é€šçŸ¥',
        'footer': 'Spotify å®æ—¶åˆ†æ Â· Powered by Claude Code',
        'section.dailyStats': 'æ¯æ—¥æ•°æ®',
        'section.dailyStatsDesc': 'å†å²æ¯æ—¥å¹³å‡ã€å³°å€¼ä¸é¢„æµ‹æ’­æ”¾é‡',
        'daily.date': 'æ—¥æœŸ',
        'daily.avg': 'å¹³å‡å¬ä¼—',
        'daily.peak': 'å³°å€¼',
        'daily.streams': 'é¢„æµ‹æ’­æ”¾',
        'daily.samples': 'é‡‡æ ·æ•°',
        'daily.loadMore': 'åŠ è½½æ›´å¤š',
        'daily.noMore': 'æ²¡æœ‰æ›´å¤šæ•°æ®',
        'daily.noData': 'æš‚æ— æ•°æ®',
        'email.enable': 'å¯ç”¨é‚®ä»¶é€šçŸ¥',
        'email.testSuccess': 'æµ‹è¯•é‚®ä»¶å·²å‘é€',
        'email.testFail': 'å‘é€å¤±è´¥',
        'email.saveSuccess': 'è®¾ç½®å·²ä¿å­˜',
        'date.recentlyUsed': 'æœ€è¿‘ä½¿ç”¨',
        'date.presets': 'æ—¥æœŸèŒƒå›´',
        'date.today': 'ä»Šå¤©',
        'date.yesterday': 'æ˜¨å¤©',
        'date.todayYesterday': 'ä»Šå¤©å’Œæ˜¨å¤©',
        'date.last7days': 'è¿‡å» 7 å¤©',
        'date.last14days': 'è¿‡å» 14 å¤©',
        'date.last28days': 'è¿‡å» 28 å¤©',
        'date.last30days': 'è¿‡å» 30 å¤©',
        'date.thisWeek': 'æœ¬å‘¨',
        'date.lastWeek': 'ä¸Šå‘¨',
        'date.thisMonth': 'æœ¬æœˆ',
        'date.lastMonth': 'ä¸Šæœˆ',
        'date.maximum': 'å…¨éƒ¨æ•°æ®',
        'date.custom': 'è‡ªå®šä¹‰',
        'date.apply': 'åº”ç”¨',
        'hero.current': 'å½“å‰å¬ä¼—',
        'hero.todayAvg': 'ä»Šæ—¥å¹³å‡',
        'hero.prediction': 'é¢„æµ‹æ’­æ”¾é‡',
        'hero.todayPrediction': 'ä»Šæ—¥é¢„æµ‹æ’­æ”¾',
        'hero.peak': 'ä»Šæ—¥å³°å€¼',
        'hero.todayPeak': 'ä»Šæ—¥å³°å€¼',
        'hero.vs1h': 'å¯¹æ¯”1å°æ—¶å‰',
        'hero.predictedStreams': 'é¢„è®¡ä»Šæ—¥æ’­æ”¾',
        'hero.based': 'åŸºäºå¹³å‡å¬ä¼—æ•°ä¼°ç®—',
        'hourly.average': 'å¹³å‡',
        'hourly.vsHistory': 'å¯¹æ¯”å†å²',
        'hourly.peak': 'é«˜å³°',
        'hourly.low': 'ä½è°·',
        'hourly.listeners': 'å¬ä¼—',
        'hourly.noData': 'æš‚æ— æ•°æ®',
        'analysis.yesterday': 'å¯¹æ¯”æ˜¨å¤©',
        'analysis.yesterdayDesc': 'ä¸å‰ä¸€å¤©åŒæ—¶æ®µå¯¹æ¯”',
        'analysis.lastWeek': 'å¯¹æ¯”ä¸Šå‘¨',
        'analysis.lastWeekDesc': 'ä¸7å¤©å‰åŒæ—¶æ®µå¯¹æ¯”',
        'analysis.overall': 'æ•´ä½“ç»Ÿè®¡',
        'analysis.overallDesc': 'å…¨éƒ¨å†å²æ•°æ®æ±‡æ€»',
        'analysis.thisWeek': 'æœ¬å‘¨ç»Ÿè®¡',
        'analysis.thisWeekDesc': 'æœ¬å‘¨(UTC)æ•°æ®æ±‡æ€»',
        'analysis.thisMonth': 'æœ¬æœˆç»Ÿè®¡',
        'analysis.thisMonthDesc': 'æœ¬æœˆ(UTC)æ•°æ®æ±‡æ€»',
        'analysis.currentAvg': 'å½“å‰å¹³å‡',
        'analysis.yesterdayAvg': 'æ˜¨æ—¥å¹³å‡',
        'analysis.lastWeekAvg': 'ä¸Šå‘¨å¹³å‡',
        'analysis.overallAvg': 'æ•´ä½“å¹³å‡',
        'analysis.weekAvg': 'æœ¬å‘¨å¹³å‡',
        'analysis.monthAvg': 'æœ¬æœˆå¹³å‡',
        'analysis.weekPeak': 'æœ¬å‘¨å³°å€¼',
        'analysis.monthPeak': 'æœ¬æœˆå³°å€¼',
        'analysis.overallPeak': 'å†å²å³°å€¼',
        'analysis.overallMin': 'å†å²æœ€ä½',
        'analysis.change': 'å˜åŒ–',
        'listeners': 'å¬ä¼—',
        'na': 'æš‚æ— æ•°æ®'
      },
      en: {
        'app.title': 'Real-Time Analytics',
        'app.subtitle': 'Spotify Listener Tracking Dashboard',
        'status.live': 'Live Monitoring',
        'status.error': 'Error',
        'loading': 'Loading...',
        'section.overview': 'Overview',
        'section.overviewDesc': 'Key metrics at a glance',
        'timezone.utc': '(UTC Timezone)',
        'section.charts': 'Charts',
        'section.chartsDesc': 'Data visualization',
        'section.hourlyStats': 'Time Zone Analysis',
        'section.hourlyStatsDesc': 'Peak and low hours by timezone',
        'section.analysis': 'Deep Analysis',
        'section.analysisDesc': 'Historical data comparison',
        'section.actions': 'Quick Actions',
        'chart.timeline': 'Listener Trends',
        'chart.timelineDesc': 'Real-time listener count changes (UTC)',
        'chart.raw': 'Raw',
        'chart.smooth': 'Smooth',
        'time.1h': '1 Hour',
        'time.6h': '6 Hours',
        'time.12h': '12 Hours',
        'time.24h': '24 Hours',
        'time.all': 'All',
        'action.stats': 'Stats API',
        'action.recent': 'Recent Data',
        'action.export': 'Export CSV',
        'action.login': 'Re-login',
        'action.clear': 'Clear Data',
        'action.email': 'Email Alerts',
        'footer': 'Spotify Real-Time Analytics Â· Powered by Claude Code',
        'section.dailyStats': 'Daily Data',
        'section.dailyStatsDesc': 'Historical daily average, peak, and predicted streams',
        'daily.date': 'Date',
        'daily.avg': 'Avg Listeners',
        'daily.peak': 'Peak',
        'daily.streams': 'Est. Streams',
        'daily.samples': 'Samples',
        'daily.loadMore': 'Load More',
        'daily.noMore': 'No more data',
        'daily.noData': 'No data',
        'email.enable': 'Enable Email Notifications',
        'email.testSuccess': 'Test email sent',
        'email.testFail': 'Send failed',
        'email.saveSuccess': 'Settings saved',
        'date.recentlyUsed': 'Recently Used',
        'date.presets': 'Date Range Presets',
        'date.today': 'Today',
        'date.yesterday': 'Yesterday',
        'date.todayYesterday': 'Today and Yesterday',
        'date.last7days': 'Last 7 days',
        'date.last14days': 'Last 14 days',
        'date.last28days': 'Last 28 days',
        'date.last30days': 'Last 30 days',
        'date.thisWeek': 'This week',
        'date.lastWeek': 'Last week',
        'date.thisMonth': 'This month',
        'date.lastMonth': 'Last month',
        'date.maximum': 'Maximum',
        'date.custom': 'Custom',
        'date.apply': 'Apply',
        'hero.current': 'Current Listeners',
        'hero.todayAvg': 'Today Average',
        'hero.prediction': 'Predicted Streams',
        'hero.todayPrediction': 'Today Predicted Streams',
        'hero.peak': 'Peak',
        'hero.todayPeak': 'Today Peak',
        'hero.vs1h': 'vs 1 hour ago',
        'hero.predictedStreams': 'Predicted Daily Streams',
        'hero.based': 'Based on average listener count',
        'hourly.average': 'Average',
        'hourly.vsHistory': 'vs History',
        'hourly.peak': 'Peak',
        'hourly.low': 'Low',
        'hourly.listeners': 'listeners',
        'hourly.noData': 'No data',
        'analysis.yesterday': 'vs Yesterday',
        'analysis.yesterdayDesc': 'Comparison with previous day',
        'analysis.lastWeek': 'vs Last Week',
        'analysis.lastWeekDesc': 'Comparison with 7 days ago',
        'analysis.overall': 'Overall Stats',
        'analysis.overallDesc': 'All historical data summary',
        'analysis.thisWeek': 'This Week',
        'analysis.thisWeekDesc': 'This week (UTC) data summary',
        'analysis.thisMonth': 'This Month',
        'analysis.thisMonthDesc': 'This month (UTC) data summary',
        'analysis.currentAvg': 'Current Average',
        'analysis.yesterdayAvg': 'Yesterday Average',
        'analysis.lastWeekAvg': 'Last Week Average',
        'analysis.overallAvg': 'Overall Average',
        'analysis.weekAvg': 'Week Average',
        'analysis.monthAvg': 'Month Average',
        'analysis.weekPeak': 'Week Peak',
        'analysis.monthPeak': 'Month Peak',
        'analysis.overallPeak': 'All-time Peak',
        'analysis.overallMin': 'All-time Low',
        'analysis.change': 'Change',
        'listeners': 'listeners',
        'na': 'N/A'
      }
    };

    let currentLang = 'zh';

    function t(key) {
      return i18n[currentLang][key] || key;
    }

    function updateLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      refresh();
      // åˆ‡æ¢è¯­è¨€æ—¶é‡æ–°åŠ è½½æ¯æ—¥æ•°æ®è¡¨æ ¼ä»¥æ›´æ–°ç¿»è¯‘
      dailyDataOffset = 0;
      dailyDataHasMore = true;
      loadDailyData();
    }

    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        updateLanguage(btn.dataset.lang);
      });
    });

    // ========== æ•°æ®å’Œå›¾è¡¨ ==========
    let mainChart;
    let currentDateRange = 'today'; // å½“å‰é€‰ä¸­çš„æ—¥æœŸèŒƒå›´
    let customStartDate = null;
    let customEndDate = null;
    let chartType = 'raw'; // 'raw' æˆ– 'smooth'
    let allData = [];
    let processedData = []; // å›¾è¡¨ä½¿ç”¨çš„å¤„ç†åæ•°æ®
    let recentlyUsedRanges = []; // æœ€è¿‘ä½¿ç”¨çš„èŒƒå›´

    // åˆå§‹åŒ–æœ€è¿‘ä½¿ç”¨çš„èŒƒå›´
    try {
      recentlyUsedRanges = JSON.parse(localStorage.getItem('recentDateRanges') || '[]');
    } catch (e) {
      recentlyUsedRanges = [];
    }

    // æ—¥æœŸèŒƒå›´é…ç½®
    const dateRangeConfig = {
      today: { labelKey: 'date.today', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));
        return { start, end: now };
      }},
      yesterday: { labelKey: 'date.yesterday', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 1, 0, 0, 0));
        const end = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));
        return { start, end };
      }},
      todayYesterday: { labelKey: 'date.todayYesterday', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 1, 0, 0, 0));
        return { start, end: now };
      }},
      last7days: { labelKey: 'date.last7days', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 6, 0, 0, 0));
        return { start, end: now };
      }},
      last14days: { labelKey: 'date.last14days', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 13, 0, 0, 0));
        return { start, end: now };
      }},
      last28days: { labelKey: 'date.last28days', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 27, 0, 0, 0));
        return { start, end: now };
      }},
      last30days: { labelKey: 'date.last30days', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 29, 0, 0, 0));
        return { start, end: now };
      }},
      thisWeek: { labelKey: 'date.thisWeek', getDates: () => {
        const now = new Date();
        const dayOfWeek = now.getUTCDay();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - dayOfWeek, 0, 0, 0));
        return { start, end: now };
      }},
      lastWeek: { labelKey: 'date.lastWeek', getDates: () => {
        const now = new Date();
        const dayOfWeek = now.getUTCDay();
        const thisWeekStart = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - dayOfWeek, 0, 0, 0));
        const start = new Date(thisWeekStart.getTime() - 7 * 24 * 60 * 60 * 1000);
        const end = new Date(thisWeekStart.getTime());
        return { start, end };
      }},
      thisMonth: { labelKey: 'date.thisMonth', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1, 0, 0, 0));
        return { start, end: now };
      }},
      lastMonth: { labelKey: 'date.lastMonth', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() - 1, 1, 0, 0, 0));
        const end = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1, 0, 0, 0));
        return { start, end };
      }},
      maximum: { labelKey: 'date.maximum', getDates: () => {
        return { start: null, end: null }; // null è¡¨ç¤ºè·å–å…¨éƒ¨æ•°æ®
      }}
    };

    // åˆ‡æ¢æ—¥æœŸé€‰æ‹©å™¨ä¸‹æ‹‰æ¡†
    function toggleDatePicker() {
      const dropdown = document.getElementById('date-picker-dropdown');
      const trigger = document.getElementById('date-picker-trigger');
      dropdown.classList.toggle('open');
      trigger.classList.toggle('open');
      updateRecentlyUsedSection();
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
    document.addEventListener('click', (e) => {
      const container = document.querySelector('.date-picker-container');
      if (container && !container.contains(e.target)) {
        document.getElementById('date-picker-dropdown').classList.remove('open');
        document.getElementById('date-picker-trigger').classList.remove('open');
      }
    });

    // æ›´æ–°æœ€è¿‘ä½¿ç”¨åŒºåŸŸ
    function updateRecentlyUsedSection() {
      const section = document.getElementById('recent-used-section');
      const optionsContainer = document.getElementById('recent-used-options');

      if (recentlyUsedRanges.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      optionsContainer.innerHTML = recentlyUsedRanges.slice(0, 3).map(range => {
        const config = dateRangeConfig[range];
        if (!config) return '';
        const isActive = currentDateRange === range ? 'active' : '';
        return `
          <div class="date-picker-option ${isActive}" data-range="${range}" onclick="selectDateRange('${range}')">
            <span>${t(config.labelKey)}</span>
            <span class="check">âœ“</span>
          </div>
        `;
      }).join('');
    }

    // é€‰æ‹©æ—¥æœŸèŒƒå›´
    function selectDateRange(range) {
      currentDateRange = range;

      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.date-picker-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.range === range);
      });

      // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
      const config = dateRangeConfig[range];
      if (config) {
        document.getElementById('date-picker-label').textContent = t(config.labelKey);
      }

      // éšè—è‡ªå®šä¹‰æ—¥æœŸè¾“å…¥
      document.getElementById('custom-date-inputs').classList.remove('show');

      // æ·»åŠ åˆ°æœ€è¿‘ä½¿ç”¨
      if (range !== 'custom') {
        addToRecentlyUsed(range);
      }

      // å…³é—­ä¸‹æ‹‰æ¡†å¹¶åŠ è½½å›¾è¡¨
      document.getElementById('date-picker-dropdown').classList.remove('open');
      document.getElementById('date-picker-trigger').classList.remove('open');
      loadMainChart();
    }

    // æ·»åŠ åˆ°æœ€è¿‘ä½¿ç”¨
    function addToRecentlyUsed(range) {
      recentlyUsedRanges = recentlyUsedRanges.filter(r => r !== range);
      recentlyUsedRanges.unshift(range);
      recentlyUsedRanges = recentlyUsedRanges.slice(0, 5);
      try {
        localStorage.setItem('recentDateRanges', JSON.stringify(recentlyUsedRanges));
      } catch (e) {}
    }

    // åˆ‡æ¢è‡ªå®šä¹‰æ—¥æœŸè¾“å…¥
    function toggleCustomDate() {
      const inputs = document.getElementById('custom-date-inputs');
      inputs.classList.toggle('show');

      // è®¾ç½®é»˜è®¤æ—¥æœŸ
      const now = new Date();
      const startInput = document.getElementById('custom-start-date');
      const endInput = document.getElementById('custom-end-date');

      if (!startInput.value) {
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        startInput.value = weekAgo.toISOString().split('T')[0];
      }
      if (!endInput.value) {
        endInput.value = now.toISOString().split('T')[0];
      }
    }

    // åº”ç”¨è‡ªå®šä¹‰æ—¥æœŸ
    function applyCustomDate() {
      const startInput = document.getElementById('custom-start-date');
      const endInput = document.getElementById('custom-end-date');

      if (!startInput.value || !endInput.value) {
        alert(currentLang === 'zh' ? 'è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ' : 'Please select start and end dates');
        return;
      }

      customStartDate = new Date(startInput.value + 'T00:00:00Z');
      customEndDate = new Date(endInput.value + 'T23:59:59Z');

      if (customStartDate > customEndDate) {
        alert(currentLang === 'zh' ? 'å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ' : 'Start date cannot be after end date');
        return;
      }

      currentDateRange = 'custom';

      // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
      const label = `${startInput.value} - ${endInput.value}`;
      document.getElementById('date-picker-label').textContent = label;

      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.date-picker-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.range === 'custom');
      });

      // å…³é—­ä¸‹æ‹‰æ¡†å¹¶åŠ è½½å›¾è¡¨
      document.getElementById('date-picker-dropdown').classList.remove('open');
      document.getElementById('date-picker-trigger').classList.remove('open');
      loadMainChart();
    }

    document.querySelectorAll('.chart-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        chartType = btn.dataset.type;
        loadMainChart();
      });
    });

    // åŠ è½½æ•°æ®æ¦‚è§ˆï¼ˆæ•´åˆæ‰€æœ‰æ•°æ®å±•ç¤ºï¼Œç‹¬ç«‹è·å–æ•°æ®ï¼‰
    async function loadHeroSection() {
      try {
        // è·å–ç»Ÿè®¡æ•°æ®å’Œè¶³å¤Ÿå¤šçš„å†å²æ•°æ®
        const [statsRes, heroDataRes] = await Promise.all([
          fetch('/api/stats'),
          fetch('/api/data?limit=250000')
        ]);

        const stats = await statsRes.json();
        const heroData = await heroDataRes.json();

        if (!stats || stats.totalRecords === 0) {
          document.getElementById('hero-content').innerHTML = `<div class="loading">${t('na')}</div>`;
          return;
        }

        const current = stats.latestCount;
        const nowUTC = new Date();

        // === ä»Šæ—¥æ•°æ® (UTC) ===
        const todayStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate(), 0, 0, 0, 0));
        const todayData = heroData.filter(d => new Date(d.timestamp) >= todayStartUTC);
        const todayValues = todayData.map(d => d.listenerCount);
        const todayAvg = todayValues.length > 0 ? todayValues.reduce((a, b) => a + b, 0) / todayValues.length : current;
        const todayPeak = todayValues.length > 0 ? Math.max(...todayValues) : current;

        // ä»Šæ—¥é¢„æµ‹æ’­æ”¾é‡
        const hoursElapsedUTC = (nowUTC - todayStartUTC) / (1000 * 60 * 60);
        const predictedStreams = hoursElapsedUTC > 0 ? Math.round((todayAvg * 24 * 60) / 3) : 0;

        // å¯¹æ¯”1å°æ—¶å‰
        const data1h = heroData.slice(-720);
        const avg1h = data1h.length > 0 ? data1h.reduce((s, d) => s + d.listenerCount, 0) / data1h.length : 0;
        const trend1h = avg1h > 0 ? ((current - avg1h) / avg1h * 100).toFixed(1) : 0;
        const isUp = parseFloat(trend1h) > 0;

        // === è¿‡å»7å¤©æ•°æ® (UTC) ===
        const weekStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 6, 0, 0, 0));
        const thisWeekData = heroData.filter(d => new Date(d.timestamp) >= weekStartUTC);
        const thisWeekValues = thisWeekData.map(d => d.listenerCount);
        const thisWeekAvg = thisWeekValues.length > 0 ? thisWeekValues.reduce((a, b) => a + b, 0) / thisWeekValues.length : null;
        const thisWeekPeak = thisWeekValues.length > 0 ? Math.max(...thisWeekValues) : null;

        // === è¿‘30å¤©æ•°æ® (UTC) ===
        const monthStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 29, 0, 0, 0));
        const thisMonthData = heroData.filter(d => new Date(d.timestamp) >= monthStartUTC);
        const thisMonthValues = thisMonthData.map(d => d.listenerCount);
        const thisMonthAvg = thisMonthValues.length > 0 ? thisMonthValues.reduce((a, b) => a + b, 0) / thisMonthValues.length : null;
        const thisMonthPeak = thisMonthValues.length > 0 ? Math.max(...thisMonthValues) : null;

        // === å…¨éƒ¨æ•°æ® ===
        const allValues = heroData.map(d => d.listenerCount);
        const overallAvg = allValues.reduce((a, b) => a + b, 0) / allValues.length;
        const overallPeak = Math.max(...allValues);

        // === è®¡ç®—å„æ—¶æœŸé¢„æµ‹æ¯æ—¥æ’­æ”¾é‡ ===
        // å…¬å¼: å¹³å‡å¬ä¼— * 24å°æ—¶ * 60åˆ†é’Ÿ / 3åˆ†é’Ÿ(æ¯é¦–æ­Œ) = æ¯æ—¥æ’­æ”¾
        const calcDailyStreams = (avg) => avg ? Math.round((avg * 24 * 60) / 3) : null;
        const thisWeekDailyStreams = calcDailyStreams(thisWeekAvg);
        const thisMonthDailyStreams = calcDailyStreams(thisMonthAvg);
        const overallDailyStreams = calcDailyStreams(overallAvg);

        // === æ˜¨å¤©æ•°æ® (ç”¨äºå¯¹æ¯”) ===
        const yesterdayStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 1, 0, 0, 0, 0));
        const yesterdayData = heroData.filter(d => {
          const ts = new Date(d.timestamp);
          return ts >= yesterdayStartUTC && ts < todayStartUTC;
        });
        const yesterdayValues = yesterdayData.map(d => d.listenerCount);
        const yesterdayAvg = yesterdayValues.length > 0 ? yesterdayValues.reduce((a, b) => a + b, 0) / yesterdayValues.length : null;
        const yesterdayPeak = yesterdayValues.length > 0 ? Math.max(...yesterdayValues) : null;
        const yesterdayDailyStreams = calcDailyStreams(yesterdayAvg);

        // === 7-14å¤©å‰æ•°æ® (ç”¨äºå¯¹æ¯”) ===
        const lastWeekStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 13, 0, 0, 0));
        const lastWeekEndUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 6, 0, 0, 0));
        const lastWeekData = heroData.filter(d => {
          const ts = new Date(d.timestamp);
          return ts >= lastWeekStartUTC && ts < lastWeekEndUTC;
        });
        const lastWeekValues = lastWeekData.map(d => d.listenerCount);
        const lastWeekAvg = lastWeekValues.length > 0 ? lastWeekValues.reduce((a, b) => a + b, 0) / lastWeekValues.length : null;
        const lastWeekPeak = lastWeekValues.length > 0 ? Math.max(...lastWeekValues) : null;
        const lastWeekDailyStreams = calcDailyStreams(lastWeekAvg);

        // === ä¸Šæœˆæ•°æ® (ç”¨äºå¯¹æ¯”) ===
        const lastMonthStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth() - 1, 1));
        const lastMonthData = heroData.filter(d => {
          const ts = new Date(d.timestamp);
          return ts >= lastMonthStartUTC && ts < monthStartUTC;
        });
        const lastMonthValues = lastMonthData.map(d => d.listenerCount);
        const lastMonthAvg = lastMonthValues.length > 0 ? lastMonthValues.reduce((a, b) => a + b, 0) / lastMonthValues.length : null;
        const lastMonthPeak = lastMonthValues.length > 0 ? Math.max(...lastMonthValues) : null;
        const lastMonthDailyStreams = calcDailyStreams(lastMonthAvg);

        // === è®¡ç®—å˜åŒ–ç™¾åˆ†æ¯” ===
        const calcChange = (current, previous) => {
          if (!current || !previous) return null;
          return ((current - previous) / previous * 100).toFixed(1);
        };

        const formatChange = (change) => {
          if (change === null) return '';
          const num = parseFloat(change);
          const arrow = num >= 0 ? 'â†—' : 'â†˜';
          const cls = num >= 0 ? 'up' : 'down';
          return `<span class="metric-change ${cls}">${arrow}${Math.abs(num)}%</span>`;
        };


        // UTCæ—¥æœŸæ ¼å¼åŒ–
        const utcDateStr = nowUTC.toISOString().split('T')[0];
        const yesterdayDateStr = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 1)).toISOString().split('T')[0];

        // æ¸²æŸ“å®Œæ•´çš„æ•°æ®æ¦‚è§ˆ
        document.getElementById('hero-content').innerHTML = `
          <!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
          <div class="hero-main">
            <!-- å½“å‰å¬ä¼— (ç®€åŒ–ç‰ˆ - åªæ˜¾ç¤ºå½“å‰æ•°å€¼) -->
            <div class="current-card">
              <div class="metric-label">${t('hero.current')}</div>
              <div class="metric-value">${current.toLocaleString()}</div>
              <div class="metric-subtitle">${currentLang === 'zh' ? 'å®æ—¶åœ¨çº¿' : 'Listening Now'}</div>
            </div>

            <!-- ä»Šæ—¥å¹³å‡ -->
            <div class="metric-card">
              <div class="metric-label">${currentLang === 'zh' ? 'ä»Šæ—¥å¹³å‡' : 'Today Avg'} <span style="opacity:0.5;font-size:10px;">UTC ${utcDateStr}</span></div>
              <div class="metric-value">${todayAvg.toFixed(1)}</div>
              <div class="metric-compare">
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? 'æ˜¨æ—¥å¹³å‡' : 'Yesterday Avg'}</span>
                  <span class="metric-compare-value">${yesterdayAvg ? yesterdayAvg.toFixed(1) : '-'} ${formatChange(calcChange(todayAvg, yesterdayAvg))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? 'è¿‘7å¤©' : '7 Days'}</span>
                  <span class="metric-compare-value">${thisWeekAvg ? thisWeekAvg.toFixed(1) : '-'} ${formatChange(calcChange(todayAvg, thisWeekAvg))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? 'è¿‘30å¤©' : '30 Days'}</span>
                  <span class="metric-compare-value">${thisMonthAvg ? thisMonthAvg.toFixed(1) : '-'} ${formatChange(calcChange(todayAvg, thisMonthAvg))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? 'å†å²å¹³å‡' : 'All-time Avg'}</span>
                  <span class="metric-compare-value">${overallAvg.toFixed(1)} ${formatChange(calcChange(todayAvg, overallAvg))}</span>
                </div>
              </div>
            </div>

            <!-- ä»Šæ—¥å³°å€¼ -->
            <div class="metric-card">
              <div class="metric-label">${currentLang === 'zh' ? 'ä»Šæ—¥å³°å€¼' : 'Today Peak'} <span style="opacity:0.5;font-size:10px;">UTC</span></div>
              <div class="metric-value">${todayPeak.toLocaleString()}</div>
              <div class="metric-compare">
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? 'æ˜¨æ—¥å³°å€¼' : 'Yesterday Peak'}</span>
                  <span class="metric-compare-value">${yesterdayPeak ? yesterdayPeak.toLocaleString() : '-'} ${formatChange(calcChange(todayPeak, yesterdayPeak))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? 'è¿‘7å¤©å³°å€¼' : '7 Days Peak'}</span>
                  <span class="metric-compare-value">${thisWeekPeak ? thisWeekPeak.toLocaleString() : '-'} ${formatChange(calcChange(todayPeak, thisWeekPeak))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? 'è¿‘30å¤©å³°å€¼' : '30 Days Peak'}</span>
                  <span class="metric-compare-value">${thisMonthPeak ? thisMonthPeak.toLocaleString() : '-'} ${formatChange(calcChange(todayPeak, thisMonthPeak))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? 'å†å²å³°å€¼' : 'All-time Peak'}</span>
                  <span class="metric-compare-value">${overallPeak.toLocaleString()} ${formatChange(calcChange(todayPeak, overallPeak))}</span>
                </div>
              </div>
            </div>

            <!-- ä»Šæ—¥é¢„æµ‹æ’­æ”¾ -->
            <div class="metric-card">
              <div class="metric-label">${currentLang === 'zh' ? 'ä»Šæ—¥é¢„æµ‹æ’­æ”¾' : 'Est. Daily Streams'} <span style="opacity:0.5;font-size:10px;">UTC</span></div>
              <div class="metric-value">${predictedStreams.toLocaleString()}</div>
              <div class="metric-compare">
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? 'æ˜¨æ—¥é¢„æµ‹' : 'Yesterday'}</span>
                  <span class="metric-compare-value">${yesterdayDailyStreams ? yesterdayDailyStreams.toLocaleString() : '-'} ${formatChange(calcChange(predictedStreams, yesterdayDailyStreams))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? 'è¿‘7å¤©' : '7 Days'}</span>
                  <span class="metric-compare-value">${thisWeekDailyStreams ? thisWeekDailyStreams.toLocaleString() : '-'} ${formatChange(calcChange(predictedStreams, thisWeekDailyStreams))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? 'è¿‘30å¤©' : '30 Days'}</span>
                  <span class="metric-compare-value">${thisMonthDailyStreams ? thisMonthDailyStreams.toLocaleString() : '-'} ${formatChange(calcChange(predictedStreams, thisMonthDailyStreams))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? 'å†å²é¢„æµ‹' : 'All-time Avg'}</span>
                  <span class="metric-compare-value">${overallDailyStreams.toLocaleString()} ${formatChange(calcChange(predictedStreams, overallDailyStreams))}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      } catch (e) {
        console.error('Failed to load hero section:', e);
      }
    }

    // è®¡ç®—ç§»åŠ¨å¹³å‡è¶‹åŠ¿çº¿
    function calculateTrendLine(values) {
      const n = values.length;
      if (n < 2) return values;

      // åŠ¨æ€è®¡ç®—çª—å£å¤§å°ï¼šæ•°æ®ç‚¹çš„10%ï¼Œæœ€å°5ï¼Œæœ€å¤§50
      const windowSize = Math.max(5, Math.min(50, Math.floor(n * 0.1)));
      const result = [];

      for (let i = 0; i < n; i++) {
        // è®¡ç®—ä»¥å½“å‰ç‚¹ä¸ºä¸­å¿ƒçš„çª—å£èŒƒå›´
        const halfWindow = Math.floor(windowSize / 2);
        const start = Math.max(0, i - halfWindow);
        const end = Math.min(n, i + halfWindow + 1);

        // è®¡ç®—çª—å£å†…çš„å¹³å‡å€¼
        let sum = 0;
        for (let j = start; j < end; j++) {
          sum += values[j];
        }
        result.push(sum / (end - start));
      }

      return result;
    }

    // åŠ è½½ä¸»å›¾è¡¨
    async function loadMainChart() {
      try {
        // è·å–æ—¥æœŸèŒƒå›´
        let startDate = null;
        let endDate = null;

        if (currentDateRange === 'custom') {
          startDate = customStartDate;
          endDate = customEndDate;
        } else {
          const config = dateRangeConfig[currentDateRange];
          if (config) {
            const dates = config.getDates();
            startDate = dates.start;
            endDate = dates.end;
          }
        }

        // è·å–æ•°æ®ï¼ˆè·å–è¶³å¤Ÿå¤šçš„æ•°æ®ç”¨äºè¿‡æ»¤ï¼‰
        const res = await fetch('/api/data?limit=250000');
        let rawData = await res.json();

        if (rawData.length === 0) return;

        // æ ¹æ®æ—¥æœŸèŒƒå›´è¿‡æ»¤æ•°æ®
        if (startDate || endDate) {
          allData = rawData.filter(d => {
            const ts = new Date(d.timestamp);
            if (startDate && ts < startDate) return false;
            if (endDate && ts > endDate) return false;
            return true;
          });
        } else {
          allData = rawData;
        }

        if (allData.length === 0) {
          // æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºå›¾è¡¨
          if (mainChart) {
            mainChart.data.labels = [];
            mainChart.data.datasets[0].data = [];
            mainChart.update('none');
          }
          document.getElementById('chart-subtitle').textContent = currentLang === 'zh' ? 'é€‰å®šèŒƒå›´å†…æ— æ•°æ®' : 'No data in selected range';
          return;
        }

        processedData = allData;

        // å¹³æ»‘æ¨¡å¼æˆ–å¤§æ•°æ®é‡ï¼šæ•°æ®èšåˆ
        const needsAggregation = chartType === 'smooth' || allData.length > 1000;

        if (needsAggregation) {
          // æ ¹æ®æ•°æ®é‡åŠ¨æ€è®¡ç®—èšåˆå¤§å°ï¼Œä¿æŒçº¦500ä¸ªç‚¹
          const aggregateSize = Math.max(1, Math.floor(allData.length / 500));

          processedData = [];
          for (let i = 0; i < allData.length; i += aggregateSize) {
            const chunk = allData.slice(i, i + aggregateSize);
            const avgCount = chunk.reduce((sum, d) => sum + d.listenerCount, 0) / chunk.length;
            processedData.push({
              timestamp: chunk[Math.floor(chunk.length / 2)].timestamp,
              listenerCount: chartType === 'smooth' ? avgCount : Math.round(avgCount)
            });
          }
        }

        // åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºæ—¥æœŸï¼ˆè·¨å¤©æ•°æ®ï¼‰
        const firstDate = new Date(processedData[0].timestamp);
        const lastDate = new Date(processedData[processedData.length - 1].timestamp);
        const daysDiff = (lastDate - firstDate) / (1000 * 60 * 60 * 24);
        const showDate = daysDiff >= 1;

        // ä½¿ç”¨UTCæ—¶é—´æ ¼å¼åŒ–xè½´æ ‡ç­¾
        const labels = processedData.map(d => {
          const date = new Date(d.timestamp);
          const hours = String(date.getUTCHours()).padStart(2, '0');
          const minutes = String(date.getUTCMinutes()).padStart(2, '0');

          if (showDate) {
            // é•¿æ—¶é—´èŒƒå›´ï¼šæ˜¾ç¤ºæ—¥æœŸ+æ—¶é—´
            const month = date.getUTCMonth() + 1;
            const day = date.getUTCDate();
            return `${month}/${day} ${hours}:${minutes}`;
          } else {
            // çŸ­æ—¶é—´èŒƒå›´ï¼šåªæ˜¾ç¤ºæ—¶é—´
            return `${hours}:${minutes}`;
          }
        });
        const values = processedData.map(d => d.listenerCount);

        // å¹³æ»‘æ¨¡å¼ä¸‹è®¡ç®—è¶‹åŠ¿çº¿
        const trendLineData = chartType === 'smooth' ? calculateTrendLine(values) : null;

        const ctx = document.getElementById('main-chart').getContext('2d');

        const datasets = [{
          label: currentLang === 'zh' ? 'å¬ä¼—æ•°' : 'Listeners',
          data: values,
          borderColor: '#1DB954',
          borderWidth: 3,
          backgroundColor: (context) => {
            const ctx = context.chart.ctx;
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(29, 185, 84, 0.4)');
            gradient.addColorStop(1, 'rgba(29, 185, 84, 0)');
            return gradient;
          },
          fill: true,
          tension: chartType === 'smooth' ? 0.4 : 0.1,
          pointRadius: 0,
          pointHoverRadius: 8,
          pointHoverBackgroundColor: '#1DB954',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 3
        }];

        // å¹³æ»‘æ¨¡å¼ä¸‹æ·»åŠ ç§»åŠ¨å¹³å‡è¶‹åŠ¿çº¿
        if (chartType === 'smooth' && trendLineData) {
          datasets.push({
            label: currentLang === 'zh' ? 'ç§»åŠ¨å¹³å‡' : 'Moving Avg',
            data: trendLineData,
            borderColor: 'rgba(255, 165, 0, 0.9)',
            borderWidth: 2.5,
            backgroundColor: 'transparent',
            fill: false,
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 4,
            pointHoverBackgroundColor: 'rgba(255, 165, 0, 1)'
          });
        }

        if (!mainChart) {
          mainChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { intersect: false, mode: 'index' },
              plugins: {
                legend: {
                  display: chartType === 'smooth',
                  position: 'top',
                  align: 'end',
                  labels: {
                    color: 'rgba(255, 255, 255, 0.7)',
                    usePointStyle: true,
                    pointStyle: 'line',
                    font: { size: 12 }
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.9)',
                  titleColor: '#1DB954',
                  bodyColor: '#fff',
                  titleFont: { size: 16, weight: '700' },
                  bodyFont: { size: 13, weight: '500' },
                  padding: 12,
                  displayColors: true,
                  callbacks: {
                    title: (items) => {
                      if (!items.length) return '';
                      const mainItem = items.find(i => i.datasetIndex === 0);
                      if (!mainItem) return '';
                      return mainItem.parsed.y.toLocaleString() + ' ' + t('listeners');
                    },
                    label: (ctx) => {
                      if (ctx.datasetIndex === 1) {
                        return (currentLang === 'zh' ? 'ç§»åŠ¨å¹³å‡: ' : 'Moving Avg: ') + ctx.parsed.y.toFixed(1);
                      }
                      const idx = ctx.dataIndex;
                      const dataPoint = processedData[idx];
                      if (!dataPoint) return '';

                      const date = new Date(dataPoint.timestamp);
                      const timeStr = date.toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'UTC'
                      });
                      return timeStr + ' UTC';
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  grid: { color: 'rgba(255, 255, 255, 0.05)' },
                  ticks: {
                    color: 'rgba(255, 255, 255, 0.5)',
                    callback: function(value) {
                      return Number.isInteger(value) ? value : '';
                    }
                  }
                },
                x: {
                  grid: { display: false },
                  ticks: { color: 'rgba(255, 255, 255, 0.5)', maxTicksLimit: 12 }
                }
              }
            }
          });
        } else {
          mainChart.data.labels = labels;
          mainChart.data.datasets = datasets;
          mainChart.options.plugins.legend.display = chartType === 'smooth';
          mainChart.update('none');
        }

        // æ›´æ–°å›¾è¡¨å‰¯æ ‡é¢˜æ˜¾ç¤ºæ•°æ®ç‚¹æ•°é‡
        const subtitle = document.getElementById('chart-subtitle');
        if (subtitle) {
          const pointCount = processedData.length;
          const config = dateRangeConfig[currentDateRange];
          let rangeText;
          if (currentDateRange === 'custom') {
            rangeText = document.getElementById('date-picker-label').textContent;
          } else if (config) {
            rangeText = t(config.labelKey);
          } else {
            rangeText = currentLang === 'zh' ? 'å…¨éƒ¨æ•°æ®' : 'All data';
          }
          const modeText = chartType === 'smooth' ? (currentLang === 'zh' ? 'å¹³æ»‘' : 'Smooth') : (currentLang === 'zh' ? 'åŸå§‹' : 'Raw');
          subtitle.textContent = `${rangeText} Â· ${pointCount.toLocaleString()} ${currentLang === 'zh' ? 'æ•°æ®ç‚¹' : 'points'} Â· ${modeText} (UTC)`;
        }
      } catch (e) {
        console.error('Failed to load main chart:', e);
      }
    }

    // åŠ è½½æ—¶æ®µæ’è¡Œ
    async function loadHourlyRanking() {
      try {
        const res = await fetch('/api/analytics/hourly');
        const hourlyData = await res.json();

        if (!hourlyData || hourlyData.length === 0) {
          document.getElementById('hourly-ranking').innerHTML = `<div class="loading">${t('hourly.noData')}</div>`;
          return;
        }

        // æŒ‰å¹³å‡å€¼æ’åºï¼ˆé™åºï¼‰- APIè¿”å›çš„å­—æ®µæ˜¯avgCount
        const sorted = [...hourlyData].sort((a, b) => b.avgCount - a.avgCount);
        const maxAvg = sorted[0].avgCount;

        // UTCæ—¶åŒºå¯¹åº”çš„å„å›½æœ¬åœ°æ—¶é—´
        const getRegionalTimes = (utcHour) => {
          const regions = [];
          // ç¾è¥¿ (UTC-8)
          const usWest = (utcHour - 8 + 24) % 24;
          // ç¾ä¸œ (UTC-5)
          const usEast = (utcHour - 5 + 24) % 24;
          // è‹±å›½ (UTC+0)
          const uk = utcHour;
          // æ¾³å¤§åˆ©äºšæ‚‰å°¼ (UTC+11)
          const australia = (utcHour + 11) % 24;
          // æ—¥æœ¬ (UTC+9)
          const japan = (utcHour + 9) % 24;

          const formatTime = (hour) => {
            if (hour >= 6 && hour < 12) return currentLang === 'zh' ? 'ä¸Šåˆ' : 'Morning';
            if (hour >= 12 && hour < 18) return currentLang === 'zh' ? 'ä¸‹åˆ' : 'Afternoon';
            if (hour >= 18 && hour < 22) return currentLang === 'zh' ? 'æ™šé—´' : 'Evening';
            return currentLang === 'zh' ? 'æ·±å¤œ' : 'Night';
          };

          regions.push({ flag: 'ğŸ‡ºğŸ‡¸', name: currentLang === 'zh' ? 'ç¾è¥¿' : 'US-W', hour: usWest, period: formatTime(usWest) });
          regions.push({ flag: 'ğŸ‡ºğŸ‡¸', name: currentLang === 'zh' ? 'ç¾ä¸œ' : 'US-E', hour: usEast, period: formatTime(usEast) });
          regions.push({ flag: 'ğŸ‡¬ğŸ‡§', name: currentLang === 'zh' ? 'è‹±å›½' : 'UK', hour: uk, period: formatTime(uk) });
          regions.push({ flag: 'ğŸ‡¦ğŸ‡º', name: currentLang === 'zh' ? 'æ¾³æ´²' : 'AU', hour: australia, period: formatTime(australia) });
          regions.push({ flag: 'ğŸ‡¯ğŸ‡µ', name: currentLang === 'zh' ? 'æ—¥æœ¬' : 'JP', hour: japan, period: formatTime(japan) });

          return regions;
        };

        const rows = sorted.map((h, idx) => {
          const barWidth = (h.avgCount / maxAvg * 100).toFixed(1);
          const regions = getRegionalTimes(h.hour);
          const isTop3 = idx < 3;
          const isBottom3 = idx >= sorted.length - 3;

          return `
            <div class="hourly-row">
              <div class="hourly-rank ${isTop3 ? 'top3' : ''}">#${idx + 1}</div>
              <div class="hourly-time">
                ${String(h.hour).padStart(2, '0')}:00 UTC
                ${isTop3 ? `<span class="insight-tag">${t('hourly.peak')}</span>` : ''}
                ${isBottom3 ? `<span class="insight-tag low">${t('hourly.low')}</span>` : ''}
              </div>
              <div class="hourly-regions">
                ${regions.map(r => `<span class="hourly-region">${r.flag} ${r.name} ${r.hour}:00 ${r.period}</span>`).join('')}
              </div>
              <div class="hourly-avg">
                ${h.avgCount.toLocaleString()}
                <div class="hourly-bar-container">
                  <div class="hourly-bar" style="width: ${barWidth}%"></div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('hourly-ranking').innerHTML = `
          <div class="hourly-table">
            <div class="hourly-row header">
              <div>${currentLang === 'zh' ? 'æ’å' : 'Rank'}</div>
              <div>${currentLang === 'zh' ? 'UTCæ—¶é—´' : 'UTC Time'}</div>
              <div>${currentLang === 'zh' ? 'å„åœ°æ—¶é—´' : 'Local Times'}</div>
              <div>${currentLang === 'zh' ? 'å¹³å‡å¬ä¼—' : 'Avg Listeners'}</div>
            </div>
            ${rows}
          </div>
        `;
      } catch (e) {
        console.error('Failed to load hourly ranking:', e);
        document.getElementById('hourly-ranking').innerHTML = `<div class="loading">${t('hourly.noData')}</div>`;
      }
    }

    // æ£€æŸ¥çŠ¶æ€
    async function checkStatus() {
      try {
        const res = await fetch('/api/status');
        const status = await res.json();

        const badge = document.getElementById('status-badge');
        const alertDiv = document.getElementById('error-alert');

        if (status.errorMessage) {
          badge.innerHTML = `<span class="status-dot" style="background: #ef4444;"></span><span>${t('status.error')}</span>`;
          alertDiv.style.display = 'flex';
          alertDiv.className = 'alert';
          alertDiv.innerHTML = `
            <div class="alert-icon">ğŸš¨</div>
            <div class="alert-content">
              <div class="alert-title">${status.errorMessage}</div>
              <div class="alert-message">Last success: ${status.lastSuccess ? new Date(status.lastSuccess).toLocaleString() : 'Never'}</div>
            </div>
            <button class="alert-action" onclick="handleLogin()">${t('action.login')}</button>
          `;
        } else {
          badge.innerHTML = `<span class="status-dot"></span><span>${t('status.live')}</span>`;
          alertDiv.style.display = 'none';
        }
      } catch (e) {
        console.error('Failed to check status:', e);
      }
    }

    // ç™»å½•å¤„ç†
    function handleLogin() {
      alert('Login feature - please implement based on your authentication method');
    }

    // æ¸…ç©ºæ•°æ®
    async function handleClearData() {
      const confirmed = confirm('âš ï¸ Warning: This will permanently delete all historical data!\n\nAre you sure you want to clear the database?\n\nRecommended: Download CSV backup first.');
      if (!confirmed) return;

      const doubleConfirm = confirm('Final confirmation: Do you really want to delete all data?\n\nThis action cannot be undone!');
      if (!doubleConfirm) return;

      try {
        const res = await fetch('/api/clear-data', { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          alert('âœ… ' + data.message);
          await refresh();
        } else {
          alert('âŒ Failed: ' + data.message);
        }
      } catch (e) {
        alert('âŒ Request failed: ' + e.message);
      }
    }

    // ========== æ¯æ—¥æ•°æ®è¡¨æ ¼ ==========
    let dailyDataOffset = 0;
    let dailyDataHasMore = true;
    let dailyDataLoading = false;
    const DAILY_DATA_LIMIT = 10;

    async function loadDailyData(append = false) {
      if (dailyDataLoading) return;
      if (append && !dailyDataHasMore) return;

      dailyDataLoading = true;

      try {
        if (!append) {
          dailyDataOffset = 0;
        }

        const res = await fetch(`/api/analytics/daily?limit=${DAILY_DATA_LIMIT}&offset=${dailyDataOffset}`);
        const result = await res.json();

        if (!result.data || result.data.length === 0) {
          if (!append) {
            document.getElementById('daily-data').innerHTML = `<div class="loading">${t('daily.noData')}</div>`;
          }
          dailyDataHasMore = false;
          updateLoadMoreButton();
          return;
        }

        dailyDataHasMore = result.hasMore;
        dailyDataOffset += result.data.length;

        const rows = result.data.map(d => `
          <div class="daily-row">
            <div class="daily-date">${d.date}</div>
            <div class="daily-value">${d.avgCount.toLocaleString()}</div>
            <div class="daily-value">${d.maxCount.toLocaleString()}</div>
            <div class="daily-streams">${d.predictedStreams.toLocaleString()}</div>
            <div class="daily-samples">${d.samples.toLocaleString()}</div>
          </div>
        `).join('');

        if (append) {
          const table = document.querySelector('#daily-data .daily-table');
          if (table) {
            table.insertAdjacentHTML('beforeend', rows);
          }
        } else {
          document.getElementById('daily-data').innerHTML = `
            <div class="daily-table">
              <div class="daily-row header">
                <div>${t('daily.date')}</div>
                <div>${t('daily.avg')}</div>
                <div>${t('daily.peak')}</div>
                <div>${t('daily.streams')}</div>
                <div>${t('daily.samples')}</div>
              </div>
              ${rows}
            </div>
            <button id="load-more-btn" class="load-more-btn" onclick="loadMoreDailyData()">
              ${t('daily.loadMore')}
            </button>
          `;
        }

        updateLoadMoreButton();
      } catch (e) {
        console.error('Failed to load daily data:', e);
        if (!append) {
          document.getElementById('daily-data').innerHTML = `<div class="loading">${t('daily.noData')}</div>`;
        }
      } finally {
        dailyDataLoading = false;
      }
    }

    function loadMoreDailyData() {
      loadDailyData(true);
    }

    function updateLoadMoreButton() {
      const btn = document.getElementById('load-more-btn');
      if (btn) {
        if (!dailyDataHasMore) {
          btn.textContent = t('daily.noMore');
          btn.disabled = true;
        } else {
          btn.textContent = t('daily.loadMore');
          btn.disabled = false;
        }
      }
    }

    // ========== é‚®ä»¶è®¾ç½® ==========
    async function openEmailSettings() {
      document.getElementById('email-modal').style.display = 'flex';
      await loadEmailConfig();
    }

    function closeEmailModal() {
      document.getElementById('email-modal').style.display = 'none';
    }

    async function loadEmailConfig() {
      try {
        const res = await fetch('/api/email/config');
        const config = await res.json();

        document.getElementById('email-enabled').checked = config.enabled;
        document.getElementById('email-host').value = config.host || '';
        document.getElementById('email-port').value = config.port || 587;
        document.getElementById('email-secure').checked = config.secure;
        document.getElementById('email-user').placeholder = config.user || 'your-email@gmail.com';
        document.getElementById('email-to').placeholder = config.to || 'notifications@example.com';

        const statusEl = document.getElementById('email-status');
        if (config.enabled && config.hasPassword) {
          statusEl.className = 'email-status enabled';
          statusEl.innerHTML = `âœ… ${currentLang === 'zh' ? 'é‚®ä»¶é€šçŸ¥å·²å¯ç”¨' : 'Email notifications enabled'}${config.lastEmailSent ? ` Â· ${currentLang === 'zh' ? 'æœ€åå‘é€' : 'Last sent'}: ${new Date(config.lastEmailSent).toLocaleString()}` : ''}`;
        } else if (config.enabled && !config.hasPassword) {
          statusEl.className = 'email-status disabled';
          statusEl.innerHTML = `âš ï¸ ${currentLang === 'zh' ? 'å·²å¯ç”¨ä½†æœªé…ç½®å¯†ç ' : 'Enabled but no password configured'}`;
        } else {
          statusEl.className = 'email-status disabled';
          statusEl.innerHTML = `âŒ ${currentLang === 'zh' ? 'é‚®ä»¶é€šçŸ¥æœªå¯ç”¨' : 'Email notifications disabled'}`;
        }
      } catch (e) {
        console.error('Failed to load email config:', e);
        document.getElementById('email-status').innerHTML = `âŒ ${currentLang === 'zh' ? 'åŠ è½½é…ç½®å¤±è´¥' : 'Failed to load config'}`;
      }
    }

    async function saveEmailSettings() {
      try {
        const config = {
          enabled: document.getElementById('email-enabled').checked,
          host: document.getElementById('email-host').value || undefined,
          port: document.getElementById('email-port').value || undefined,
          secure: document.getElementById('email-secure').checked,
          user: document.getElementById('email-user').value || undefined,
          to: document.getElementById('email-to').value || undefined
        };

        const pass = document.getElementById('email-pass').value;
        if (pass) {
          config.pass = pass;
        }

        const res = await fetch('/api/email/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await res.json();

        if (result.success) {
          alert(t('email.saveSuccess') + '\n\n' + result.message);
          document.getElementById('email-pass').value = '';
          await loadEmailConfig();
        } else {
          alert(t('email.testFail') + ': ' + result.message);
        }
      } catch (e) {
        alert(t('email.testFail') + ': ' + e.message);
      }
    }

    async function testEmail() {
      try {
        const res = await fetch('/api/email/test', { method: 'POST' });
        const result = await res.json();

        if (result.success) {
          alert(t('email.testSuccess'));
        } else {
          alert(t('email.testFail') + ': ' + result.message);
        }
      } catch (e) {
        alert(t('email.testFail') + ': ' + e.message);
      }
    }

    // åˆ·æ–°æ‰€æœ‰æ•°æ®
    async function refresh() {
      await Promise.all([
        loadHeroSection(),
        loadMainChart(),
        loadHourlyRanking(),
        checkStatus()
      ]);
    }

    // åˆå§‹åŒ–
    async function init() {
      await refresh();
      // æ¯æ—¥æ•°æ®åªåœ¨åˆå§‹åŒ–æ—¶åŠ è½½ä¸€æ¬¡ï¼Œä¸éœ€è¦é¢‘ç¹åˆ·æ–°
      await loadDailyData();
    }

    // è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰
    init();
    setInterval(refresh, 5000);
  </script>

</body>
</html>
