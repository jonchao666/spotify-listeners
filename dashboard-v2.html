<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify 实时分析仪表盘</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --spotify-green: #1DB954;
      --spotify-green-dark: #1aa34a;
      --bg-primary: #0d0d0d;
      --bg-secondary: #161616;
      --bg-tertiary: #1e1e1e;
      --bg-hover: #262626;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.75);
      --text-tertiary: rgba(255, 255, 255, 0.45);
      --border-color: rgba(255, 255, 255, 0.06);
      --border-color-hover: rgba(255, 255, 255, 0.12);
      --success: #1DB954;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* 顶部导航栏 */
    .navbar {
      background: rgba(22, 22, 22, 0.95);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .navbar-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      background: var(--spotify-green);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .brand-logo svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    .brand-info h1 {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }

    .brand-info p {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 1px;
      display: none;
    }

    .navbar-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .lang-switch {
      display: flex;
      gap: 2px;
      background: var(--bg-tertiary);
      padding: 3px;
      border-radius: var(--radius-sm);
    }

    .lang-btn {
      padding: 6px 10px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .lang-btn:hover {
      color: var(--text-primary);
    }

    .lang-btn.active {
      background: var(--spotify-green);
      color: white;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(29, 185, 84, 0.1);
      border: 1px solid rgba(29, 185, 84, 0.15);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      color: var(--spotify-green);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      background: var(--spotify-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(29, 185, 84, 0.7); }
      50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(29, 185, 84, 0); }
    }

    /* 主容器 */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* 分区标题 */
    .section {
      margin-bottom: 40px;
    }

    .section-header {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.3px;
      margin-bottom: 4px;
    }

    .section-subtitle {
      font-size: 13px;
      color: var(--text-tertiary);
    }

    /* ========== 首屏重点数据区 ========== */
    .hero-section {
      margin-bottom: 32px;
    }

    .hero-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 20px;
    }

    .hero-header-left {
      flex: 1;
      min-width: 200px;
    }

    .current-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--spotify-green);
      padding: 10px 16px;
      border-radius: 24px;
    }

    .current-badge-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }

    .current-badge-value {
      font-size: 20px;
      font-weight: 700;
      color: white;
    }

    /* 核心指标行 */
    .hero-main {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    /* 统一的指标卡片 */
    .metric-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 20px;
      transition: border-color 0.2s ease;
    }

    .metric-card:hover {
      border-color: var(--border-color-hover);
    }

    .metric-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.2;
      margin-bottom: 14px;
    }

    .metric-change {
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .metric-change.up {
      color: #1DB954;
      background: rgba(29, 185, 84, 0.15);
    }

    .metric-change.down {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.15);
    }

    /* 时段排行表格 */
    .hourly-table {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden;
    }

    .hourly-row {
      display: grid;
      grid-template-columns: 80px 120px 1fr 100px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      align-items: center;
      transition: background 0.2s;
    }

    .hourly-row:last-child {
      border-bottom: none;
    }

    .hourly-row:hover {
      background: var(--bg-tertiary);
    }

    .hourly-row.header {
      background: var(--bg-tertiary);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .hourly-rank {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .hourly-rank.top3 {
      color: var(--spotify-green);
    }

    .hourly-time {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      flex-wrap: nowrap;
      gap: 8px;
    }

    .hourly-regions {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .hourly-region {
      background: var(--bg-tertiary);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .hourly-avg {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      text-align: right;
    }

    .hourly-bar-container {
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }

    .hourly-bar {
      height: 100%;
      background: var(--spotify-green);
      border-radius: 2px;
    }

    @media (max-width: 768px) {
      .hourly-row {
        grid-template-columns: 60px 1fr 80px;
      }
      .hourly-regions {
        display: none;
      }
    }

    /* 时段分析折叠功能 */
    .hourly-row.hidden {
      display: none;
    }

    .hourly-table.expanded .hourly-row.hidden {
      display: grid;
    }

    .hourly-toggle-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .hourly-toggle-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .hourly-toggle-icon {
      width: 18px;
      height: 18px;
      fill: currentColor;
      transition: transform 0.3s;
    }

    .hourly-toggle-btn.expanded .hourly-toggle-icon {
      transform: rotate(180deg);
    }

    /* 每日数据网格 */
    .daily-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }

    .daily-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 12px;
      transition: all 0.2s;
    }

    .daily-card:hover {
      border-color: var(--spotify-green);
      transform: translateY(-2px);
    }

    .daily-card-date {
      font-weight: 700;
      font-size: 13px;
      color: var(--text-primary);
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border-color);
    }

    .daily-card-stats {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .daily-card-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
    }

    .daily-card-label {
      color: var(--text-secondary);
    }

    .daily-card-value {
      font-weight: 600;
      color: var(--text-primary);
    }

    .daily-card-value.streams {
      color: var(--spotify-green);
    }

    .load-more-btn {
      width: 100%;
      padding: 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s;
    }

    .load-more-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--spotify-green);
      color: var(--spotify-green);
    }

    .load-more-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* 邮件设置模态框 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      width: 100%;
      max-width: 500px;
      padding: 32px;
      position: relative;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 24px;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--spotify-green);
      box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
    }

    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      cursor: pointer;
    }

    .form-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: var(--spotify-green);
    }

    .form-checkbox span {
      font-size: 14px;
      color: var(--text-primary);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    /* 邮件服务提供商选择 */
    .provider-tabs {
      display: flex;
      gap: 8px;
    }

    .provider-tab {
      flex: 1;
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .provider-tab:hover {
      border-color: var(--text-tertiary);
    }

    .provider-tab.active {
      background: rgba(29, 185, 84, 0.15);
      border-color: var(--spotify-green);
      color: var(--spotify-green);
    }

    .provider-config {
      margin-top: 16px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--bg-primary);
      border-color: var(--text-tertiary);
    }

    .btn-primary {
      background: var(--spotify-green);
      border: none;
      color: white;
    }

    .btn-primary:hover {
      background: #1ed760;
      transform: translateY(-1px);
    }

    .email-status {
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .email-status.enabled {
      background: rgba(29, 185, 84, 0.1);
      border: 1px solid rgba(29, 185, 84, 0.3);
      color: var(--spotify-green);
    }

    .email-status.disabled {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--danger);
    }


    /* Facebook风格日期选择器 */
    .date-picker-container {
      position: relative;
    }

    .date-picker-trigger {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 180px;
    }

    .date-picker-trigger:hover {
      border-color: var(--spotify-green);
    }

    .date-picker-trigger svg {
      width: 16px;
      height: 16px;
      fill: var(--text-secondary);
    }

    .date-picker-trigger .arrow {
      margin-left: auto;
      transition: transform 0.2s;
    }

    .date-picker-trigger.open .arrow {
      transform: rotate(180deg);
    }

    .date-picker-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 280px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      z-index: 100;
      display: none;
      max-height: 400px;
      overflow-y: auto;
    }

    .date-picker-dropdown.open {
      display: block;
    }

    .date-picker-section {
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .date-picker-section:last-child {
      border-bottom: none;
    }

    .date-picker-section-title {
      padding: 8px 16px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .date-picker-option {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .date-picker-option:hover {
      background: var(--bg-tertiary);
    }

    .date-picker-option.active {
      background: rgba(29, 185, 84, 0.1);
      color: var(--spotify-green);
    }

    .date-picker-option .check {
      margin-left: auto;
      opacity: 0;
    }

    .date-picker-option.active .check {
      opacity: 1;
    }

    /* 自定义日期输入 */
    .custom-date-inputs {
      padding: 12px 16px;
      display: none;
    }

    .custom-date-inputs.show {
      display: block;
    }

    .custom-date-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .custom-date-inputs input[type="date"] {
      flex: 1;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
    }

    .custom-date-inputs input[type="date"]:focus {
      outline: none;
      border-color: var(--spotify-green);
    }

    .custom-date-apply {
      width: 100%;
      padding: 10px;
      background: var(--spotify-green);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .custom-date-apply:hover {
      background: #1ed760;
    }

    /* 图表统计摘要 */
    .chart-stats {
      display: flex;
      gap: 24px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .chart-stat-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-stat-icon {
      width: 36px;
      height: 36px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .chart-stat-info {
      display: flex;
      flex-direction: column;
    }

    .chart-stat-label {
      font-size: 11px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .chart-stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .chart-stat-value.peak {
      color: var(--spotify-green);
    }

    @media (max-width: 600px) {
      .chart-stats {
        flex-wrap: wrap;
        gap: 16px;
      }
    }

    /* 曲线对比控制 */
    .curve-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .curve-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 2px solid var(--border-color);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .curve-checkbox input {
      display: none;
    }

    .curve-checkbox .curve-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .curve-checkbox.today {
      --curve-color: #1DB954;
    }

    .curve-checkbox.yesterday {
      --curve-color: #3b82f6;
    }

    .curve-checkbox.thisWeek {
      --curve-color: #14b8a6;
    }

    .curve-checkbox.lastWeek {
      --curve-color: #06b6d4;
    }

    .curve-checkbox.last7days {
      --curve-color: #f59e0b;
    }

    .curve-checkbox.last28days {
      --curve-color: #ec4899;
    }

    .curve-checkbox.thisMonth {
      --curve-color: #f97316;
    }

    .curve-checkbox.lastMonth {
      --curve-color: #ef4444;
    }

    .curve-checkbox.thisYear {
      --curve-color: #a855f7;
    }

    .curve-checkbox.lastYear {
      --curve-color: #8b5cf6;
    }

    .curve-checkbox.all {
      --curve-color: #6b7280;
    }

    .curve-checkbox:has(input:checked) {
      border-color: var(--curve-color);
      background: color-mix(in srgb, var(--curve-color) 15%, transparent);
    }

    .curve-checkbox:has(input:checked) .curve-label {
      color: var(--curve-color);
    }

    .curve-checkbox::before {
      content: '';
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--curve-color);
      opacity: 0.3;
      transition: opacity 0.2s;
    }

    .curve-checkbox:has(input:checked)::before {
      opacity: 1;
    }

    .curve-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .curve-stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-size: 12px;
    }

    .curve-stat-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .curve-stat-label {
      color: var(--text-secondary);
    }

    .curve-stat-value {
      color: var(--text-primary);
      font-weight: 600;
    }

    /* 关键指标网格 - 保留用于fallback */
    .key-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    /* 当前听众卡片（特殊样式） */
    .key-metric-card.primary {
      background: linear-gradient(135deg, #1DB954, #1ed760);
      border: none;
      box-shadow: 0 10px 30px rgba(29, 185, 84, 0.3);
    }

    .key-metric-card.primary::before {
      display: none;
    }

    .key-metric-card.primary .key-metric-label,
    .key-metric-card.primary .key-metric-value,
    .key-metric-card.primary .key-metric-subtitle,
    .key-metric-card.primary .key-metric-trend {
      color: white;
    }

    .key-metric-trend {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 8px;
    }

    .key-metric-trend-icon {
      font-size: 18px;
    }

    .key-metric-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 32px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .key-metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      border-color: rgba(29, 185, 84, 0.3);
    }

    .key-metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--spotify-green), #1ed760);
    }

    .key-metric-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .key-metric-value {
      font-size: 48px;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 12px;
      letter-spacing: -2px;
    }

    .key-metric-subtitle {
      font-size: 14px;
      color: var(--text-tertiary);
    }

    .key-metric-trend {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(29, 185, 84, 0.15);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      color: var(--spotify-green);
      margin-top: 12px;
    }

    .key-metric-trend.negative {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    /* ========== 图表区域 ========== */
    .chart-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .chart-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .chart-subtitle {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .time-selector {
      display: flex;
      gap: 6px;
      background: var(--bg-tertiary);
      padding: 4px;
      border-radius: 10px;
    }

    .time-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .time-btn:hover {
      color: var(--text-primary);
    }

    .time-btn.active {
      background: var(--spotify-green);
      color: white;
    }

    .chart-container {
      position: relative;
      height: 400px;
    }

    /* ========== 详细统计区域 ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      background: var(--bg-tertiary);
      border-color: rgba(29, 185, 84, 0.2);
    }

    .stat-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .stat-hour {
      font-size: 18px;
      font-weight: 700;
    }

    .stat-timezones {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
      line-height: 1.4;
    }

    .stat-timezone {
      display: inline-block;
      margin-right: 8px;
    }

    /* 时段分析卡片 */
    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .insight-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      gap: 16px;
      transition: all 0.3s ease;
    }

    .insight-card:hover {
      background: var(--bg-tertiary);
      border-color: rgba(29, 185, 84, 0.3);
    }

    .insight-card.highlight {
      background: linear-gradient(135deg, rgba(29, 185, 84, 0.15), rgba(29, 185, 84, 0.05));
      border-color: rgba(29, 185, 84, 0.3);
    }

    .insight-card.peak {
      border-left: 3px solid var(--spotify-green);
    }

    .insight-icon {
      font-size: 32px;
      flex-shrink: 0;
    }

    .insight-content {
      flex: 1;
    }

    .insight-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .insight-detail {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .insight-subdetail {
      font-size: 13px;
      color: var(--text-secondary);
      opacity: 0.8;
    }

    .insight-value {
      font-size: 13px;
      color: var(--spotify-green);
      font-weight: 600;
      margin-top: 8px;
    }

    .insight-tag {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(29, 185, 84, 0.2);
      color: var(--spotify-green);
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .insight-tag.low {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .insight-summary {
      background: var(--bg-tertiary);
      border-radius: 16px;
      padding: 24px;
      margin-top: 24px;
    }

    .summary-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .summary-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .summary-list li {
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 14px;
    }

    .summary-list li:last-child {
      border-bottom: none;
    }

    .summary-list strong {
      color: var(--spotify-green);
    }

    .stat-badge {
      padding: 4px 12px;
      background: rgba(29, 185, 84, 0.15);
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      color: var(--spotify-green);
      text-transform: uppercase;
    }

    .stat-badge.low {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .stat-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
    }

    .stat-change {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--danger);
    }

    .stat-change.neutral {
      color: var(--text-tertiary);
    }

    /* ========== 数据分析区域 ========== */
    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }

    .analysis-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 32px;
    }

    .analysis-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .analysis-subtitle {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-bottom: 24px;
    }

    .analysis-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .analysis-row:last-child {
      border-bottom: none;
    }

    .analysis-metric {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .analysis-value {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .analysis-number {
      font-size: 24px;
      font-weight: 700;
    }

    .analysis-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: rgba(29, 185, 84, 0.15);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      color: var(--spotify-green);
    }

    .analysis-trend.negative {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    /* 操作按钮 */
    .actions-section {
      margin-top: 64px;
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 16px 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .action-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--spotify-green);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(29, 185, 84, 0.2);
    }

    .action-btn.danger {
      border-color: rgba(239, 68, 68, 0.3);
    }

    .action-btn.danger:hover {
      border-color: var(--danger);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.2);
    }

    .action-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* 页脚 */
    .footer {
      text-align: center;
      padding: 48px 32px;
      color: var(--text-tertiary);
      font-size: 13px;
      border-top: 1px solid var(--border-color);
      margin-top: 64px;
    }

    /* 加载动画 */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
      flex-direction: column;
      gap: 16px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(29, 185, 84, 0.1);
      border-top-color: var(--spotify-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* 错误提示 */
    .alert {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .alert-icon {
      font-size: 28px;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 700;
      color: var(--danger);
      margin-bottom: 4px;
    }

    .alert-message {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .alert-action {
      padding: 10px 20px;
      background: var(--danger);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .alert-action:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    /* ========== 响应式设计 ========== */

    /* 平板 */
    @media (max-width: 1024px) {
      .hero-main {
        grid-template-columns: 1fr 1fr;
      }

      .hero-main .metric-card:last-child {
        grid-column: span 2;
      }

      .daily-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }

      .analysis-grid {
        grid-template-columns: 1fr;
      }
    }

    /* 手机端 */
    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .navbar {
        padding: 10px 0;
      }

      .navbar-content {
        padding: 0 16px;
      }

      .brand-info h1 {
        font-size: 14px;
      }

      .lang-switch {
        display: none;
      }

      .status-badge span:not(.status-dot) {
        display: none;
      }

      .status-badge {
        padding: 8px;
        border-radius: 50%;
      }

      .section {
        margin-bottom: 28px;
      }

      .section-title {
        font-size: 16px;
      }

      .section-subtitle {
        font-size: 12px;
      }

      .hero-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .current-badge {
        width: 100%;
        justify-content: space-between;
        padding: 12px 16px;
      }

      .current-badge-value {
        font-size: 22px;
      }

      .hero-main {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .hero-main .metric-card:last-child {
        grid-column: span 1;
      }

      .metric-card {
        padding: 16px;
      }

      .metric-value {
        font-size: 24px;
      }

      /* 图表区域 */
      .chart-container {
        height: 280px !important;
      }

      .chart-controls {
        flex-wrap: wrap;
        gap: 8px;
      }

      .time-selector {
        width: 100%;
        justify-content: center;
      }

      .time-btn {
        padding: 8px 12px;
        font-size: 12px;
      }

      .chart-stats {
        flex-wrap: wrap;
        gap: 12px;
      }

      .chart-stat-item {
        flex: 1;
        min-width: 80px;
      }

      /* 曲线对比 */
      .curve-controls {
        flex-wrap: wrap;
        gap: 6px;
      }

      .curve-checkbox {
        padding: 6px 10px;
        font-size: 11px;
      }

      /* 每日数据 */
      .daily-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .daily-card {
        padding: 10px;
      }

      .daily-card-date {
        font-size: 12px;
      }

      .daily-card-stat {
        font-size: 10px;
      }

      /* 时段分析 */
      .hourly-row {
        grid-template-columns: 50px 1fr 60px;
        padding: 10px 12px;
        font-size: 12px;
      }

      .hourly-regions {
        display: none;
      }

      .hourly-rank {
        font-size: 11px;
      }

      .hourly-avg {
        font-size: 13px;
      }

      /* 快捷操作 */
      .actions-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .action-btn {
        padding: 14px 12px;
        font-size: 12px;
      }

      .action-btn svg {
        width: 18px;
        height: 18px;
      }

      /* 模态框 */
      .modal-content {
        margin: 16px;
        padding: 20px;
        max-height: calc(100vh - 32px);
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      /* 日期选择器 */
      .date-picker-dropdown {
        width: calc(100vw - 32px);
        left: 16px !important;
        right: 16px !important;
      }

      .date-picker-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* 小屏手机 */
    @media (max-width: 375px) {
      .container {
        padding: 12px;
      }

      .navbar-content {
        padding: 0 12px;
      }

      .brand-logo {
        width: 32px;
        height: 32px;
      }

      .brand-logo svg {
        width: 18px;
        height: 18px;
      }

      .current-badge {
        padding: 10px 14px;
      }

      .metric-value {
        font-size: 22px;
      }

      .daily-grid {
        grid-template-columns: 1fr;
      }

      .actions-grid {
        grid-template-columns: 1fr;
      }
    }

    /* 触摸设备优化 */
    @media (hover: none) and (pointer: coarse) {
      .metric-card:hover,
      .daily-card:hover,
      .action-btn:hover {
        transform: none;
      }

      .time-btn,
      .lang-btn,
      .action-btn,
      .load-more-btn {
        min-height: 44px;
      }
    }
  </style>
</head>
<body>

  <!-- 导航栏 -->
  <nav class="navbar">
    <div class="navbar-content">
      <div class="brand">
        <div class="brand-logo">
          <svg viewBox="0 0 24 24"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
        </div>
        <div class="brand-info">
          <h1 data-i18n="app.title">实时分析</h1>
          <p data-i18n="app.subtitle">Spotify 听众追踪仪表盘</p>
        </div>
      </div>
      <div class="navbar-actions">
        <div class="lang-switch">
          <button class="lang-btn active" data-lang="zh">中文</button>
          <button class="lang-btn" data-lang="en">English</button>
        </div>
        <div class="status-badge" id="status-badge">
          <span class="status-dot"></span>
          <span data-i18n="status.live">实时监控</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- 主容器 -->
  <div class="container">

    <!-- 错误提示 -->
    <div id="error-alert" style="display: none;"></div>

    <!-- ========== 第一部分：数据概览 ========== -->
    <section class="hero-section">
      <div class="section-header hero-header">
        <div class="hero-header-left">
          <h2 class="section-title" data-i18n="section.overview">数据概览</h2>
          <p class="section-subtitle" data-i18n="section.overviewDesc">实时数据与历史对比 <span style="opacity: 0.6; font-size: 12px;" data-i18n="timezone.utc">(UTC时区)</span></p>
        </div>
        <div class="current-badge" id="current-badge">
          <span class="current-badge-label">当前听众</span>
          <span class="current-badge-value" id="current-value">--</span>
        </div>
      </div>

      <!-- 核心指标 -->
      <div id="hero-content">
        <div class="loading">
          <div class="spinner"></div>
          <p data-i18n="loading">加载中...</p>
        </div>
      </div>
    </section>

    <!-- ========== 第二部分：图表区域 ========== -->
    <!-- ========== 每日数据 ========== -->
    <section class="section" id="daily-section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.dailyStats">每日数据</h2>
        <p class="section-subtitle" data-i18n="section.dailyStatsDesc">历史每日平均、峰值与预测播放量</p>
      </div>
      <div id="daily-data"></div>
    </section>

    <!-- ========== 曲线对比 ========== -->
    <section class="section" id="curve-section">
      <div class="section-header">
        <h2 class="section-title">曲线对比</h2>
        <p class="section-subtitle">不同时段的24小时听众分布对比 (UTC)</p>
      </div>
      <div class="card">
        <div class="curve-controls">
          <label class="curve-checkbox today">
            <input type="checkbox" id="curve-today" onchange="updateCurveChart()">
            <span class="curve-label">今天</span>
          </label>
          <label class="curve-checkbox yesterday">
            <input type="checkbox" id="curve-yesterday" onchange="updateCurveChart()">
            <span class="curve-label">昨天</span>
          </label>
          <label class="curve-checkbox thisWeek">
            <input type="checkbox" id="curve-thisWeek" onchange="updateCurveChart()">
            <span class="curve-label">本周</span>
          </label>
          <label class="curve-checkbox lastWeek">
            <input type="checkbox" id="curve-lastWeek" onchange="updateCurveChart()">
            <span class="curve-label">上周</span>
          </label>
          <label class="curve-checkbox last7days">
            <input type="checkbox" id="curve-last7days" onchange="updateCurveChart()">
            <span class="curve-label">近7天</span>
          </label>
          <label class="curve-checkbox last28days">
            <input type="checkbox" id="curve-last28days" onchange="updateCurveChart()">
            <span class="curve-label">近28天</span>
          </label>
          <label class="curve-checkbox thisMonth">
            <input type="checkbox" id="curve-thisMonth" onchange="updateCurveChart()">
            <span class="curve-label">本月</span>
          </label>
          <label class="curve-checkbox lastMonth">
            <input type="checkbox" id="curve-lastMonth" onchange="updateCurveChart()">
            <span class="curve-label">上月</span>
          </label>
          <label class="curve-checkbox thisYear">
            <input type="checkbox" id="curve-thisYear" onchange="updateCurveChart()">
            <span class="curve-label">今年</span>
          </label>
          <label class="curve-checkbox lastYear">
            <input type="checkbox" id="curve-lastYear" onchange="updateCurveChart()">
            <span class="curve-label">近一年</span>
          </label>
          <label class="curve-checkbox all">
            <input type="checkbox" id="curve-all" onchange="updateCurveChart()">
            <span class="curve-label">全部</span>
          </label>
        </div>
        <div class="curve-stats" id="curve-stats"></div>
        <div class="chart-container">
          <canvas id="curve-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- ========== 听众趋势 ========== -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.charts">趋势图表</h2>
        <p class="section-subtitle" data-i18n="section.chartsDesc">数据可视化分析</p>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title" data-i18n="chart.timeline">听众趋势</div>
            <div class="chart-subtitle" id="chart-subtitle" data-i18n="chart.timelineDesc">实时听众数量变化 (UTC)</div>
          </div>
          <div style="display: flex; gap: 12px; align-items: center;">
            <!-- Facebook风格日期选择器 -->
            <div class="date-picker-container">
              <div class="date-picker-trigger" id="date-picker-trigger" onclick="toggleDatePicker()">
                <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg>
                <span id="date-picker-label">今天</span>
                <svg class="arrow" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
              </div>
              <div class="date-picker-dropdown" id="date-picker-dropdown">
                <!-- 最近使用 -->
                <div class="date-picker-section" id="recent-used-section" style="display: none;">
                  <div class="date-picker-section-title" data-i18n="date.recentlyUsed">最近使用</div>
                  <div id="recent-used-options"></div>
                </div>
                <!-- 预设范围 -->
                <div class="date-picker-section">
                  <div class="date-picker-section-title" data-i18n="date.presets">日期范围</div>
                  <div class="date-picker-option" data-range="today" onclick="selectDateRange('today')">
                    <span data-i18n="date.today">今天</span>
                    <span class="check">✓</span>
                  </div>
                  <div class="date-picker-option" data-range="yesterday" onclick="selectDateRange('yesterday')">
                    <span data-i18n="date.yesterday">昨天</span>
                    <span class="check">✓</span>
                  </div>
                  <div class="date-picker-option" data-range="todayYesterday" onclick="selectDateRange('todayYesterday')">
                    <span data-i18n="date.todayYesterday">今天和昨天</span>
                    <span class="check">✓</span>
                  </div>
                  <div class="date-picker-option" data-range="last7days" onclick="selectDateRange('last7days')">
                    <span data-i18n="date.last7days">过去 7 天</span>
                    <span class="check">✓</span>
                  </div>
                  <div class="date-picker-option" data-range="last14days" onclick="selectDateRange('last14days')">
                    <span data-i18n="date.last14days">过去 14 天</span>
                    <span class="check">✓</span>
                  </div>
                  <div class="date-picker-option" data-range="last28days" onclick="selectDateRange('last28days')">
                    <span data-i18n="date.last28days">过去 28 天</span>
                    <span class="check">✓</span>
                  </div>
                  <div class="date-picker-option" data-range="last30days" onclick="selectDateRange('last30days')">
                    <span data-i18n="date.last30days">过去 30 天</span>
                    <span class="check">✓</span>
                  </div>
                  <div class="date-picker-option" data-range="thisWeek" onclick="selectDateRange('thisWeek')">
                    <span data-i18n="date.thisWeek">本周</span>
                    <span class="check">✓</span>
                  </div>
                  <div class="date-picker-option" data-range="lastWeek" onclick="selectDateRange('lastWeek')">
                    <span data-i18n="date.lastWeek">上周</span>
                    <span class="check">✓</span>
                  </div>
                  <div class="date-picker-option" data-range="thisMonth" onclick="selectDateRange('thisMonth')">
                    <span data-i18n="date.thisMonth">本月</span>
                    <span class="check">✓</span>
                  </div>
                  <div class="date-picker-option" data-range="lastMonth" onclick="selectDateRange('lastMonth')">
                    <span data-i18n="date.lastMonth">上月</span>
                    <span class="check">✓</span>
                  </div>
                  <div class="date-picker-option" data-range="maximum" onclick="selectDateRange('maximum')">
                    <span data-i18n="date.maximum">全部数据</span>
                    <span class="check">✓</span>
                  </div>
                  <div class="date-picker-option" data-range="custom" onclick="toggleCustomDate()">
                    <span data-i18n="date.custom">自定义</span>
                    <span class="check">✓</span>
                  </div>
                </div>
                <!-- 自定义日期输入 -->
                <div class="custom-date-inputs" id="custom-date-inputs">
                  <div class="custom-date-row">
                    <input type="date" id="custom-start-date">
                    <input type="date" id="custom-end-date">
                  </div>
                  <button class="custom-date-apply" onclick="applyCustomDate()" data-i18n="date.apply">应用</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 图表统计摘要 -->
        <div class="chart-stats" id="chart-stats"></div>
        <div class="chart-container">
          <canvas id="main-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- ========== 时段分析 ========== -->
    <section class="section" id="hourly-section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.hourlyStats">时段分析</h2>
        <p class="section-subtitle" data-i18n="section.hourlyStatsDesc">各小时平均听众排行 (UTC)</p>
      </div>
      <div id="hourly-ranking"></div>
      <button class="hourly-toggle-btn" id="hourly-toggle" onclick="toggleHourlyExpand()">
        <span id="hourly-toggle-text">展开全部</span>
        <svg class="hourly-toggle-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
      </button>
    </section>

    <!-- ========== 快捷操作 ========== -->
    <section class="actions-section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.actions">快捷操作</h2>
      </div>
      <div class="actions-grid">
        <a href="/api/download/csv" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
          <span data-i18n="action.export">导出 CSV</span>
        </a>
        <button onclick="openEmailSettings()" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
          <span data-i18n="action.email">邮件通知</span>
        </button>
        <button onclick="handleLogin()" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
          <span data-i18n="action.login">重新登录</span>
        </button>
        <button onclick="handleClearData()" class="action-btn danger">
          <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          <span data-i18n="action.clear">清空数据</span>
        </button>
      </div>
    </section>

    <!-- 页脚 -->
    <footer class="footer" data-i18n="footer">
      Spotify 实时分析 · Powered by Claude Code
    </footer>
  </div>

  <!-- 邮件设置模态框 -->
  <div id="email-modal" class="modal-overlay">
    <div class="modal">
      <button class="modal-close" onclick="closeEmailModal()">&times;</button>
      <div class="modal-title">📧 邮件通知设置</div>

      <div id="email-status" class="email-status disabled">加载中...</div>

      <div class="form-group">
        <label class="form-checkbox">
          <input type="checkbox" id="email-enabled">
          <span data-i18n="email.enable">启用邮件通知</span>
        </label>
      </div>

      <div class="form-group">
        <label class="form-label">接收通知邮箱</label>
        <input type="email" id="email-to" class="form-input" placeholder="your-email@example.com">
      </div>

      <!-- 服务提供商选择 -->
      <div class="form-group">
        <label class="form-label">邮件服务</label>
        <div class="provider-tabs">
          <button type="button" class="provider-tab active" data-provider="resend" onclick="switchProvider('resend')">
            Resend (推荐)
          </button>
          <button type="button" class="provider-tab" data-provider="smtp" onclick="switchProvider('smtp')">
            SMTP
          </button>
        </div>
      </div>

      <!-- Resend 配置 -->
      <div id="resend-config" class="provider-config">
        <div class="form-group">
          <label class="form-label">Resend API Key</label>
          <input type="password" id="resend-api-key" class="form-input" placeholder="re_xxxxxxxx (留空则不更改)">
        </div>
        <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 12px; margin-bottom: 16px; font-size: 12px; color: var(--text-secondary);">
          <strong>获取 API Key：</strong>
          <ol style="margin: 8px 0 0 16px; padding: 0;">
            <li>访问 <a href="https://resend.com" target="_blank" style="color: var(--spotify-green);">resend.com</a> 注册账号</li>
            <li>进入 API Keys 页面创建新 Key</li>
            <li>复制 Key 粘贴到上方</li>
          </ol>
          <p style="margin-top: 8px; color: var(--text-tertiary);">免费额度：3000封/月，安全可靠</p>
        </div>
      </div>

      <!-- SMTP 配置 -->
      <div id="smtp-config" class="provider-config" style="display: none;">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">SMTP 服务器</label>
            <input type="text" id="email-host" class="form-input" placeholder="smtp.gmail.com">
          </div>
          <div class="form-group">
            <label class="form-label">端口</label>
            <input type="number" id="email-port" class="form-input" placeholder="587">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">发件邮箱</label>
          <input type="email" id="email-user" class="form-input" placeholder="your-email@gmail.com">
        </div>

        <div class="form-group">
          <label class="form-label">邮箱密码 / 应用专用密码</label>
          <input type="password" id="email-pass" class="form-input" placeholder="留空则不更改">
        </div>

        <div class="form-group">
          <label class="form-checkbox">
            <input type="checkbox" id="email-secure">
            <span>使用 SSL/TLS (端口465时启用)</span>
          </label>
        </div>

        <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 12px; margin-bottom: 16px; font-size: 12px; color: var(--text-secondary);">
          <strong>提示：</strong>Gmail 需使用 <a href="https://myaccount.google.com/apppasswords" target="_blank" style="color: var(--spotify-green);">应用专用密码</a>，安全性较低。推荐使用 Resend。
        </div>
      </div>

      <!-- 定时报告设置 -->
      <div class="form-group" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color);">
        <label class="form-label" style="margin-bottom: 12px;">📊 定时数据报告</label>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <label class="form-checkbox">
            <input type="checkbox" id="report-daily">
            <span>每日报告 <span style="color: var(--text-tertiary);">(每天 UTC 0:00 发送前一天数据)</span></span>
          </label>
          <label class="form-checkbox">
            <input type="checkbox" id="report-weekly">
            <span>每周报告 <span style="color: var(--text-tertiary);">(每周一发送上周数据)</span></span>
          </label>
          <label class="form-checkbox">
            <input type="checkbox" id="report-monthly">
            <span>每月报告 <span style="color: var(--text-tertiary);">(每月1号发送上月数据)</span></span>
          </label>
        </div>
        <div style="margin-top: 12px;">
          <button type="button" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="testReport('daily')">预览日报</button>
          <button type="button" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="testReport('weekly')">预览周报</button>
          <button type="button" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="testReport('monthly')">预览月报</button>
        </div>
      </div>

      <div style="font-size: 11px; color: var(--text-tertiary); margin: 12px 0;">
        修改仅在当前会话有效，永久修改请编辑 .env 文件
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="testEmail()">发送测试</button>
        <button class="btn btn-secondary" onclick="closeEmailModal()">取消</button>
        <button class="btn btn-primary" onclick="saveEmailSettings()">保存设置</button>
      </div>
    </div>
  </div>

  <script>
    // ========== 国际化 ==========
    const i18n = {
      zh: {
        'app.title': '实时分析',
        'app.subtitle': 'Spotify 听众追踪仪表盘',
        'status.live': '实时监控',
        'status.error': '状态异常',
        'loading': '加载中...',
        'section.overview': '核心概览',
        'section.overviewDesc': '最重要的实时数据一目了然',
        'timezone.utc': '(UTC时区)',
        'section.charts': '趋势图表',
        'section.chartsDesc': '数据可视化分析',
        'section.hourlyStats': '时段分析',
        'section.hourlyStatsDesc': '各时区高峰低谷时段洞察',
        'section.analysis': '深度分析',
        'section.analysisDesc': '与历史数据对比分析',
        'section.actions': '快捷操作',
        'chart.timeline': '听众趋势',
        'chart.timelineDesc': '实时听众数量变化 (UTC)',
        'chart.raw': '原始',
        'chart.smooth': '平滑',
        'time.1h': '1小时',
        'time.6h': '6小时',
        'time.12h': '12小时',
        'time.24h': '24小时',
        'time.all': '全部',
        'action.stats': '统计 API',
        'action.recent': '最近数据',
        'action.export': '导出 CSV',
        'action.login': '重新登录',
        'action.clear': '清空数据',
        'action.email': '邮件通知',
        'footer': 'Spotify 实时分析 · Powered by Claude Code',
        'section.dailyStats': '每日数据',
        'section.dailyStatsDesc': '历史每日平均、峰值与预测播放量',
        'daily.date': '日期',
        'daily.avg': '平均听众',
        'daily.peak': '峰值',
        'daily.streams': '预测播放',
        'daily.samples': '采样数',
        'daily.loadMore': '加载更多',
        'daily.noMore': '没有更多数据',
        'daily.noData': '暂无数据',
        'email.enable': '启用邮件通知',
        'email.testSuccess': '测试邮件已发送',
        'email.testFail': '发送失败',
        'email.saveSuccess': '设置已保存',
        'date.recentlyUsed': '最近使用',
        'date.presets': '日期范围',
        'date.today': '今天',
        'date.yesterday': '昨天',
        'date.todayYesterday': '今天和昨天',
        'date.last7days': '过去 7 天',
        'date.last14days': '过去 14 天',
        'date.last28days': '过去 28 天',
        'date.last30days': '过去 30 天',
        'date.thisWeek': '本周',
        'date.lastWeek': '上周',
        'date.thisMonth': '本月',
        'date.lastMonth': '上月',
        'date.maximum': '全部数据',
        'date.custom': '自定义',
        'date.apply': '应用',
        'hero.current': '当前听众',
        'hero.todayAvg': '今日平均',
        'hero.prediction': '预测播放量',
        'hero.todayPrediction': '今日预测播放',
        'hero.peak': '今日峰值',
        'hero.todayPeak': '今日峰值',
        'hero.vs1h': '对比1小时前',
        'hero.predictedStreams': '预计今日播放',
        'hero.based': '基于平均听众数估算',
        'hourly.average': '平均',
        'hourly.vsHistory': '对比历史',
        'hourly.peak': '高峰',
        'hourly.low': '低谷',
        'hourly.listeners': '听众',
        'hourly.noData': '暂无数据',
        'analysis.yesterday': '对比昨天',
        'analysis.yesterdayDesc': '与前一天同时段对比',
        'analysis.lastWeek': '对比上周',
        'analysis.lastWeekDesc': '与7天前同时段对比',
        'analysis.overall': '整体统计',
        'analysis.overallDesc': '全部历史数据汇总',
        'analysis.thisWeek': '本周统计',
        'analysis.thisWeekDesc': '本周(UTC)数据汇总',
        'analysis.thisMonth': '本月统计',
        'analysis.thisMonthDesc': '本月(UTC)数据汇总',
        'analysis.currentAvg': '当前平均',
        'analysis.yesterdayAvg': '昨日平均',
        'analysis.lastWeekAvg': '上周平均',
        'analysis.overallAvg': '整体平均',
        'analysis.weekAvg': '本周平均',
        'analysis.monthAvg': '本月平均',
        'analysis.weekPeak': '本周峰值',
        'analysis.monthPeak': '本月峰值',
        'analysis.overallPeak': '历史峰值',
        'analysis.overallMin': '历史最低',
        'analysis.change': '变化',
        'listeners': '听众',
        'na': '暂无数据'
      },
      en: {
        'app.title': 'Real-Time Analytics',
        'app.subtitle': 'Spotify Listener Tracking Dashboard',
        'status.live': 'Live Monitoring',
        'status.error': 'Error',
        'loading': 'Loading...',
        'section.overview': 'Overview',
        'section.overviewDesc': 'Key metrics at a glance',
        'timezone.utc': '(UTC Timezone)',
        'section.charts': 'Charts',
        'section.chartsDesc': 'Data visualization',
        'section.hourlyStats': 'Time Zone Analysis',
        'section.hourlyStatsDesc': 'Peak and low hours by timezone',
        'section.analysis': 'Deep Analysis',
        'section.analysisDesc': 'Historical data comparison',
        'section.actions': 'Quick Actions',
        'chart.timeline': 'Listener Trends',
        'chart.timelineDesc': 'Real-time listener count changes (UTC)',
        'chart.raw': 'Raw',
        'chart.smooth': 'Smooth',
        'time.1h': '1 Hour',
        'time.6h': '6 Hours',
        'time.12h': '12 Hours',
        'time.24h': '24 Hours',
        'time.all': 'All',
        'action.stats': 'Stats API',
        'action.recent': 'Recent Data',
        'action.export': 'Export CSV',
        'action.login': 'Re-login',
        'action.clear': 'Clear Data',
        'action.email': 'Email Alerts',
        'footer': 'Spotify Real-Time Analytics · Powered by Claude Code',
        'section.dailyStats': 'Daily Data',
        'section.dailyStatsDesc': 'Historical daily average, peak, and predicted streams',
        'daily.date': 'Date',
        'daily.avg': 'Avg Listeners',
        'daily.peak': 'Peak',
        'daily.streams': 'Est. Streams',
        'daily.samples': 'Samples',
        'daily.loadMore': 'Load More',
        'daily.noMore': 'No more data',
        'daily.noData': 'No data',
        'email.enable': 'Enable Email Notifications',
        'email.testSuccess': 'Test email sent',
        'email.testFail': 'Send failed',
        'email.saveSuccess': 'Settings saved',
        'date.recentlyUsed': 'Recently Used',
        'date.presets': 'Date Range Presets',
        'date.today': 'Today',
        'date.yesterday': 'Yesterday',
        'date.todayYesterday': 'Today and Yesterday',
        'date.last7days': 'Last 7 days',
        'date.last14days': 'Last 14 days',
        'date.last28days': 'Last 28 days',
        'date.last30days': 'Last 30 days',
        'date.thisWeek': 'This week',
        'date.lastWeek': 'Last week',
        'date.thisMonth': 'This month',
        'date.lastMonth': 'Last month',
        'date.maximum': 'Maximum',
        'date.custom': 'Custom',
        'date.apply': 'Apply',
        'hero.current': 'Current Listeners',
        'hero.todayAvg': 'Today Average',
        'hero.prediction': 'Predicted Streams',
        'hero.todayPrediction': 'Today Predicted Streams',
        'hero.peak': 'Peak',
        'hero.todayPeak': 'Today Peak',
        'hero.vs1h': 'vs 1 hour ago',
        'hero.predictedStreams': 'Predicted Daily Streams',
        'hero.based': 'Based on average listener count',
        'hourly.average': 'Average',
        'hourly.vsHistory': 'vs History',
        'hourly.peak': 'Peak',
        'hourly.low': 'Low',
        'hourly.listeners': 'listeners',
        'hourly.noData': 'No data',
        'analysis.yesterday': 'vs Yesterday',
        'analysis.yesterdayDesc': 'Comparison with previous day',
        'analysis.lastWeek': 'vs Last Week',
        'analysis.lastWeekDesc': 'Comparison with 7 days ago',
        'analysis.overall': 'Overall Stats',
        'analysis.overallDesc': 'All historical data summary',
        'analysis.thisWeek': 'This Week',
        'analysis.thisWeekDesc': 'This week (UTC) data summary',
        'analysis.thisMonth': 'This Month',
        'analysis.thisMonthDesc': 'This month (UTC) data summary',
        'analysis.currentAvg': 'Current Average',
        'analysis.yesterdayAvg': 'Yesterday Average',
        'analysis.lastWeekAvg': 'Last Week Average',
        'analysis.overallAvg': 'Overall Average',
        'analysis.weekAvg': 'Week Average',
        'analysis.monthAvg': 'Month Average',
        'analysis.weekPeak': 'Week Peak',
        'analysis.monthPeak': 'Month Peak',
        'analysis.overallPeak': 'All-time Peak',
        'analysis.overallMin': 'All-time Low',
        'analysis.change': 'Change',
        'listeners': 'listeners',
        'na': 'N/A'
      }
    };

    let currentLang = 'zh';

    function t(key) {
      return i18n[currentLang][key] || key;
    }

    function updateLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      refresh();
      // 切换语言时重新加载每日数据表格以更新翻译
      dailyDataOffset = 0;
      dailyDataHasMore = true;
      loadDailyData();
    }

    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        updateLanguage(btn.dataset.lang);
      });
    });

    // ========== 数据和图表 ==========
    let mainChart;
    let curveChart; // 曲线对比图表
    let currentDateRange = 'today'; // 当前选中的日期范围
    let customStartDate = null;
    let customEndDate = null;
    let allData = [];
    let processedData = []; // 图表使用的处理后数据
    let recentlyUsedRanges = []; // 最近使用的范围

    // 初始化最近使用的范围
    try {
      recentlyUsedRanges = JSON.parse(localStorage.getItem('recentDateRanges') || '[]');
    } catch (e) {
      recentlyUsedRanges = [];
    }

    // 日期范围配置
    const dateRangeConfig = {
      today: { labelKey: 'date.today', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));
        return { start, end: now };
      }},
      yesterday: { labelKey: 'date.yesterday', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 1, 0, 0, 0));
        const end = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));
        return { start, end };
      }},
      todayYesterday: { labelKey: 'date.todayYesterday', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 1, 0, 0, 0));
        return { start, end: now };
      }},
      last7days: { labelKey: 'date.last7days', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 6, 0, 0, 0));
        return { start, end: now };
      }},
      last14days: { labelKey: 'date.last14days', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 13, 0, 0, 0));
        return { start, end: now };
      }},
      last28days: { labelKey: 'date.last28days', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 27, 0, 0, 0));
        return { start, end: now };
      }},
      last30days: { labelKey: 'date.last30days', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 29, 0, 0, 0));
        return { start, end: now };
      }},
      thisWeek: { labelKey: 'date.thisWeek', getDates: () => {
        const now = new Date();
        const dayOfWeek = now.getUTCDay();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - dayOfWeek, 0, 0, 0));
        return { start, end: now };
      }},
      lastWeek: { labelKey: 'date.lastWeek', getDates: () => {
        const now = new Date();
        const dayOfWeek = now.getUTCDay();
        const thisWeekStart = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - dayOfWeek, 0, 0, 0));
        const start = new Date(thisWeekStart.getTime() - 7 * 24 * 60 * 60 * 1000);
        const end = new Date(thisWeekStart.getTime());
        return { start, end };
      }},
      thisMonth: { labelKey: 'date.thisMonth', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1, 0, 0, 0));
        return { start, end: now };
      }},
      lastMonth: { labelKey: 'date.lastMonth', getDates: () => {
        const now = new Date();
        const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() - 1, 1, 0, 0, 0));
        const end = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1, 0, 0, 0));
        return { start, end };
      }},
      maximum: { labelKey: 'date.maximum', getDates: () => {
        return { start: null, end: null }; // null 表示获取全部数据
      }}
    };

    // 切换日期选择器下拉框
    function toggleDatePicker() {
      const dropdown = document.getElementById('date-picker-dropdown');
      const trigger = document.getElementById('date-picker-trigger');
      dropdown.classList.toggle('open');
      trigger.classList.toggle('open');
      updateRecentlyUsedSection();
    }

    // 点击外部关闭下拉框
    document.addEventListener('click', (e) => {
      const container = document.querySelector('.date-picker-container');
      if (container && !container.contains(e.target)) {
        document.getElementById('date-picker-dropdown').classList.remove('open');
        document.getElementById('date-picker-trigger').classList.remove('open');
      }
    });

    // 更新最近使用区域
    function updateRecentlyUsedSection() {
      const section = document.getElementById('recent-used-section');
      const optionsContainer = document.getElementById('recent-used-options');

      if (recentlyUsedRanges.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      optionsContainer.innerHTML = recentlyUsedRanges.slice(0, 3).map(range => {
        const config = dateRangeConfig[range];
        if (!config) return '';
        const isActive = currentDateRange === range ? 'active' : '';
        return `
          <div class="date-picker-option ${isActive}" data-range="${range}" onclick="selectDateRange('${range}')">
            <span>${t(config.labelKey)}</span>
            <span class="check">✓</span>
          </div>
        `;
      }).join('');
    }

    // 选择日期范围
    function selectDateRange(range) {
      currentDateRange = range;

      // 更新选中状态
      document.querySelectorAll('.date-picker-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.range === range);
      });

      // 更新标签显示
      const config = dateRangeConfig[range];
      if (config) {
        document.getElementById('date-picker-label').textContent = t(config.labelKey);
      }

      // 隐藏自定义日期输入
      document.getElementById('custom-date-inputs').classList.remove('show');

      // 添加到最近使用
      if (range !== 'custom') {
        addToRecentlyUsed(range);
      }

      // 关闭下拉框并加载图表
      document.getElementById('date-picker-dropdown').classList.remove('open');
      document.getElementById('date-picker-trigger').classList.remove('open');
      loadMainChart();
    }

    // 添加到最近使用
    function addToRecentlyUsed(range) {
      recentlyUsedRanges = recentlyUsedRanges.filter(r => r !== range);
      recentlyUsedRanges.unshift(range);
      recentlyUsedRanges = recentlyUsedRanges.slice(0, 5);
      try {
        localStorage.setItem('recentDateRanges', JSON.stringify(recentlyUsedRanges));
      } catch (e) {}
    }

    // 切换自定义日期输入
    function toggleCustomDate() {
      const inputs = document.getElementById('custom-date-inputs');
      inputs.classList.toggle('show');

      // 设置默认日期
      const now = new Date();
      const startInput = document.getElementById('custom-start-date');
      const endInput = document.getElementById('custom-end-date');

      if (!startInput.value) {
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        startInput.value = weekAgo.toISOString().split('T')[0];
      }
      if (!endInput.value) {
        endInput.value = now.toISOString().split('T')[0];
      }
    }

    // 应用自定义日期
    function applyCustomDate() {
      const startInput = document.getElementById('custom-start-date');
      const endInput = document.getElementById('custom-end-date');

      if (!startInput.value || !endInput.value) {
        alert(currentLang === 'zh' ? '请选择开始和结束日期' : 'Please select start and end dates');
        return;
      }

      customStartDate = new Date(startInput.value + 'T00:00:00Z');
      customEndDate = new Date(endInput.value + 'T23:59:59Z');

      if (customStartDate > customEndDate) {
        alert(currentLang === 'zh' ? '开始日期不能晚于结束日期' : 'Start date cannot be after end date');
        return;
      }

      currentDateRange = 'custom';

      // 更新标签显示
      const label = `${startInput.value} - ${endInput.value}`;
      document.getElementById('date-picker-label').textContent = label;

      // 更新选中状态
      document.querySelectorAll('.date-picker-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.range === 'custom');
      });

      // 关闭下拉框并加载图表
      document.getElementById('date-picker-dropdown').classList.remove('open');
      document.getElementById('date-picker-trigger').classList.remove('open');
      loadMainChart();
    }


    // 加载数据概览（整合所有数据展示，独立获取数据）
    async function loadHeroSection() {
      try {
        // 获取统计数据和足够多的历史数据
        const [statsRes, heroDataRes] = await Promise.all([
          fetch('/api/stats'),
          fetch('/api/data?limit=250000')
        ]);

        const stats = await statsRes.json();
        const heroData = await heroDataRes.json();

        if (!stats || stats.totalRecords === 0) {
          document.getElementById('hero-content').innerHTML = `<div class="loading">${t('na')}</div>`;
          return;
        }

        const current = stats.latestCount;
        const nowUTC = new Date();

        // === 今日数据 (UTC) ===
        const todayStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate(), 0, 0, 0, 0));
        const todayData = heroData.filter(d => new Date(d.timestamp) >= todayStartUTC);
        const todayValues = todayData.map(d => d.listenerCount);
        const todayAvg = todayValues.length > 0 ? todayValues.reduce((a, b) => a + b, 0) / todayValues.length : current;
        const todayPeak = todayValues.length > 0 ? Math.max(...todayValues) : current;

        // 今日预测播放量
        const hoursElapsedUTC = (nowUTC - todayStartUTC) / (1000 * 60 * 60);
        const predictedStreams = hoursElapsedUTC > 0 ? Math.round((todayAvg * 24 * 60) / 3) : 0;

        // 对比1小时前
        const data1h = heroData.slice(-720);
        const avg1h = data1h.length > 0 ? data1h.reduce((s, d) => s + d.listenerCount, 0) / data1h.length : 0;
        const trend1h = avg1h > 0 ? ((current - avg1h) / avg1h * 100).toFixed(1) : 0;
        const isUp = parseFloat(trend1h) > 0;

        // === 过去7天数据 (UTC) ===
        const weekStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 6, 0, 0, 0));
        const thisWeekData = heroData.filter(d => new Date(d.timestamp) >= weekStartUTC);
        const thisWeekValues = thisWeekData.map(d => d.listenerCount);
        const thisWeekAvg = thisWeekValues.length > 0 ? thisWeekValues.reduce((a, b) => a + b, 0) / thisWeekValues.length : null;
        const thisWeekPeak = thisWeekValues.length > 0 ? Math.max(...thisWeekValues) : null;

        // === 近30天数据 (UTC) ===
        const monthStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 29, 0, 0, 0));
        const thisMonthData = heroData.filter(d => new Date(d.timestamp) >= monthStartUTC);
        const thisMonthValues = thisMonthData.map(d => d.listenerCount);
        const thisMonthAvg = thisMonthValues.length > 0 ? thisMonthValues.reduce((a, b) => a + b, 0) / thisMonthValues.length : null;
        const thisMonthPeak = thisMonthValues.length > 0 ? Math.max(...thisMonthValues) : null;

        // === 全部数据 ===
        const allValues = heroData.map(d => d.listenerCount);
        const overallAvg = allValues.reduce((a, b) => a + b, 0) / allValues.length;
        const overallPeak = Math.max(...allValues);

        // === 计算各时期预测每日播放量 ===
        // 公式: 平均听众 * 24小时 * 60分钟 / 3分钟(每首歌) = 每日播放
        const calcDailyStreams = (avg) => avg ? Math.round((avg * 24 * 60) / 3) : null;
        const thisWeekDailyStreams = calcDailyStreams(thisWeekAvg);
        const thisMonthDailyStreams = calcDailyStreams(thisMonthAvg);
        const overallDailyStreams = calcDailyStreams(overallAvg);

        // === 昨天数据 (用于对比) ===
        const yesterdayStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 1, 0, 0, 0, 0));
        const yesterdayData = heroData.filter(d => {
          const ts = new Date(d.timestamp);
          return ts >= yesterdayStartUTC && ts < todayStartUTC;
        });
        const yesterdayValues = yesterdayData.map(d => d.listenerCount);
        const yesterdayAvg = yesterdayValues.length > 0 ? yesterdayValues.reduce((a, b) => a + b, 0) / yesterdayValues.length : null;
        const yesterdayPeak = yesterdayValues.length > 0 ? Math.max(...yesterdayValues) : null;
        const yesterdayDailyStreams = calcDailyStreams(yesterdayAvg);

        // === 7-14天前数据 (用于对比) ===
        const lastWeekStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 13, 0, 0, 0));
        const lastWeekEndUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 6, 0, 0, 0));
        const lastWeekData = heroData.filter(d => {
          const ts = new Date(d.timestamp);
          return ts >= lastWeekStartUTC && ts < lastWeekEndUTC;
        });
        const lastWeekValues = lastWeekData.map(d => d.listenerCount);
        const lastWeekAvg = lastWeekValues.length > 0 ? lastWeekValues.reduce((a, b) => a + b, 0) / lastWeekValues.length : null;
        const lastWeekPeak = lastWeekValues.length > 0 ? Math.max(...lastWeekValues) : null;
        const lastWeekDailyStreams = calcDailyStreams(lastWeekAvg);

        // === 上月数据 (用于对比) ===
        const lastMonthStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth() - 1, 1));
        const lastMonthData = heroData.filter(d => {
          const ts = new Date(d.timestamp);
          return ts >= lastMonthStartUTC && ts < monthStartUTC;
        });
        const lastMonthValues = lastMonthData.map(d => d.listenerCount);
        const lastMonthAvg = lastMonthValues.length > 0 ? lastMonthValues.reduce((a, b) => a + b, 0) / lastMonthValues.length : null;
        const lastMonthPeak = lastMonthValues.length > 0 ? Math.max(...lastMonthValues) : null;
        const lastMonthDailyStreams = calcDailyStreams(lastMonthAvg);

        // === 计算变化百分比 ===
        const calcChange = (current, previous) => {
          if (!current || !previous) return null;
          return ((current - previous) / previous * 100).toFixed(1);
        };

        const formatChange = (change) => {
          if (change === null) return '';
          const num = parseFloat(change);
          const arrow = num >= 0 ? '↗' : '↘';
          const cls = num >= 0 ? 'up' : 'down';
          return `<span class="metric-change ${cls}">${arrow}${Math.abs(num)}%</span>`;
        };


        // UTC日期格式化
        const utcDateStr = nowUTC.toISOString().split('T')[0];
        const yesterdayDateStr = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 1)).toISOString().split('T')[0];

        // 更新当前听众徽章
        document.getElementById('current-value').textContent = current.toLocaleString();
        document.querySelector('.current-badge-label').textContent = t('hero.current');

        // 渲染完整的数据概览
        document.getElementById('hero-content').innerHTML = `
          <!-- 核心指标卡片 -->
          <div class="hero-main">
            <!-- 今日平均 -->
            <div class="metric-card">
              <div class="metric-label">${currentLang === 'zh' ? '今日平均' : 'Today Avg'} <span style="opacity:0.5;font-size:10px;">UTC ${utcDateStr}</span></div>
              <div class="metric-value">${todayAvg.toFixed(1)}</div>
            </div>

            <!-- 今日峰值 -->
            <div class="metric-card">
              <div class="metric-label">${currentLang === 'zh' ? '今日峰值' : 'Today Peak'} <span style="opacity:0.5;font-size:10px;">UTC</span></div>
              <div class="metric-value">${todayPeak.toLocaleString()}</div>
            </div>

            <!-- 今日预测播放 -->
            <div class="metric-card">
              <div class="metric-label">${currentLang === 'zh' ? '今日预测播放' : 'Est. Daily Streams'} <span style="opacity:0.5;font-size:10px;">UTC</span></div>
              <div class="metric-value">${predictedStreams.toLocaleString()}</div>
            </div>
          </div>
        `;
      } catch (e) {
        console.error('Failed to load hero section:', e);
      }
    }

    // 加载主图表
    async function loadMainChart() {
      try {
        // 获取日期范围
        let startDate = null;
        let endDate = null;

        if (currentDateRange === 'custom') {
          startDate = customStartDate;
          endDate = customEndDate;
        } else {
          const config = dateRangeConfig[currentDateRange];
          if (config) {
            const dates = config.getDates();
            startDate = dates.start;
            endDate = dates.end;
          }
        }

        // 获取数据（获取足够多的数据用于过滤）
        const res = await fetch('/api/data?limit=250000');
        let rawData = await res.json();

        if (rawData.length === 0) return;

        // 根据日期范围过滤数据
        if (startDate || endDate) {
          allData = rawData.filter(d => {
            const ts = new Date(d.timestamp);
            if (startDate && ts < startDate) return false;
            if (endDate && ts > endDate) return false;
            return true;
          });
        } else {
          allData = rawData;
        }

        if (allData.length === 0) {
          // 没有数据，显示空图表
          if (mainChart) {
            mainChart.data.labels = [];
            mainChart.data.datasets[0].data = [];
            mainChart.update('none');
          }
          document.getElementById('chart-subtitle').textContent = currentLang === 'zh' ? '选定范围内无数据' : 'No data in selected range';
          return;
        }

        processedData = allData;

        // 大数据量时进行数据聚合，保持约500个点
        if (allData.length > 1000) {
          const aggregateSize = Math.max(1, Math.floor(allData.length / 500));

          processedData = [];
          for (let i = 0; i < allData.length; i += aggregateSize) {
            const chunk = allData.slice(i, i + aggregateSize);
            const avgCount = chunk.reduce((sum, d) => sum + d.listenerCount, 0) / chunk.length;
            processedData.push({
              timestamp: chunk[Math.floor(chunk.length / 2)].timestamp,
              listenerCount: Math.round(avgCount)
            });
          }
        }

        // 判断是否显示日期（跨天数据）
        const firstDate = new Date(processedData[0].timestamp);
        const lastDate = new Date(processedData[processedData.length - 1].timestamp);
        const daysDiff = (lastDate - firstDate) / (1000 * 60 * 60 * 24);
        const showDate = daysDiff >= 1;

        // 使用UTC时间格式化x轴标签
        const labels = processedData.map(d => {
          const date = new Date(d.timestamp);
          const hours = String(date.getUTCHours()).padStart(2, '0');
          const minutes = String(date.getUTCMinutes()).padStart(2, '0');

          if (showDate) {
            // 长时间范围：显示日期+时间
            const month = date.getUTCMonth() + 1;
            const day = date.getUTCDate();
            return `${month}/${day} ${hours}:${minutes}`;
          } else {
            // 短时间范围：只显示时间
            return `${hours}:${minutes}`;
          }
        });
        const values = processedData.map(d => d.listenerCount);

        const ctx = document.getElementById('main-chart').getContext('2d');

        const datasets = [{
          label: currentLang === 'zh' ? '听众数' : 'Listeners',
          data: values,
          borderColor: '#1DB954',
          borderWidth: 3,
          backgroundColor: (context) => {
            const ctx = context.chart.ctx;
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(29, 185, 84, 0.4)');
            gradient.addColorStop(1, 'rgba(29, 185, 84, 0)');
            return gradient;
          },
          fill: true,
          tension: 0.1,
          pointRadius: 0,
          pointHoverRadius: 8,
          pointHoverBackgroundColor: '#1DB954',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 3
        }];

        if (!mainChart) {
          mainChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { intersect: false, mode: 'index' },
              plugins: {
                legend: {
                  display: false,
                  position: 'top',
                  align: 'end',
                  labels: {
                    color: 'rgba(255, 255, 255, 0.7)',
                    usePointStyle: true,
                    pointStyle: 'line',
                    font: { size: 12 }
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.9)',
                  titleColor: '#1DB954',
                  bodyColor: '#fff',
                  titleFont: { size: 16, weight: '700' },
                  bodyFont: { size: 13, weight: '500' },
                  padding: 12,
                  displayColors: true,
                  callbacks: {
                    title: (items) => {
                      if (!items.length) return '';
                      const mainItem = items.find(i => i.datasetIndex === 0);
                      if (!mainItem) return '';
                      return mainItem.parsed.y.toLocaleString() + ' ' + t('listeners');
                    },
                    label: (ctx) => {
                      if (ctx.datasetIndex === 1) {
                        return (currentLang === 'zh' ? '移动平均: ' : 'Moving Avg: ') + ctx.parsed.y.toFixed(1);
                      }
                      const idx = ctx.dataIndex;
                      const dataPoint = processedData[idx];
                      if (!dataPoint) return '';

                      const date = new Date(dataPoint.timestamp);
                      const timeStr = date.toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'UTC'
                      });
                      return timeStr + ' UTC';
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  grid: { color: 'rgba(255, 255, 255, 0.05)' },
                  ticks: {
                    color: 'rgba(255, 255, 255, 0.5)',
                    callback: function(value) {
                      return Number.isInteger(value) ? value : '';
                    }
                  }
                },
                x: {
                  grid: { display: false },
                  ticks: { color: 'rgba(255, 255, 255, 0.5)', maxTicksLimit: 12 }
                }
              }
            }
          });
        } else {
          mainChart.data.labels = labels;
          mainChart.data.datasets = datasets;
          mainChart.update('none');
        }

        // 更新图表副标题显示数据点数量
        const subtitle = document.getElementById('chart-subtitle');
        if (subtitle) {
          const pointCount = processedData.length;
          const config = dateRangeConfig[currentDateRange];
          let rangeText;
          if (currentDateRange === 'custom') {
            rangeText = document.getElementById('date-picker-label').textContent;
          } else if (config) {
            rangeText = t(config.labelKey);
          } else {
            rangeText = currentLang === 'zh' ? '全部数据' : 'All data';
          }
          subtitle.textContent = `${rangeText} · ${pointCount.toLocaleString()} ${currentLang === 'zh' ? '数据点' : 'points'} (UTC)`;
        }

        // 更新图表统计摘要
        const chartStats = document.getElementById('chart-stats');
        if (chartStats && allData.length > 0) {
          const allValues = allData.map(d => d.listenerCount);
          const avg = allValues.reduce((a, b) => a + b, 0) / allValues.length;
          const peak = Math.max(...allValues);
          const min = Math.min(...allValues);

          chartStats.innerHTML = `
            <div class="chart-stat-item">
              <div class="chart-stat-icon">📊</div>
              <div class="chart-stat-info">
                <span class="chart-stat-label">${currentLang === 'zh' ? '平均' : 'Average'}</span>
                <span class="chart-stat-value">${avg.toFixed(1)}</span>
              </div>
            </div>
            <div class="chart-stat-item">
              <div class="chart-stat-icon">📈</div>
              <div class="chart-stat-info">
                <span class="chart-stat-label">${currentLang === 'zh' ? '峰值' : 'Peak'}</span>
                <span class="chart-stat-value peak">${peak.toLocaleString()}</span>
              </div>
            </div>
            <div class="chart-stat-item">
              <div class="chart-stat-icon">📉</div>
              <div class="chart-stat-info">
                <span class="chart-stat-label">${currentLang === 'zh' ? '最低' : 'Minimum'}</span>
                <span class="chart-stat-value">${min.toLocaleString()}</span>
              </div>
            </div>
          `;
        }
      } catch (e) {
        console.error('Failed to load main chart:', e);
      }
    }

    // ========== 曲线对比图表 ==========
    const curveColors = {
      today: { border: '#1DB954', bg: 'rgba(29, 185, 84, 0.1)' },
      yesterday: { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
      thisWeek: { border: '#14b8a6', bg: 'rgba(20, 184, 166, 0.1)' },
      lastWeek: { border: '#06b6d4', bg: 'rgba(6, 182, 212, 0.1)' },
      last7days: { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
      last28days: { border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' },
      thisMonth: { border: '#f97316', bg: 'rgba(249, 115, 22, 0.1)' },
      lastMonth: { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
      thisYear: { border: '#a855f7', bg: 'rgba(168, 85, 247, 0.1)' },
      lastYear: { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
      all: { border: '#6b7280', bg: 'rgba(107, 114, 128, 0.1)' }
    };

    const curveLabels = {
      today: '今天',
      yesterday: '昨天',
      thisWeek: '本周',
      lastWeek: '上周',
      last7days: '近7天',
      last28days: '近28天',
      thisMonth: '本月',
      lastMonth: '上月',
      thisYear: '今年',
      lastYear: '近一年',
      all: '全部'
    };

    async function fetchCurveData(type) {
      try {
        const res = await fetch(`/api/analytics/curve?type=${type}`);
        return await res.json();
      } catch (e) {
        console.error(`Failed to fetch curve data for ${type}:`, e);
        return null;
      }
    }

    async function updateCurveChart() {
      const types = ['today', 'yesterday', 'thisWeek', 'lastWeek', 'last7days', 'last28days', 'thisMonth', 'lastMonth', 'thisYear', 'lastYear', 'all'];
      const selectedTypes = types.filter(t =>
        document.getElementById(`curve-${t}`).checked
      );

      // 保存选择到 localStorage
      localStorage.setItem('curveSelection', JSON.stringify(selectedTypes));

      const statsContainer = document.getElementById('curve-stats');

      if (selectedTypes.length === 0) {
        if (curveChart) {
          curveChart.data.datasets = [];
          curveChart.update('none');
        }
        statsContainer.innerHTML = '';
        return;
      }

      // 并行获取所有选中的数据
      const dataPromises = selectedTypes.map(t => fetchCurveData(t));
      const results = await Promise.all(dataPromises);

      const datasets = [];
      const statsHtml = [];

      results.forEach((result, idx) => {
        if (!result || !result.data) return;

        const type = selectedTypes[idx];
        const color = curveColors[type];
        const dataValues = result.data.map(d => d.value);

        datasets.push({
          label: curveLabels[type],
          data: dataValues,
          borderColor: color.border,
          backgroundColor: color.bg,
          borderWidth: 2,
          fill: false,
          tension: 0.4, // 平滑曲线
          pointRadius: 0,
          pointHoverRadius: 6,
          pointHoverBackgroundColor: color.border,
          spanGaps: true // 跳过 null 值
        });

        // 显示时间段平均值（来自API）
        console.log(`Curve ${type} average:`, result.average, typeof result.average);
        if (result.average !== null && result.average !== undefined) {
          statsHtml.push(`
            <div class="curve-stat-item">
              <span class="curve-stat-dot" style="background: ${color.border}"></span>
              <span class="curve-stat-label">${curveLabels[type]}:</span>
              <span class="curve-stat-value">平均 ${Math.round(result.average).toLocaleString()}</span>
            </div>
          `);
        }
      });

      // 更新统计显示
      statsContainer.innerHTML = statsHtml.join('');

      const labels = Array.from({ length: 24 }, (_, i) => `${String(i).padStart(2, '0')}:00`);

      const ctx = document.getElementById('curve-chart').getContext('2d');

      if (!curveChart) {
        curveChart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false
            },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: '#888',
                  usePointStyle: true,
                  pointStyle: 'circle',
                  padding: 20
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                padding: 12,
                cornerRadius: 8,
                callbacks: {
                  label: function(context) {
                    const value = context.parsed.y;
                    if (value === null) return `${context.dataset.label}: 无数据`;
                    return `${context.dataset.label}: ${value.toLocaleString()}`;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: {
                  color: '#888',
                  maxRotation: 0,
                  callback: function(value, index) {
                    // 每3小时显示一个标签
                    return index % 3 === 0 ? this.getLabelForValue(value) : '';
                  }
                }
              },
              y: {
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { color: '#888' },
                beginAtZero: false
              }
            }
          }
        });
      } else {
        curveChart.data.labels = labels;
        curveChart.data.datasets = datasets;
        curveChart.update('none');
      }
    }

    // 加载时段排行
    async function loadHourlyRanking() {
      try {
        const res = await fetch('/api/analytics/hourly');
        const hourlyData = await res.json();

        if (!hourlyData || hourlyData.length === 0) {
          document.getElementById('hourly-ranking').innerHTML = `<div class="loading">${t('hourly.noData')}</div>`;
          return;
        }

        // 按平均值排序（降序）- API返回的字段是avgCount
        const sorted = [...hourlyData].sort((a, b) => b.avgCount - a.avgCount);
        const maxAvg = sorted[0].avgCount;

        // UTC时区对应的各国本地时间
        const getRegionalTimes = (utcHour) => {
          const regions = [];
          // 美西 (UTC-8)
          const usWest = (utcHour - 8 + 24) % 24;
          // 美东 (UTC-5)
          const usEast = (utcHour - 5 + 24) % 24;
          // 英国 (UTC+0)
          const uk = utcHour;
          // 澳大利亚悉尼 (UTC+11)
          const australia = (utcHour + 11) % 24;
          // 日本 (UTC+9)
          const japan = (utcHour + 9) % 24;

          const formatTime = (hour) => {
            if (hour >= 6 && hour < 12) return currentLang === 'zh' ? '上午' : 'Morning';
            if (hour >= 12 && hour < 18) return currentLang === 'zh' ? '下午' : 'Afternoon';
            if (hour >= 18 && hour < 22) return currentLang === 'zh' ? '晚间' : 'Evening';
            return currentLang === 'zh' ? '深夜' : 'Night';
          };

          regions.push({ flag: '🇺🇸', name: currentLang === 'zh' ? '美西' : 'US-W', hour: usWest, period: formatTime(usWest) });
          regions.push({ flag: '🇺🇸', name: currentLang === 'zh' ? '美东' : 'US-E', hour: usEast, period: formatTime(usEast) });
          regions.push({ flag: '🇬🇧', name: currentLang === 'zh' ? '英国' : 'UK', hour: uk, period: formatTime(uk) });
          regions.push({ flag: '🇦🇺', name: currentLang === 'zh' ? '澳洲' : 'AU', hour: australia, period: formatTime(australia) });
          regions.push({ flag: '🇯🇵', name: currentLang === 'zh' ? '日本' : 'JP', hour: japan, period: formatTime(japan) });

          return regions;
        };

        const rows = sorted.map((h, idx) => {
          const barWidth = (h.avgCount / maxAvg * 100).toFixed(1);
          const regions = getRegionalTimes(h.hour);
          const isTop3 = idx < 3;
          const isBottom3 = idx >= sorted.length - 3;
          // 默认隐藏中间行（只显示前3和后3）
          const isHidden = idx >= 3 && idx < sorted.length - 3;

          return `
            <div class="hourly-row${isHidden ? ' hidden' : ''}">
              <div class="hourly-rank ${isTop3 ? 'top3' : ''}">#${idx + 1}</div>
              <div class="hourly-time">
                ${String(h.hour).padStart(2, '0')}:00 UTC
                ${isTop3 ? `<span class="insight-tag">${t('hourly.peak')}</span>` : ''}
                ${isBottom3 ? `<span class="insight-tag low">${t('hourly.low')}</span>` : ''}
              </div>
              <div class="hourly-regions">
                ${regions.map(r => `<span class="hourly-region">${r.flag} ${r.name} ${r.hour}:00 ${r.period}</span>`).join('')}
              </div>
              <div class="hourly-avg">
                ${h.avgCount.toLocaleString()}
                <div class="hourly-bar-container">
                  <div class="hourly-bar" style="width: ${barWidth}%"></div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('hourly-ranking').innerHTML = `
          <div class="hourly-table">
            <div class="hourly-row header">
              <div>${currentLang === 'zh' ? '排名' : 'Rank'}</div>
              <div>${currentLang === 'zh' ? 'UTC时间' : 'UTC Time'}</div>
              <div>${currentLang === 'zh' ? '各地时间' : 'Local Times'}</div>
              <div>${currentLang === 'zh' ? '平均听众' : 'Avg Listeners'}</div>
            </div>
            ${rows}
          </div>
        `;
      } catch (e) {
        console.error('Failed to load hourly ranking:', e);
        document.getElementById('hourly-ranking').innerHTML = `<div class="loading">${t('hourly.noData')}</div>`;
      }
    }

    // 时段分析展开/折叠
    let hourlyExpanded = false;
    function toggleHourlyExpand() {
      hourlyExpanded = !hourlyExpanded;
      const table = document.querySelector('.hourly-table');
      const btn = document.getElementById('hourly-toggle');
      const text = document.getElementById('hourly-toggle-text');

      if (hourlyExpanded) {
        table.classList.add('expanded');
        btn.classList.add('expanded');
        text.textContent = currentLang === 'zh' ? '收起' : 'Collapse';
      } else {
        table.classList.remove('expanded');
        btn.classList.remove('expanded');
        text.textContent = currentLang === 'zh' ? '展开全部' : 'Show All';
      }
    }

    // 检查状态
    async function checkStatus() {
      try {
        const res = await fetch('/api/status');
        const status = await res.json();

        const badge = document.getElementById('status-badge');
        const alertDiv = document.getElementById('error-alert');

        if (status.errorMessage) {
          badge.innerHTML = `<span class="status-dot" style="background: #ef4444;"></span><span>${t('status.error')}</span>`;
          alertDiv.style.display = 'flex';
          alertDiv.className = 'alert';
          alertDiv.innerHTML = `
            <div class="alert-icon">🚨</div>
            <div class="alert-content">
              <div class="alert-title">${status.errorMessage}</div>
              <div class="alert-message">Last success: ${status.lastSuccess ? new Date(status.lastSuccess).toLocaleString() : 'Never'}</div>
            </div>
            <button class="alert-action" onclick="handleLogin()">${t('action.login')}</button>
          `;
        } else {
          badge.innerHTML = `<span class="status-dot"></span><span>${t('status.live')}</span>`;
          alertDiv.style.display = 'none';
        }
      } catch (e) {
        console.error('Failed to check status:', e);
      }
    }

    // 登录处理
    function handleLogin() {
      alert('Login feature - please implement based on your authentication method');
    }

    // 清空数据
    async function handleClearData() {
      const confirmed = confirm('⚠️ Warning: This will permanently delete all historical data!\n\nAre you sure you want to clear the database?\n\nRecommended: Download CSV backup first.');
      if (!confirmed) return;

      const doubleConfirm = confirm('Final confirmation: Do you really want to delete all data?\n\nThis action cannot be undone!');
      if (!doubleConfirm) return;

      try {
        const res = await fetch('/api/clear-data', { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          alert('✅ ' + data.message);
          await refresh();
        } else {
          alert('❌ Failed: ' + data.message);
        }
      } catch (e) {
        alert('❌ Request failed: ' + e.message);
      }
    }

    // ========== 每日数据表格 ==========
    let dailyDataOffset = 0;
    let dailyDataHasMore = true;
    let dailyDataLoading = false;
    const DAILY_DATA_LIMIT = 10;

    async function loadDailyData(append = false) {
      if (dailyDataLoading) return;
      if (append && !dailyDataHasMore) return;

      dailyDataLoading = true;

      try {
        if (!append) {
          dailyDataOffset = 0;
        }

        const res = await fetch(`/api/analytics/daily?limit=${DAILY_DATA_LIMIT}&offset=${dailyDataOffset}`);
        const result = await res.json();

        if (!result.data || result.data.length === 0) {
          if (!append) {
            document.getElementById('daily-data').innerHTML = `<div class="loading">${t('daily.noData')}</div>`;
          }
          dailyDataHasMore = false;
          updateLoadMoreButton();
          return;
        }

        dailyDataHasMore = result.hasMore;
        dailyDataOffset += result.data.length;

        const cards = result.data.map(d => `
          <div class="daily-card">
            <div class="daily-card-date">${d.date}</div>
            <div class="daily-card-stats">
              <div class="daily-card-stat">
                <span class="daily-card-label">${t('daily.avg')}</span>
                <span class="daily-card-value">${d.avgCount.toFixed(1)}</span>
              </div>
              <div class="daily-card-stat">
                <span class="daily-card-label">${t('daily.peak')}</span>
                <span class="daily-card-value">${d.maxCount.toLocaleString()}</span>
              </div>
              <div class="daily-card-stat">
                <span class="daily-card-label">${t('daily.streams')}</span>
                <span class="daily-card-value streams">${d.predictedStreams.toLocaleString()}</span>
              </div>
            </div>
          </div>
        `).join('');

        if (append) {
          const grid = document.querySelector('#daily-data .daily-grid');
          if (grid) {
            grid.insertAdjacentHTML('beforeend', cards);
          }
        } else {
          document.getElementById('daily-data').innerHTML = `
            <div class="daily-grid">
              ${cards}
            </div>
            <button id="load-more-btn" class="load-more-btn" onclick="loadMoreDailyData()">
              ${t('daily.loadMore')}
            </button>
          `;
        }

        updateLoadMoreButton();
      } catch (e) {
        console.error('Failed to load daily data:', e);
        if (!append) {
          document.getElementById('daily-data').innerHTML = `<div class="loading">${t('daily.noData')}</div>`;
        }
      } finally {
        dailyDataLoading = false;
      }
    }

    function loadMoreDailyData() {
      loadDailyData(true);
    }

    function updateLoadMoreButton() {
      const btn = document.getElementById('load-more-btn');
      if (btn) {
        if (!dailyDataHasMore) {
          btn.textContent = t('daily.noMore');
          btn.disabled = true;
        } else {
          btn.textContent = t('daily.loadMore');
          btn.disabled = false;
        }
      }
    }

    // ========== 邮件设置 ==========
    let currentEmailProvider = 'resend';

    async function openEmailSettings() {
      document.getElementById('email-modal').style.display = 'flex';
      await loadEmailConfig();
    }

    function closeEmailModal() {
      document.getElementById('email-modal').style.display = 'none';
    }

    function switchProvider(provider) {
      currentEmailProvider = provider;

      // 更新标签样式
      document.querySelectorAll('.provider-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.provider === provider);
      });

      // 切换配置面板
      document.getElementById('resend-config').style.display = provider === 'resend' ? 'block' : 'none';
      document.getElementById('smtp-config').style.display = provider === 'smtp' ? 'block' : 'none';
    }

    async function loadEmailConfig() {
      try {
        const res = await fetch('/api/email/config');
        const config = await res.json();

        document.getElementById('email-enabled').checked = config.enabled;
        document.getElementById('email-to').placeholder = config.to || 'your-email@example.com';

        // SMTP 配置
        document.getElementById('email-host').value = config.host || '';
        document.getElementById('email-port').value = config.port || 587;
        document.getElementById('email-secure').checked = config.secure;
        document.getElementById('email-user').placeholder = config.user || 'your-email@gmail.com';

        // 设置当前提供商
        const provider = config.provider || 'resend';
        switchProvider(provider);

        // 加载定时报告设置
        const reports = config.reports || {};
        document.getElementById('report-daily').checked = reports.daily || false;
        document.getElementById('report-weekly').checked = reports.weekly || false;
        document.getElementById('report-monthly').checked = reports.monthly || false;

        // 更新状态显示
        const statusEl = document.getElementById('email-status');
        const isResend = provider === 'resend';
        const hasCredentials = isResend ? config.hasResendApiKey : config.hasPassword;

        if (config.enabled && hasCredentials) {
          statusEl.className = 'email-status enabled';
          const providerName = isResend ? 'Resend' : 'SMTP';
          statusEl.innerHTML = `✅ ${currentLang === 'zh' ? `已启用 (${providerName})` : `Enabled (${providerName})`}${config.lastEmailSent ? ` · ${currentLang === 'zh' ? '最后发送' : 'Last sent'}: ${new Date(config.lastEmailSent).toLocaleString()}` : ''}`;
        } else if (config.enabled && !hasCredentials) {
          statusEl.className = 'email-status disabled';
          const msg = isResend ? 'API Key' : '密码';
          statusEl.innerHTML = `⚠️ ${currentLang === 'zh' ? `已启用但未配置${msg}` : `Enabled but no ${isResend ? 'API key' : 'password'}`}`;
        } else {
          statusEl.className = 'email-status disabled';
          statusEl.innerHTML = `❌ ${currentLang === 'zh' ? '邮件通知未启用' : 'Email notifications disabled'}`;
        }
      } catch (e) {
        console.error('Failed to load email config:', e);
        document.getElementById('email-status').innerHTML = `❌ ${currentLang === 'zh' ? '加载配置失败' : 'Failed to load config'}`;
      }
    }

    async function saveEmailSettings() {
      try {
        const config = {
          enabled: document.getElementById('email-enabled').checked,
          provider: currentEmailProvider,
          to: document.getElementById('email-to').value || undefined,
          // 定时报告设置
          reports: {
            daily: document.getElementById('report-daily').checked,
            weekly: document.getElementById('report-weekly').checked,
            monthly: document.getElementById('report-monthly').checked
          }
        };

        if (currentEmailProvider === 'resend') {
          const apiKey = document.getElementById('resend-api-key').value;
          if (apiKey) {
            config.resendApiKey = apiKey;
          }
        } else {
          config.host = document.getElementById('email-host').value || undefined;
          config.port = document.getElementById('email-port').value || undefined;
          config.secure = document.getElementById('email-secure').checked;
          config.user = document.getElementById('email-user').value || undefined;
          const pass = document.getElementById('email-pass').value;
          if (pass) {
            config.pass = pass;
          }
        }

        const res = await fetch('/api/email/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await res.json();

        if (result.success) {
          alert(t('email.saveSuccess') + '\n\n' + result.message);
          document.getElementById('resend-api-key').value = '';
          document.getElementById('email-pass').value = '';
          await loadEmailConfig();
        } else {
          alert(t('email.testFail') + ': ' + result.message);
        }
      } catch (e) {
        alert(t('email.testFail') + ': ' + e.message);
      }
    }

    async function testEmail() {
      try {
        const res = await fetch('/api/email/test', { method: 'POST' });
        const result = await res.json();

        if (result.success) {
          alert(t('email.testSuccess'));
        } else {
          alert(t('email.testFail') + ': ' + result.message);
        }
      } catch (e) {
        alert(t('email.testFail') + ': ' + e.message);
      }
    }

    async function testReport(type) {
      const typeNames = { daily: '每日', weekly: '每周', monthly: '每月' };
      if (!confirm(`确定发送${typeNames[type]}报告预览到您的邮箱？`)) return;

      try {
        const res = await fetch('/api/email/report/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type })
        });
        const result = await res.json();

        if (result.success) {
          alert(`${typeNames[type]}报告已发送，请检查邮箱`);
        } else {
          alert('发送失败: ' + result.message);
        }
      } catch (e) {
        alert('发送失败: ' + e.message);
      }
    }

    // 刷新所有数据
    async function refresh() {
      await Promise.all([
        loadHeroSection(),
        loadMainChart(),
        updateCurveChart(),
        loadHourlyRanking(),
        checkStatus()
      ]);
    }

    // 恢复曲线选择
    function restoreCurveSelection() {
      const saved = localStorage.getItem('curveSelection');
      const types = ['today', 'yesterday', 'thisWeek', 'lastWeek', 'last7days', 'last28days', 'thisMonth', 'lastMonth', 'thisYear', 'lastYear', 'all'];

      if (saved) {
        try {
          const selectedTypes = JSON.parse(saved);
          types.forEach(t => {
            const checkbox = document.getElementById(`curve-${t}`);
            if (checkbox) {
              checkbox.checked = selectedTypes.includes(t);
            }
          });
        } catch (e) {
          // 解析失败，使用默认值
          document.getElementById('curve-yesterday').checked = true;
          document.getElementById('curve-last7days').checked = true;
        }
      } else {
        // 没有保存的选择，使用默认值
        document.getElementById('curve-yesterday').checked = true;
        document.getElementById('curve-last7days').checked = true;
      }
    }

    // 初始化
    async function init() {
      restoreCurveSelection();
      await refresh();
      // 每日数据只在初始化时加载一次，不需要频繁刷新
      await loadDailyData();
    }

    // 自动刷新（每5秒）
    init();
    setInterval(refresh, 5000);
  </script>

</body>
</html>
