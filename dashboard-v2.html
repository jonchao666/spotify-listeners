<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify å®æ—¶åˆ†æä»ªè¡¨ç›˜</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --spotify-green: #1DB954;
      --bg-primary: #0a0a0a;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #252525;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-tertiary: rgba(255, 255, 255, 0.4);
      --border-color: rgba(255, 255, 255, 0.08);
      --success: #1DB954;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* é¡¶éƒ¨å¯¼èˆªæ  */
    .navbar {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 16px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
    }

    .navbar-content {
      max-width: 1800px;
      margin: 0 auto;
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand-logo {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, var(--spotify-green), #1ed760);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(29, 185, 84, 0.3);
    }

    .brand-logo svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    .brand-info h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .brand-info p {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    .navbar-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .lang-switch {
      display: flex;
      gap: 4px;
      background: var(--bg-tertiary);
      padding: 4px;
      border-radius: 8px;
    }

    .lang-btn {
      padding: 6px 12px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .lang-btn:hover {
      color: var(--text-primary);
    }

    .lang-btn.active {
      background: var(--spotify-green);
      color: white;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(29, 185, 84, 0.1);
      border: 1px solid rgba(29, 185, 84, 0.2);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--spotify-green);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: var(--spotify-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(29, 185, 84, 0.7); }
      50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(29, 185, 84, 0); }
    }

    /* ä¸»å®¹å™¨ */
    .container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 32px;
    }

    /* åˆ†åŒºæ ‡é¢˜ */
    .section-header {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .section-subtitle {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    /* Hero åŒºåŸŸ */
    .hero-section {
      margin-bottom: 32px;
    }

    .hero-grid {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap: 20px;
    }

    .hero-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 32px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .hero-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      border-color: rgba(29, 185, 84, 0.3);
    }

    .hero-card.primary {
      background: linear-gradient(135deg, #1DB954, #1ed760);
      grid-column: 1;
    }

    .hero-card.primary::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255,255,255,0.15), transparent);
      border-radius: 50%;
    }

    .hero-label {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      opacity: 0.8;
      margin-bottom: 12px;
    }

    .hero-value {
      font-size: 56px;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 16px;
      letter-spacing: -2px;
    }

    .hero-card.primary .hero-value {
      color: white;
    }

    .hero-trend {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
    }

    .trend-up {
      color: var(--success);
    }

    .trend-down {
      color: var(--danger);
    }

    /* ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ */
    .stats-section {
      margin-bottom: 32px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--spotify-green), #1ed760);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .stat-card:hover::before {
      transform: scaleX(1);
    }

    .stat-card:hover {
      background: var(--bg-tertiary);
      border-color: rgba(29, 185, 84, 0.2);
    }

    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .stat-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-icon {
      width: 32px;
      height: 32px;
      background: rgba(29, 185, 84, 0.15);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -1px;
    }

    .stat-change {
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--danger);
    }

    .stat-subtitle {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    /* å›¾è¡¨åŒºåŸŸ */
    .chart-section {
      margin-bottom: 32px;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 24px;
    }

    .chart-card.full {
      grid-column: 1 / -1;
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .chart-subtitle {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .time-selector {
      display: flex;
      gap: 6px;
      background: var(--bg-tertiary);
      padding: 4px;
      border-radius: 10px;
    }

    .time-btn {
      padding: 6px 14px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .time-btn:hover {
      color: var(--text-primary);
    }

    .time-btn.active {
      background: var(--spotify-green);
      color: white;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    .chart-container.tall {
      height: 400px;
    }

    /* å¯¹æ¯”è¡¨æ ¼ */
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
    }

    .comparison-table th,
    .comparison-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .comparison-table th {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .comparison-table td {
      font-size: 14px;
      font-weight: 500;
    }

    .comparison-table tr:hover {
      background: var(--bg-tertiary);
    }

    .comparison-value {
      font-size: 18px;
      font-weight: 700;
    }

    /* çƒ­åŠ›å›¾ */
    .heatmap {
      display: grid;
      grid-template-columns: auto repeat(24, 1fr);
      gap: 4px;
      margin-top: 16px;
    }

    .heatmap-label {
      font-size: 11px;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
    }

    .heatmap-hour {
      font-size: 10px;
      color: var(--text-tertiary);
      text-align: center;
      padding: 4px;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      background: var(--bg-tertiary);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .heatmap-cell:hover {
      transform: scale(1.3);
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .heatmap-cell.level-0 { background: rgba(29, 185, 84, 0.1); }
    .heatmap-cell.level-1 { background: rgba(29, 185, 84, 0.3); }
    .heatmap-cell.level-2 { background: rgba(29, 185, 84, 0.5); }
    .heatmap-cell.level-3 { background: rgba(29, 185, 84, 0.7); }
    .heatmap-cell.level-4 { background: rgba(29, 185, 84, 0.9); }

    /* æ“ä½œæŒ‰é’® */
    .actions-section {
      margin-bottom: 32px;
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .action-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--spotify-green);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(29, 185, 84, 0.2);
    }

    .action-btn.danger {
      border-color: rgba(239, 68, 68, 0.3);
    }

    .action-btn.danger:hover {
      border-color: var(--danger);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.2);
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    /* é¡µè„š */
    .footer {
      text-align: center;
      padding: 32px;
      color: var(--text-tertiary);
      font-size: 13px;
      border-top: 1px solid var(--border-color);
      margin-top: 48px;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      flex-direction: column;
      gap: 12px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(29, 185, 84, 0.1);
      border-top-color: var(--spotify-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* é”™è¯¯æç¤º */
    .alert {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .alert-icon {
      font-size: 28px;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 700;
      color: var(--danger);
      margin-bottom: 4px;
    }

    .alert-message {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .alert-action {
      padding: 10px 20px;
      background: var(--danger);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .alert-action:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    /* å“åº”å¼ */
    @media (max-width: 1400px) {
      .hero-grid {
        grid-template-columns: 1fr 1fr;
      }

      .chart-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .navbar-content {
        padding: 0 20px;
        flex-wrap: wrap;
        gap: 12px;
      }

      .hero-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .hero-value {
        font-size: 40px;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- å¯¼èˆªæ  -->
  <nav class="navbar">
    <div class="navbar-content">
      <div class="brand">
        <div class="brand-logo">
          <svg viewBox="0 0 24 24"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
        </div>
        <div class="brand-info">
          <h1 data-i18n="app.title">å®æ—¶åˆ†æ</h1>
          <p data-i18n="app.subtitle">Spotify å¬ä¼—è¿½è¸ªä»ªè¡¨ç›˜</p>
        </div>
      </div>
      <div class="navbar-actions">
        <div class="lang-switch">
          <button class="lang-btn active" data-lang="zh">ä¸­æ–‡</button>
          <button class="lang-btn" data-lang="en">English</button>
        </div>
        <div class="status-badge" id="status-badge">
          <span class="status-dot"></span>
          <span data-i18n="status.live">å®æ—¶ç›‘æ§</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- ä¸»å®¹å™¨ -->
  <div class="container">

    <!-- é”™è¯¯æç¤º -->
    <div id="error-alert" style="display: none;"></div>

    <!-- Hero åŒºåŸŸ -->
    <section class="hero-section">
      <div class="hero-grid" id="hero-section">
        <div class="loading">
          <div class="spinner"></div>
          <p style="color: var(--text-secondary);" data-i18n="loading">åŠ è½½ä¸­...</p>
        </div>
      </div>
    </section>

    <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
    <section class="stats-section">
      <div class="section-header">
        <div>
          <div class="section-title" data-i18n="section.metrics">æ ¸å¿ƒæŒ‡æ ‡</div>
          <div class="section-subtitle" data-i18n="section.metricsDesc">å…³é”®æ€§èƒ½æŒ‡æ ‡æ¦‚è§ˆ</div>
        </div>
      </div>
      <div class="stats-grid" id="stats-grid"></div>
    </section>

    <!-- è¶‹åŠ¿åˆ†æ -->
    <section class="chart-section">
      <div class="section-header">
        <div>
          <div class="section-title" data-i18n="section.trends">è¶‹åŠ¿åˆ†æ</div>
          <div class="section-subtitle" data-i18n="section.trendsDesc">å¬ä¼—æ•°é‡å˜åŒ–è¶‹åŠ¿</div>
        </div>
      </div>
      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title" data-i18n="chart.timeline">æ—¶é—´åºåˆ—</div>
              <div class="chart-subtitle" id="chart-subtitle" data-i18n="chart.timelineDesc">å®æ—¶å¬ä¼—æ•°é‡å˜åŒ–</div>
            </div>
            <div class="time-selector">
              <button class="time-btn active" data-range="60" data-i18n="time.1h">1å°æ—¶</button>
              <button class="time-btn" data-range="360" data-i18n="time.6h">6å°æ—¶</button>
              <button class="time-btn" data-range="720" data-i18n="time.12h">12å°æ—¶</button>
              <button class="time-btn" data-range="1440" data-i18n="time.24h">24å°æ—¶</button>
              <button class="time-btn" data-range="0" data-i18n="time.all">å…¨éƒ¨</button>
            </div>
          </div>
          <div class="chart-container tall">
            <canvas id="main-chart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title" data-i18n="chart.distribution">åˆ†å¸ƒåˆ†æ</div>
              <div class="chart-subtitle" data-i18n="chart.distributionDesc">æ•°æ®åˆ†å¸ƒæƒ…å†µ</div>
            </div>
          </div>
          <div class="chart-container tall">
            <canvas id="distribution-chart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title" data-i18n="chart.hourly">æ—¶æ®µåˆ†æ</div>
              <div class="chart-subtitle" data-i18n="chart.hourlyDesc">æ¯å°æ—¶å¹³å‡å¬ä¼—æ•°</div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="hourly-chart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title" data-i18n="chart.growth">å¢é•¿è¶‹åŠ¿</div>
              <div class="chart-subtitle" data-i18n="chart.growthDesc">åŒæ¯”ç¯æ¯”å¢é•¿ç‡</div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="growth-chart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- æ•°æ®æ´å¯Ÿ -->
    <section class="chart-section">
      <div class="section-header">
        <div>
          <div class="section-title" data-i18n="section.insights">æ•°æ®æ´å¯Ÿ</div>
          <div class="section-subtitle" data-i18n="section.insightsDesc">æ·±åº¦æ•°æ®åˆ†æä¸å¯¹æ¯”</div>
        </div>
      </div>
      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title" data-i18n="chart.comparison">æ—¶æ®µå¯¹æ¯”</div>
              <div class="chart-subtitle" data-i18n="chart.comparisonDesc">ä¸åŒæ—¶é—´æ®µæ•°æ®å¯¹æ¯”</div>
            </div>
          </div>
          <table class="comparison-table" id="comparison-table"></table>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title" data-i18n="chart.statistics">ç»Ÿè®¡æŒ‡æ ‡</div>
              <div class="chart-subtitle" data-i18n="chart.statisticsDesc">è¯¦ç»†ç»Ÿè®¡æ•°æ®</div>
            </div>
          </div>
          <table class="comparison-table" id="statistics-table"></table>
        </div>
      </div>
    </section>

    <!-- æ“ä½œæŒ‰é’® -->
    <section class="actions-section">
      <div class="section-header">
        <div>
          <div class="section-title" data-i18n="section.actions">å¿«æ·æ“ä½œ</div>
        </div>
      </div>
      <div class="actions-grid">
        <a href="/api/stats" target="_blank" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
          <span data-i18n="action.stats">ç»Ÿè®¡ API</span>
        </a>
        <a href="/api/data?limit=100" target="_blank" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/></svg>
          <span data-i18n="action.recent">æœ€è¿‘æ•°æ®</span>
        </a>
        <a href="/api/download/csv" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
          <span data-i18n="action.export">å¯¼å‡º CSV</span>
        </a>
        <button onclick="handleLogin()" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
          <span data-i18n="action.login">é‡æ–°ç™»å½•</span>
        </button>
        <button onclick="handleClearData()" class="action-btn danger">
          <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          <span data-i18n="action.clear">æ¸…ç©ºæ•°æ®</span>
        </button>
      </div>
    </section>

    <!-- é¡µè„š -->
    <footer class="footer" data-i18n="footer">
      Spotify å®æ—¶åˆ†æ Â· Powered by Claude Code
    </footer>
  </div>

  <script>
    // ========== å›½é™…åŒ– ==========
    const i18n = {
      zh: {
        'app.title': 'å®æ—¶åˆ†æ',
        'app.subtitle': 'Spotify å¬ä¼—è¿½è¸ªä»ªè¡¨ç›˜',
        'status.live': 'å®æ—¶ç›‘æ§',
        'status.error': 'çŠ¶æ€å¼‚å¸¸',
        'loading': 'åŠ è½½ä¸­...',
        'section.metrics': 'æ ¸å¿ƒæŒ‡æ ‡',
        'section.metricsDesc': 'å…³é”®æ€§èƒ½æŒ‡æ ‡æ¦‚è§ˆ',
        'section.trends': 'è¶‹åŠ¿åˆ†æ',
        'section.trendsDesc': 'å¬ä¼—æ•°é‡å˜åŒ–è¶‹åŠ¿',
        'section.insights': 'æ•°æ®æ´å¯Ÿ',
        'section.insightsDesc': 'æ·±åº¦æ•°æ®åˆ†æä¸å¯¹æ¯”',
        'section.actions': 'å¿«æ·æ“ä½œ',
        'chart.timeline': 'æ—¶é—´åºåˆ—',
        'chart.timelineDesc': 'å®æ—¶å¬ä¼—æ•°é‡å˜åŒ–',
        'chart.distribution': 'åˆ†å¸ƒåˆ†æ',
        'chart.distributionDesc': 'æ•°æ®åˆ†å¸ƒæƒ…å†µ',
        'chart.hourly': 'æ—¶æ®µåˆ†æ',
        'chart.hourlyDesc': 'æ¯å°æ—¶å¹³å‡å¬ä¼—æ•°',
        'chart.growth': 'å¢é•¿è¶‹åŠ¿',
        'chart.growthDesc': 'åŒæ¯”ç¯æ¯”å¢é•¿ç‡',
        'chart.comparison': 'æ—¶æ®µå¯¹æ¯”',
        'chart.comparisonDesc': 'ä¸åŒæ—¶é—´æ®µæ•°æ®å¯¹æ¯”',
        'chart.statistics': 'ç»Ÿè®¡æŒ‡æ ‡',
        'chart.statisticsDesc': 'è¯¦ç»†ç»Ÿè®¡æ•°æ®',
        'time.1h': '1å°æ—¶',
        'time.6h': '6å°æ—¶',
        'time.12h': '12å°æ—¶',
        'time.24h': '24å°æ—¶',
        'time.all': 'å…¨éƒ¨',
        'action.stats': 'ç»Ÿè®¡ API',
        'action.recent': 'æœ€è¿‘æ•°æ®',
        'action.export': 'å¯¼å‡º CSV',
        'action.login': 'é‡æ–°ç™»å½•',
        'action.clear': 'æ¸…ç©ºæ•°æ®',
        'footer': 'Spotify å®æ—¶åˆ†æ Â· Powered by Claude Code',
        'hero.current': 'å½“å‰å¬ä¼—',
        'hero.peak': 'ä»Šæ—¥å³°å€¼',
        'hero.total': 'æ€»è®°å½•',
        'hero.average': 'å¹³å‡å€¼',
        'hero.vs': 'å¯¹æ¯”ä¸Šå°æ—¶',
        'hero.allTime': 'å†å²æœ€é«˜',
        'hero.dataPoints': 'æ•°æ®ç‚¹',
        'hero.meanValue': 'å‡å€¼',
        'metric.average': 'å¹³å‡å€¼',
        'metric.median': 'ä¸­ä½æ•°',
        'metric.stdDev': 'æ ‡å‡†å·®',
        'metric.variance': 'æ–¹å·®',
        'metric.range': 'æå·®',
        'metric.minimum': 'æœ€å°å€¼',
        'metric.maximum': 'æœ€å¤§å€¼',
        'metric.total': 'æ€»è®°å½•',
        'metric.growth1h': '1å°æ—¶å¢é•¿',
        'metric.growth6h': '6å°æ—¶å¢é•¿',
        'metric.volatility': 'æ³¢åŠ¨ç‡',
        'metric.stability': 'ç¨³å®šæ€§',
        'comparison.current': 'å½“å‰',
        'comparison.1hourAgo': '1å°æ—¶å‰',
        'comparison.6hourAgo': '6å°æ—¶å‰',
        'comparison.12hourAgo': '12å°æ—¶å‰',
        'comparison.24hourAgo': '24å°æ—¶å‰',
        'comparison.change': 'å˜åŒ–',
        'stat.mean': 'å‡å€¼',
        'stat.median': 'ä¸­ä½æ•°',
        'stat.mode': 'ä¼—æ•°',
        'stat.stdDev': 'æ ‡å‡†å·®',
        'stat.variance': 'æ–¹å·®',
        'stat.cv': 'å˜å¼‚ç³»æ•°',
        'stat.range': 'æå·®',
        'stat.iqr': 'å››åˆ†ä½è·',
        'listeners': 'å¬ä¼—',
        'na': 'æš‚æ— æ•°æ®'
      },
      en: {
        'app.title': 'Real-Time Analytics',
        'app.subtitle': 'Spotify Listener Tracking Dashboard',
        'status.live': 'Live Monitoring',
        'status.error': 'Error',
        'loading': 'Loading...',
        'section.metrics': 'Key Metrics',
        'section.metricsDesc': 'Core performance indicators overview',
        'section.trends': 'Trend Analysis',
        'section.trendsDesc': 'Listener count trends over time',
        'section.insights': 'Data Insights',
        'section.insightsDesc': 'In-depth data analysis and comparison',
        'section.actions': 'Quick Actions',
        'chart.timeline': 'Timeline',
        'chart.timelineDesc': 'Real-time listener count changes',
        'chart.distribution': 'Distribution',
        'chart.distributionDesc': 'Data distribution analysis',
        'chart.hourly': 'Hourly Analysis',
        'chart.hourlyDesc': 'Average listeners per hour',
        'chart.growth': 'Growth Trend',
        'chart.growthDesc': 'YoY and MoM growth rate',
        'chart.comparison': 'Time Comparison',
        'chart.comparisonDesc': 'Data comparison across periods',
        'chart.statistics': 'Statistics',
        'chart.statisticsDesc': 'Detailed statistical data',
        'time.1h': '1 Hour',
        'time.6h': '6 Hours',
        'time.12h': '12 Hours',
        'time.24h': '24 Hours',
        'time.all': 'All',
        'action.stats': 'Stats API',
        'action.recent': 'Recent Data',
        'action.export': 'Export CSV',
        'action.login': 'Re-login',
        'action.clear': 'Clear Data',
        'footer': 'Spotify Real-Time Analytics Â· Powered by Claude Code',
        'hero.current': 'Current Listeners',
        'hero.peak': 'Peak Today',
        'hero.total': 'Total Records',
        'hero.average': 'Average',
        'hero.vs': 'vs last hour',
        'hero.allTime': 'All-time high',
        'hero.dataPoints': 'data points',
        'hero.meanValue': 'mean',
        'metric.average': 'Average',
        'metric.median': 'Median',
        'metric.stdDev': 'Std Dev',
        'metric.variance': 'Variance',
        'metric.range': 'Range',
        'metric.minimum': 'Minimum',
        'metric.maximum': 'Maximum',
        'metric.total': 'Total Records',
        'metric.growth1h': '1h Growth',
        'metric.growth6h': '6h Growth',
        'metric.volatility': 'Volatility',
        'metric.stability': 'Stability',
        'comparison.current': 'Current',
        'comparison.1hourAgo': '1 Hour Ago',
        'comparison.6hourAgo': '6 Hours Ago',
        'comparison.12hourAgo': '12 Hours Ago',
        'comparison.24hourAgo': '24 Hours Ago',
        'comparison.change': 'Change',
        'stat.mean': 'Mean',
        'stat.median': 'Median',
        'stat.mode': 'Mode',
        'stat.stdDev': 'Std Dev',
        'stat.variance': 'Variance',
        'stat.cv': 'CV',
        'stat.range': 'Range',
        'stat.iqr': 'IQR',
        'listeners': 'listeners',
        'na': 'N/A'
      }
    };

    let currentLang = 'zh';

    function t(key) {
      return i18n[currentLang][key] || key;
    }

    function updateLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;

      // æ›´æ–°æ‰€æœ‰å¸¦ data-i18n çš„å…ƒç´ 
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });

      // æ›´æ–°è¯­è¨€æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      // é‡æ–°åŠ è½½æ•°æ®ä»¥æ›´æ–°æ–‡æœ¬
      refresh();
    }

    // è¯­è¨€åˆ‡æ¢äº‹ä»¶
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        updateLanguage(btn.dataset.lang);
      });
    });

    // ========== å›¾è¡¨å’Œæ•°æ® ==========
    let mainChart, hourlyChart, distributionChart, growthChart;
    let currentRange = 60;
    let allData = [];

    // æ—¶é—´èŒƒå›´é€‰æ‹©
    document.querySelectorAll('.time-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentRange = parseInt(btn.dataset.range);
        loadMainChart();
      });
    });

    // è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
    function calculateStats(values) {
      if (!values || values.length === 0) return null;

      const sorted = [...values].sort((a, b) => a - b);
      const len = values.length;
      const sum = values.reduce((a, b) => a + b, 0);
      const mean = sum / len;

      // ä¸­ä½æ•°
      const median = len % 2 === 0
        ? (sorted[len / 2 - 1] + sorted[len / 2]) / 2
        : sorted[Math.floor(len / 2)];

      // ä¼—æ•°
      const freq = {};
      values.forEach(v => freq[v] = (freq[v] || 0) + 1);
      const mode = Object.keys(freq).reduce((a, b) => freq[a] > freq[b] ? a : b);

      // æ–¹å·®å’Œæ ‡å‡†å·®
      const variance = values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / len;
      const stdDev = Math.sqrt(variance);

      // å˜å¼‚ç³»æ•°
      const cv = mean > 0 ? (stdDev / mean * 100) : 0;

      // å››åˆ†ä½è·
      const q1 = sorted[Math.floor(len * 0.25)];
      const q3 = sorted[Math.floor(len * 0.75)];
      const iqr = q3 - q1;

      return {
        mean: Math.round(mean),
        median: Math.round(median),
        mode: parseInt(mode),
        min: Math.min(...values),
        max: Math.max(...values),
        range: Math.max(...values) - Math.min(...values),
        variance: Math.round(variance),
        stdDev: Math.round(stdDev),
        cv: cv.toFixed(1),
        q1, q3, iqr
      };
    }

    // åŠ è½½HeroåŒºåŸŸ
    async function loadHero() {
      try {
        const res = await fetch('/api/stats');
        const stats = await res.json();

        if (!stats || stats.totalRecords === 0) {
          document.getElementById('hero-section').innerHTML = `<div class="loading">${t('na')}</div>`;
          return;
        }

        // è®¡ç®—è¶‹åŠ¿
        const recentData = allData.slice(-12);
        const olderData = allData.slice(-24, -12);
        const recentAvg = recentData.reduce((s, d) => s + d.listenerCount, 0) / Math.max(recentData.length, 1);
        const olderAvg = olderData.reduce((s, d) => s + d.listenerCount, 0) / Math.max(olderData.length, 1);
        const trendPercent = olderAvg > 0 ? ((recentAvg - olderAvg) / olderAvg * 100).toFixed(1) : 0;
        const isUp = trendPercent > 0;

        document.getElementById('hero-section').innerHTML = `
          <div class="hero-card primary">
            <div class="hero-label">${t('hero.current')}</div>
            <div class="hero-value">${stats.latestCount.toLocaleString()}</div>
            <div class="hero-trend ${isUp ? 'trend-up' : 'trend-down'}">
              <span>${isUp ? 'â†—' : 'â†˜'}</span>
              <span>${Math.abs(trendPercent)}% ${t('hero.vs')}</span>
            </div>
          </div>

          <div class="hero-card">
            <div class="hero-label">${t('hero.peak')}</div>
            <div class="hero-value">${stats.maxCount.toLocaleString()}</div>
            <div class="hero-trend" style="color: var(--text-tertiary);">
              ${t('hero.allTime')}
            </div>
          </div>

          <div class="hero-card">
            <div class="hero-label">${t('hero.total')}</div>
            <div class="hero-value">${(stats.totalRecords / 1000).toFixed(1)}k</div>
            <div class="hero-trend" style="color: var(--text-tertiary);">
              ${t('hero.dataPoints')}
            </div>
          </div>

          <div class="hero-card">
            <div class="hero-label">${t('hero.average')}</div>
            <div class="hero-value">${stats.avgCount.toLocaleString()}</div>
            <div class="hero-trend" style="color: var(--text-tertiary);">
              ${t('hero.meanValue')}
            </div>
          </div>
        `;
      } catch (e) {
        console.error('Failed to load hero:', e);
      }
    }

    // åŠ è½½ç»Ÿè®¡å¡ç‰‡
    async function loadStats() {
      try {
        const res = await fetch('/api/stats');
        const stats = await res.json();

        if (!stats || stats.totalRecords === 0 || allData.length === 0) return;

        const values = allData.map(d => d.listenerCount);
        const calcStats = calculateStats(values);

        // è®¡ç®—å¢é•¿ç‡
        const data1h = allData.slice(-12);
        const data6h = allData.slice(-72);
        const avg1h = data1h.reduce((s, d) => s + d.listenerCount, 0) / Math.max(data1h.length, 1);
        const avg6h = data6h.reduce((s, d) => s + d.listenerCount, 0) / Math.max(data6h.length, 1);
        const current = stats.latestCount;

        const growth1h = avg1h > 0 ? ((current - avg1h) / avg1h * 100).toFixed(1) : 0;
        const growth6h = avg6h > 0 ? ((current - avg6h) / avg6h * 100).toFixed(1) : 0;

        const volatility = calcStats.cv;
        const stability = (100 - parseFloat(volatility)).toFixed(1);

        document.getElementById('stats-grid').innerHTML = `
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-label">${t('metric.average')}</div>
              <div class="stat-icon">ğŸ“Š</div>
            </div>
            <div class="stat-value">${calcStats.mean.toLocaleString()}</div>
            <div class="stat-subtitle">${t('metric.average')}</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-label">${t('metric.median')}</div>
              <div class="stat-icon">ğŸ“ˆ</div>
            </div>
            <div class="stat-value">${calcStats.median.toLocaleString()}</div>
            <div class="stat-subtitle">${t('metric.median')}</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-label">${t('metric.stdDev')}</div>
              <div class="stat-icon">ğŸ“‰</div>
            </div>
            <div class="stat-value">${calcStats.stdDev.toLocaleString()}</div>
            <div class="stat-subtitle">${t('metric.stdDev')}</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-label">${t('metric.range')}</div>
              <div class="stat-icon">ğŸ“</div>
            </div>
            <div class="stat-value">${calcStats.range.toLocaleString()}</div>
            <div class="stat-subtitle">${t('metric.maximum')} - ${t('metric.minimum')}</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-label">${t('metric.growth1h')}</div>
              <div class="stat-icon">âš¡</div>
            </div>
            <div class="stat-value">${Math.abs(growth1h)}%</div>
            <div class="stat-change ${parseFloat(growth1h) >= 0 ? 'positive' : 'negative'}">
              ${parseFloat(growth1h) >= 0 ? 'â†—' : 'â†˜'} ${Math.abs(growth1h)}%
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-label">${t('metric.growth6h')}</div>
              <div class="stat-icon">ğŸš€</div>
            </div>
            <div class="stat-value">${Math.abs(growth6h)}%</div>
            <div class="stat-change ${parseFloat(growth6h) >= 0 ? 'positive' : 'negative'}">
              ${parseFloat(growth6h) >= 0 ? 'â†—' : 'â†˜'} ${Math.abs(growth6h)}%
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-label">${t('metric.volatility')}</div>
              <div class="stat-icon">ğŸŒŠ</div>
            </div>
            <div class="stat-value">${volatility}%</div>
            <div class="stat-subtitle">${t('metric.volatility')}</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-label">${t('metric.stability')}</div>
              <div class="stat-icon">ğŸ›¡ï¸</div>
            </div>
            <div class="stat-value">${stability}%</div>
            <div class="stat-subtitle">${t('metric.stability')}</div>
          </div>
        `;
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }

    // åŠ è½½ä¸»å›¾è¡¨
    async function loadMainChart() {
      try {
        const limit = currentRange === 0 ? 10000 : currentRange;
        const res = await fetch('/api/data?limit=' + limit);
        allData = await res.json();

        if (allData.length === 0) return;

        const labels = allData.map(d => {
          const date = new Date(d.timestamp);
          return currentRange > 720 || currentRange === 0
            ? date.toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US', {month:'short', day:'numeric', hour:'numeric', minute:'numeric'})
            : date.toLocaleTimeString(currentLang === 'zh' ? 'zh-CN' : 'en-US', {hour: '2-digit', minute: '2-digit'});
        });
        const values = allData.map(d => d.listenerCount);

        const ctx = document.getElementById('main-chart').getContext('2d');

        if (!mainChart) {
          mainChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                data: values,
                borderColor: '#1DB954',
                borderWidth: 3,
                backgroundColor: (context) => {
                  const ctx = context.chart.ctx;
                  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                  gradient.addColorStop(0, 'rgba(29, 185, 84, 0.4)');
                  gradient.addColorStop(1, 'rgba(29, 185, 84, 0)');
                  return gradient;
                },
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 8,
                pointHoverBackgroundColor: '#1DB954',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 3
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { intersect: false, mode: 'index' },
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.9)',
                  titleColor: '#fff',
                  bodyColor: '#1DB954',
                  titleFont: { size: 13, weight: '600' },
                  bodyFont: { size: 16, weight: '700' },
                  padding: 12,
                  displayColors: false,
                  callbacks: {
                    label: ctx => ctx.parsed.y.toLocaleString() + ' ' + t('listeners')
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  grid: { color: 'rgba(255, 255, 255, 0.05)' },
                  ticks: { color: 'rgba(255, 255, 255, 0.5)' }
                },
                x: {
                  grid: { display: false },
                  ticks: { color: 'rgba(255, 255, 255, 0.5)', maxTicksLimit: 12 }
                }
              }
            }
          });
        } else {
          mainChart.data.labels = labels;
          mainChart.data.datasets[0].data = values;
          mainChart.update('none');
        }

        loadHero();
        loadStats();
        loadDistributionChart();
        loadGrowthChart();
        loadComparisonTable();
        loadStatisticsTable();
      } catch (e) {
        console.error('Failed to load main chart:', e);
      }
    }

    // åŠ è½½åˆ†å¸ƒå›¾è¡¨
    function loadDistributionChart() {
      if (allData.length === 0) return;

      const values = allData.map(d => d.listenerCount);
      const min = Math.min(...values);
      const max = Math.max(...values);
      const bucketCount = 10;
      const bucketSize = (max - min) / bucketCount;

      const buckets = new Array(bucketCount).fill(0);
      values.forEach(v => {
        const index = Math.min(Math.floor((v - min) / bucketSize), bucketCount - 1);
        buckets[index]++;
      });

      const labels = buckets.map((_, i) => {
        const start = Math.round(min + i * bucketSize);
        const end = Math.round(min + (i + 1) * bucketSize);
        return `${start}-${end}`;
      });

      const ctx = document.getElementById('distribution-chart').getContext('2d');

      if (!distributionChart) {
        distributionChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              data: buckets,
              backgroundColor: 'rgba(29, 185, 84, 0.7)',
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                callbacks: {
                  label: ctx => ctx.parsed.y + ' ' + t('dataPoints')
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { color: 'rgba(255, 255, 255, 0.5)' }
              },
              x: {
                grid: { display: false },
                ticks: { color: 'rgba(255, 255, 255, 0.5)', maxRotation: 45, minRotation: 45 }
              }
            }
          }
        });
      } else {
        distributionChart.data.labels = labels;
        distributionChart.data.datasets[0].data = buckets;
        distributionChart.update('none');
      }
    }

    // åŠ è½½æ—¶æ®µå›¾è¡¨
    async function loadHourlyChart() {
      try {
        const res = await fetch('/api/analytics/hourly');
        const hourlyData = await res.json();

        if (hourlyData.length === 0) return;

        const labels = hourlyData.map(d => d.hour + ':00');
        const values = hourlyData.map(d => d.avgCount);

        const ctx = document.getElementById('hourly-chart').getContext('2d');

        if (!hourlyChart) {
          hourlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                data: values,
                backgroundColor: 'rgba(29, 185, 84, 0.8)',
                borderRadius: 8,
                borderSkipped: false
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.9)',
                  callbacks: {
                    label: ctx => Math.round(ctx.parsed.y).toLocaleString() + ' avg'
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: 'rgba(255, 255, 255, 0.05)' },
                  ticks: { color: 'rgba(255, 255, 255, 0.5)' }
                },
                x: {
                  grid: { display: false },
                  ticks: { color: 'rgba(255, 255, 255, 0.5)' }
                }
              }
            }
          });
        } else {
          hourlyChart.data.labels = labels;
          hourlyChart.data.datasets[0].data = values;
          hourlyChart.update('none');
        }
      } catch (e) {
        console.error('Failed to load hourly chart:', e);
      }
    }

    // åŠ è½½å¢é•¿è¶‹åŠ¿å›¾è¡¨
    function loadGrowthChart() {
      if (allData.length < 24) return;

      const periods = [
        { label: '1h', data: allData.slice(-12) },
        { label: '6h', data: allData.slice(-72) },
        { label: '12h', data: allData.slice(-144) },
        { label: '24h', data: allData }
      ];

      const current = allData[allData.length - 1].listenerCount;
      const growthRates = periods.map(p => {
        const avg = p.data.reduce((s, d) => s + d.listenerCount, 0) / p.data.length;
        return avg > 0 ? ((current - avg) / avg * 100).toFixed(1) : 0;
      });

      const ctx = document.getElementById('growth-chart').getContext('2d');

      if (!growthChart) {
        growthChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: periods.map(p => p.label),
            datasets: [{
              label: 'Growth %',
              data: growthRates,
              borderColor: '#1DB954',
              backgroundColor: 'rgba(29, 185, 84, 0.2)',
              borderWidth: 3,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                callbacks: {
                  label: ctx => ctx.parsed.y + '%'
                }
              }
            },
            scales: {
              y: {
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { color: 'rgba(255, 255, 255, 0.5)', callback: v => v + '%' }
              },
              x: {
                grid: { display: false },
                ticks: { color: 'rgba(255, 255, 255, 0.5)' }
              }
            }
          }
        });
      } else {
        growthChart.data.labels = periods.map(p => p.label);
        growthChart.data.datasets[0].data = growthRates;
        growthChart.update('none');
      }
    }

    // åŠ è½½å¯¹æ¯”è¡¨æ ¼
    function loadComparisonTable() {
      if (allData.length === 0) return;

      const current = allData[allData.length - 1].listenerCount;
      const get = (hoursAgo) => {
        const index = allData.length - hoursAgo * 12;
        return index >= 0 ? allData[index].listenerCount : null;
      };

      const data1h = get(1);
      const data6h = get(6);
      const data12h = get(12);
      const data24h = get(24);

      const change = (old) => old ? ((current - old) / old * 100).toFixed(1) : null;

      const table = document.getElementById('comparison-table');
      table.innerHTML = `
        <tr>
          <th>${t('comparison.current')}</th>
          <td><span class="comparison-value">${current.toLocaleString()}</span></td>
        </tr>
        ${data1h ? `<tr>
          <th>${t('comparison.1hourAgo')}</th>
          <td>
            <span class="comparison-value">${data1h.toLocaleString()}</span>
            <span class="stat-change ${parseFloat(change(data1h)) >= 0 ? 'positive' : 'negative'}">
              ${parseFloat(change(data1h)) >= 0 ? 'â†—' : 'â†˜'} ${Math.abs(change(data1h))}%
            </span>
          </td>
        </tr>` : ''}
        ${data6h ? `<tr>
          <th>${t('comparison.6hourAgo')}</th>
          <td>
            <span class="comparison-value">${data6h.toLocaleString()}</span>
            <span class="stat-change ${parseFloat(change(data6h)) >= 0 ? 'positive' : 'negative'}">
              ${parseFloat(change(data6h)) >= 0 ? 'â†—' : 'â†˜'} ${Math.abs(change(data6h))}%
            </span>
          </td>
        </tr>` : ''}
        ${data12h ? `<tr>
          <th>${t('comparison.12hourAgo')}</th>
          <td>
            <span class="comparison-value">${data12h.toLocaleString()}</span>
            <span class="stat-change ${parseFloat(change(data12h)) >= 0 ? 'positive' : 'negative'}">
              ${parseFloat(change(data12h)) >= 0 ? 'â†—' : 'â†˜'} ${Math.abs(change(data12h))}%
            </span>
          </td>
        </tr>` : ''}
        ${data24h ? `<tr>
          <th>${t('comparison.24hourAgo')}</th>
          <td>
            <span class="comparison-value">${data24h.toLocaleString()}</span>
            <span class="stat-change ${parseFloat(change(data24h)) >= 0 ? 'positive' : 'negative'}">
              ${parseFloat(change(data24h)) >= 0 ? 'â†—' : 'â†˜'} ${Math.abs(change(data24h))}%
            </span>
          </td>
        </tr>` : ''}
      `;
    }

    // åŠ è½½ç»Ÿè®¡è¡¨æ ¼
    function loadStatisticsTable() {
      if (allData.length === 0) return;

      const values = allData.map(d => d.listenerCount);
      const stats = calculateStats(values);

      const table = document.getElementById('statistics-table');
      table.innerHTML = `
        <tr>
          <th>${t('stat.mean')}</th>
          <td><span class="comparison-value">${stats.mean.toLocaleString()}</span></td>
        </tr>
        <tr>
          <th>${t('stat.median')}</th>
          <td><span class="comparison-value">${stats.median.toLocaleString()}</span></td>
        </tr>
        <tr>
          <th>${t('stat.mode')}</th>
          <td><span class="comparison-value">${stats.mode.toLocaleString()}</span></td>
        </tr>
        <tr>
          <th>${t('stat.stdDev')}</th>
          <td><span class="comparison-value">${stats.stdDev.toLocaleString()}</span></td>
        </tr>
        <tr>
          <th>${t('stat.variance')}</th>
          <td><span class="comparison-value">${stats.variance.toLocaleString()}</span></td>
        </tr>
        <tr>
          <th>${t('stat.cv')}</th>
          <td><span class="comparison-value">${stats.cv}%</span></td>
        </tr>
        <tr>
          <th>${t('stat.range')}</th>
          <td><span class="comparison-value">${stats.range.toLocaleString()}</span></td>
        </tr>
        <tr>
          <th>${t('stat.iqr')}</th>
          <td><span class="comparison-value">${stats.iqr.toLocaleString()}</span></td>
        </tr>
      `;
    }

    // æ£€æŸ¥çŠ¶æ€
    async function checkStatus() {
      try {
        const res = await fetch('/api/status');
        const status = await res.json();

        const badge = document.getElementById('status-badge');
        const alertDiv = document.getElementById('error-alert');

        if (status.errorMessage) {
          badge.innerHTML = `<span class="status-dot" style="background: #ef4444;"></span><span>${t('status.error')}</span>`;
          alertDiv.style.display = 'flex';
          alertDiv.className = 'alert';
          alertDiv.innerHTML = `
            <div class="alert-icon">ğŸš¨</div>
            <div class="alert-content">
              <div class="alert-title">${status.errorMessage}</div>
              <div class="alert-message">Last success: ${status.lastSuccess ? new Date(status.lastSuccess).toLocaleString() : 'Never'}</div>
            </div>
            <button class="alert-action" onclick="handleLogin()">${t('action.login')}</button>
          `;
        } else {
          badge.innerHTML = `<span class="status-dot"></span><span>${t('status.live')}</span>`;
          alertDiv.style.display = 'none';
        }
      } catch (e) {
        console.error('Failed to check status:', e);
      }
    }

    // ç™»å½•å¤„ç†
    function handleLogin() {
      alert('Login feature - please implement based on your authentication method');
    }

    // æ¸…ç©ºæ•°æ®
    async function handleClearData() {
      const confirmed = confirm('âš ï¸ Warning: This will permanently delete all historical data!\n\nAre you sure you want to clear the database?\n\nRecommended: Download CSV backup first.');
      if (!confirmed) return;

      const doubleConfirm = confirm('Final confirmation: Do you really want to delete all data?\n\nThis action cannot be undone!');
      if (!doubleConfirm) return;

      try {
        const res = await fetch('/api/clear-data', { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          alert('âœ… ' + data.message);
          await refresh();
        } else {
          alert('âŒ Failed: ' + data.message);
        }
      } catch (e) {
        alert('âŒ Request failed: ' + e.message);
      }
    }

    // åˆ·æ–°æ‰€æœ‰æ•°æ®
    async function refresh() {
      await Promise.all([
        loadMainChart(),
        loadHourlyChart(),
        checkStatus()
      ]);
    }

    // è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰
    refresh();
    setInterval(refresh, 5000);
  </script>

</body>
</html>
