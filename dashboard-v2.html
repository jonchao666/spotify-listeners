<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify 实时分析仪表盘</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --spotify-green: #1DB954;
      --bg-primary: #0a0a0a;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #252525;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-tertiary: rgba(255, 255, 255, 0.4);
      --border-color: rgba(255, 255, 255, 0.08);
      --success: #1DB954;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* 顶部导航栏 */
    .navbar {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 16px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
    }

    .navbar-content {
      max-width: 1800px;
      margin: 0 auto;
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand-logo {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, var(--spotify-green), #1ed760);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(29, 185, 84, 0.3);
    }

    .brand-logo svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    .brand-info h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .brand-info p {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    .navbar-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .lang-switch {
      display: flex;
      gap: 4px;
      background: var(--bg-tertiary);
      padding: 4px;
      border-radius: 8px;
    }

    .lang-btn {
      padding: 6px 12px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .lang-btn:hover {
      color: var(--text-primary);
    }

    .lang-btn.active {
      background: var(--spotify-green);
      color: white;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(29, 185, 84, 0.1);
      border: 1px solid rgba(29, 185, 84, 0.2);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--spotify-green);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: var(--spotify-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(29, 185, 84, 0.7); }
      50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(29, 185, 84, 0); }
    }

    /* 主容器 */
    .container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 32px;
    }

    /* 分区标题 */
    .section {
      margin-bottom: 48px;
    }

    .section-header {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 800;
      letter-spacing: -0.5px;
      margin-bottom: 8px;
    }

    .section-subtitle {
      font-size: 14px;
      color: var(--text-tertiary);
    }

    /* ========== 首屏重点数据区 ========== */
    .hero-section {
      margin-bottom: 48px;
    }

    /* 核心指标行 */
    .hero-main {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 1200px) {
      .hero-main {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .hero-main {
        grid-template-columns: 1fr;
      }
    }

    /* 统一的指标卡片 */
    .metric-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      border-color: rgba(29, 185, 84, 0.3);
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--spotify-green), #1ed760);
    }


    .metric-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 36px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1;
      margin-bottom: 16px;
    }

    .metric-compare {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .metric-compare-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 12px;
    }

    .metric-compare-label {
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .metric-compare-value {
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 4px;
      text-align: right;
    }

    .metric-change {
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .metric-change.up {
      color: #1DB954;
      background: rgba(29, 185, 84, 0.15);
    }

    .metric-change.down {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.15);
    }

    /* 时段排行表格 */
    .hourly-table {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden;
    }

    .hourly-row {
      display: grid;
      grid-template-columns: 80px 120px 1fr 100px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      align-items: center;
      transition: background 0.2s;
    }

    .hourly-row:last-child {
      border-bottom: none;
    }

    .hourly-row:hover {
      background: var(--bg-tertiary);
    }

    .hourly-row.header {
      background: var(--bg-tertiary);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .hourly-rank {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .hourly-rank.top3 {
      color: var(--spotify-green);
    }

    .hourly-time {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .hourly-regions {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .hourly-region {
      background: var(--bg-tertiary);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .hourly-avg {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      text-align: right;
    }

    .hourly-bar-container {
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }

    .hourly-bar {
      height: 100%;
      background: var(--spotify-green);
      border-radius: 2px;
    }

    @media (max-width: 768px) {
      .hourly-row {
        grid-template-columns: 60px 1fr 80px;
      }
      .hourly-regions {
        display: none;
      }
    }

    /* 关键指标网格 - 保留用于fallback */
    .key-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    /* 当前听众卡片（特殊样式） */
    .key-metric-card.primary {
      background: linear-gradient(135deg, #1DB954, #1ed760);
      border: none;
      box-shadow: 0 10px 30px rgba(29, 185, 84, 0.3);
    }

    .key-metric-card.primary::before {
      display: none;
    }

    .key-metric-card.primary .key-metric-label,
    .key-metric-card.primary .key-metric-value,
    .key-metric-card.primary .key-metric-subtitle,
    .key-metric-card.primary .key-metric-trend {
      color: white;
    }

    .key-metric-trend {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 8px;
    }

    .key-metric-trend-icon {
      font-size: 18px;
    }

    .key-metric-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 32px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .key-metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      border-color: rgba(29, 185, 84, 0.3);
    }

    .key-metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--spotify-green), #1ed760);
    }

    .key-metric-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .key-metric-value {
      font-size: 48px;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 12px;
      letter-spacing: -2px;
    }

    .key-metric-subtitle {
      font-size: 14px;
      color: var(--text-tertiary);
    }

    .key-metric-trend {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(29, 185, 84, 0.15);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      color: var(--spotify-green);
      margin-top: 12px;
    }

    .key-metric-trend.negative {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    /* ========== 图表区域 ========== */
    .chart-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .chart-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .chart-subtitle {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .time-selector {
      display: flex;
      gap: 6px;
      background: var(--bg-tertiary);
      padding: 4px;
      border-radius: 10px;
    }

    .time-btn,
    .chart-type-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .time-btn:hover,
    .chart-type-btn:hover {
      color: var(--text-primary);
    }

    .time-btn.active,
    .chart-type-btn.active {
      background: var(--spotify-green);
      color: white;
    }

    .chart-container {
      position: relative;
      height: 400px;
    }

    /* ========== 详细统计区域 ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      background: var(--bg-tertiary);
      border-color: rgba(29, 185, 84, 0.2);
    }

    .stat-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .stat-hour {
      font-size: 18px;
      font-weight: 700;
    }

    .stat-timezones {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
      line-height: 1.4;
    }

    .stat-timezone {
      display: inline-block;
      margin-right: 8px;
    }

    /* 时段分析卡片 */
    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .insight-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      gap: 16px;
      transition: all 0.3s ease;
    }

    .insight-card:hover {
      background: var(--bg-tertiary);
      border-color: rgba(29, 185, 84, 0.3);
    }

    .insight-card.highlight {
      background: linear-gradient(135deg, rgba(29, 185, 84, 0.15), rgba(29, 185, 84, 0.05));
      border-color: rgba(29, 185, 84, 0.3);
    }

    .insight-card.peak {
      border-left: 3px solid var(--spotify-green);
    }

    .insight-icon {
      font-size: 32px;
      flex-shrink: 0;
    }

    .insight-content {
      flex: 1;
    }

    .insight-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .insight-detail {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .insight-subdetail {
      font-size: 13px;
      color: var(--text-secondary);
      opacity: 0.8;
    }

    .insight-value {
      font-size: 13px;
      color: var(--spotify-green);
      font-weight: 600;
      margin-top: 8px;
    }

    .insight-tag {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(29, 185, 84, 0.2);
      color: var(--spotify-green);
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .insight-tag.low {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .insight-summary {
      background: var(--bg-tertiary);
      border-radius: 16px;
      padding: 24px;
      margin-top: 24px;
    }

    .summary-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .summary-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .summary-list li {
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 14px;
    }

    .summary-list li:last-child {
      border-bottom: none;
    }

    .summary-list strong {
      color: var(--spotify-green);
    }

    .stat-badge {
      padding: 4px 12px;
      background: rgba(29, 185, 84, 0.15);
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      color: var(--spotify-green);
      text-transform: uppercase;
    }

    .stat-badge.low {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .stat-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
    }

    .stat-change {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--danger);
    }

    .stat-change.neutral {
      color: var(--text-tertiary);
    }

    /* ========== 数据分析区域 ========== */
    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }

    .analysis-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 32px;
    }

    .analysis-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .analysis-subtitle {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-bottom: 24px;
    }

    .analysis-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .analysis-row:last-child {
      border-bottom: none;
    }

    .analysis-metric {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .analysis-value {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .analysis-number {
      font-size: 24px;
      font-weight: 700;
    }

    .analysis-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: rgba(29, 185, 84, 0.15);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      color: var(--spotify-green);
    }

    .analysis-trend.negative {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    /* 操作按钮 */
    .actions-section {
      margin-top: 64px;
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 16px 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .action-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--spotify-green);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(29, 185, 84, 0.2);
    }

    .action-btn.danger {
      border-color: rgba(239, 68, 68, 0.3);
    }

    .action-btn.danger:hover {
      border-color: var(--danger);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.2);
    }

    .action-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* 页脚 */
    .footer {
      text-align: center;
      padding: 48px 32px;
      color: var(--text-tertiary);
      font-size: 13px;
      border-top: 1px solid var(--border-color);
      margin-top: 64px;
    }

    /* 加载动画 */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
      flex-direction: column;
      gap: 16px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(29, 185, 84, 0.1);
      border-top-color: var(--spotify-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* 错误提示 */
    .alert {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .alert-icon {
      font-size: 28px;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 700;
      color: var(--danger);
      margin-bottom: 4px;
    }

    .alert-message {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .alert-action {
      padding: 10px 20px;
      background: var(--danger);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .alert-action:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    /* 响应式 */
    @media (max-width: 1200px) {
      .key-metrics {
        grid-template-columns: repeat(2, 1fr);
      }

      .analysis-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .navbar-content {
        padding: 0 20px;
        flex-wrap: wrap;
        gap: 12px;
      }

      .primary-value {
        font-size: 64px;
      }

      .key-metric-value {
        font-size: 36px;
      }

      .key-metrics {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- 导航栏 -->
  <nav class="navbar">
    <div class="navbar-content">
      <div class="brand">
        <div class="brand-logo">
          <svg viewBox="0 0 24 24"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
        </div>
        <div class="brand-info">
          <h1 data-i18n="app.title">实时分析</h1>
          <p data-i18n="app.subtitle">Spotify 听众追踪仪表盘</p>
        </div>
      </div>
      <div class="navbar-actions">
        <div class="lang-switch">
          <button class="lang-btn active" data-lang="zh">中文</button>
          <button class="lang-btn" data-lang="en">English</button>
        </div>
        <div class="status-badge" id="status-badge">
          <span class="status-dot"></span>
          <span data-i18n="status.live">实时监控</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- 主容器 -->
  <div class="container">

    <!-- 错误提示 -->
    <div id="error-alert" style="display: none;"></div>

    <!-- ========== 第一部分：数据概览 ========== -->
    <section class="hero-section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.overview">数据概览</h2>
        <p class="section-subtitle" data-i18n="section.overviewDesc">实时数据与历史对比 <span style="opacity: 0.6; font-size: 12px;" data-i18n="timezone.utc">(UTC时区)</span></p>
      </div>

      <!-- 核心指标 -->
      <div id="hero-content">
        <div class="loading">
          <div class="spinner"></div>
          <p data-i18n="loading">加载中...</p>
        </div>
      </div>
    </section>

    <!-- ========== 第二部分：图表区域 ========== -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.charts">趋势图表</h2>
        <p class="section-subtitle" data-i18n="section.chartsDesc">数据可视化分析</p>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title" data-i18n="chart.timeline">听众趋势</div>
            <div class="chart-subtitle" id="chart-subtitle" data-i18n="chart.timelineDesc">实时听众数量变化 (UTC)</div>
          </div>
          <div style="display: flex; gap: 12px; align-items: center;">
            <div class="time-selector">
              <button class="time-btn active" data-range="720" data-i18n="time.1h">1小时</button>
              <button class="time-btn" data-range="4320" data-i18n="time.6h">6小时</button>
              <button class="time-btn" data-range="8640" data-i18n="time.12h">12小时</button>
              <button class="time-btn" data-range="17280" data-i18n="time.24h">24小时</button>
              <button class="time-btn" data-range="0" data-i18n="time.all">全部</button>
            </div>
            <div class="time-selector">
              <button class="chart-type-btn active" data-type="raw" data-i18n="chart.raw">原始</button>
              <button class="chart-type-btn" data-type="smooth" data-i18n="chart.smooth">平滑</button>
            </div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="main-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- ========== 时段分析 ========== -->
    <section class="section" id="hourly-section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.hourlyStats">时段分析</h2>
        <p class="section-subtitle" data-i18n="section.hourlyStatsDesc">各小时平均听众排行 (UTC)</p>
      </div>
      <div id="hourly-ranking"></div>
    </section>

    <!-- ========== 快捷操作 ========== -->
    <section class="actions-section">
      <div class="section-header">
        <h2 class="section-title" data-i18n="section.actions">快捷操作</h2>
      </div>
      <div class="actions-grid">
        <a href="/api/stats" target="_blank" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
          <span data-i18n="action.stats">统计 API</span>
        </a>
        <a href="/api/data?limit=100" target="_blank" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/></svg>
          <span data-i18n="action.recent">最近数据</span>
        </a>
        <a href="/api/download/csv" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
          <span data-i18n="action.export">导出 CSV</span>
        </a>
        <button onclick="handleLogin()" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
          <span data-i18n="action.login">重新登录</span>
        </button>
        <button onclick="handleClearData()" class="action-btn danger">
          <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          <span data-i18n="action.clear">清空数据</span>
        </button>
      </div>
    </section>

    <!-- 页脚 -->
    <footer class="footer" data-i18n="footer">
      Spotify 实时分析 · Powered by Claude Code
    </footer>
  </div>

  <script>
    // ========== 国际化 ==========
    const i18n = {
      zh: {
        'app.title': '实时分析',
        'app.subtitle': 'Spotify 听众追踪仪表盘',
        'status.live': '实时监控',
        'status.error': '状态异常',
        'loading': '加载中...',
        'section.overview': '核心概览',
        'section.overviewDesc': '最重要的实时数据一目了然',
        'timezone.utc': '(UTC时区)',
        'section.charts': '趋势图表',
        'section.chartsDesc': '数据可视化分析',
        'section.hourlyStats': '时段分析',
        'section.hourlyStatsDesc': '各时区高峰低谷时段洞察',
        'section.analysis': '深度分析',
        'section.analysisDesc': '与历史数据对比分析',
        'section.actions': '快捷操作',
        'chart.timeline': '听众趋势',
        'chart.timelineDesc': '实时听众数量变化 (UTC)',
        'chart.raw': '原始',
        'chart.smooth': '平滑',
        'time.1h': '1小时',
        'time.6h': '6小时',
        'time.12h': '12小时',
        'time.24h': '24小时',
        'time.all': '全部',
        'action.stats': '统计 API',
        'action.recent': '最近数据',
        'action.export': '导出 CSV',
        'action.login': '重新登录',
        'action.clear': '清空数据',
        'footer': 'Spotify 实时分析 · Powered by Claude Code',
        'hero.current': '当前听众',
        'hero.todayAvg': '今日平均',
        'hero.prediction': '预测播放量',
        'hero.todayPrediction': '今日预测播放',
        'hero.peak': '今日峰值',
        'hero.todayPeak': '今日峰值',
        'hero.vs1h': '对比1小时前',
        'hero.predictedStreams': '预计今日播放',
        'hero.based': '基于平均听众数估算',
        'hourly.average': '平均',
        'hourly.vsHistory': '对比历史',
        'hourly.peak': '高峰',
        'hourly.low': '低谷',
        'hourly.listeners': '听众',
        'hourly.noData': '暂无数据',
        'analysis.yesterday': '对比昨天',
        'analysis.yesterdayDesc': '与前一天同时段对比',
        'analysis.lastWeek': '对比上周',
        'analysis.lastWeekDesc': '与7天前同时段对比',
        'analysis.overall': '整体统计',
        'analysis.overallDesc': '全部历史数据汇总',
        'analysis.thisWeek': '本周统计',
        'analysis.thisWeekDesc': '本周(UTC)数据汇总',
        'analysis.thisMonth': '本月统计',
        'analysis.thisMonthDesc': '本月(UTC)数据汇总',
        'analysis.currentAvg': '当前平均',
        'analysis.yesterdayAvg': '昨日平均',
        'analysis.lastWeekAvg': '上周平均',
        'analysis.overallAvg': '整体平均',
        'analysis.weekAvg': '本周平均',
        'analysis.monthAvg': '本月平均',
        'analysis.weekPeak': '本周峰值',
        'analysis.monthPeak': '本月峰值',
        'analysis.overallPeak': '历史峰值',
        'analysis.overallMin': '历史最低',
        'analysis.change': '变化',
        'listeners': '听众',
        'na': '暂无数据'
      },
      en: {
        'app.title': 'Real-Time Analytics',
        'app.subtitle': 'Spotify Listener Tracking Dashboard',
        'status.live': 'Live Monitoring',
        'status.error': 'Error',
        'loading': 'Loading...',
        'section.overview': 'Overview',
        'section.overviewDesc': 'Key metrics at a glance',
        'timezone.utc': '(UTC Timezone)',
        'section.charts': 'Charts',
        'section.chartsDesc': 'Data visualization',
        'section.hourlyStats': 'Time Zone Analysis',
        'section.hourlyStatsDesc': 'Peak and low hours by timezone',
        'section.analysis': 'Deep Analysis',
        'section.analysisDesc': 'Historical data comparison',
        'section.actions': 'Quick Actions',
        'chart.timeline': 'Listener Trends',
        'chart.timelineDesc': 'Real-time listener count changes (UTC)',
        'chart.raw': 'Raw',
        'chart.smooth': 'Smooth',
        'time.1h': '1 Hour',
        'time.6h': '6 Hours',
        'time.12h': '12 Hours',
        'time.24h': '24 Hours',
        'time.all': 'All',
        'action.stats': 'Stats API',
        'action.recent': 'Recent Data',
        'action.export': 'Export CSV',
        'action.login': 'Re-login',
        'action.clear': 'Clear Data',
        'footer': 'Spotify Real-Time Analytics · Powered by Claude Code',
        'hero.current': 'Current Listeners',
        'hero.todayAvg': 'Today Average',
        'hero.prediction': 'Predicted Streams',
        'hero.todayPrediction': 'Today Predicted Streams',
        'hero.peak': 'Peak',
        'hero.todayPeak': 'Today Peak',
        'hero.vs1h': 'vs 1 hour ago',
        'hero.predictedStreams': 'Predicted Daily Streams',
        'hero.based': 'Based on average listener count',
        'hourly.average': 'Average',
        'hourly.vsHistory': 'vs History',
        'hourly.peak': 'Peak',
        'hourly.low': 'Low',
        'hourly.listeners': 'listeners',
        'hourly.noData': 'No data',
        'analysis.yesterday': 'vs Yesterday',
        'analysis.yesterdayDesc': 'Comparison with previous day',
        'analysis.lastWeek': 'vs Last Week',
        'analysis.lastWeekDesc': 'Comparison with 7 days ago',
        'analysis.overall': 'Overall Stats',
        'analysis.overallDesc': 'All historical data summary',
        'analysis.thisWeek': 'This Week',
        'analysis.thisWeekDesc': 'This week (UTC) data summary',
        'analysis.thisMonth': 'This Month',
        'analysis.thisMonthDesc': 'This month (UTC) data summary',
        'analysis.currentAvg': 'Current Average',
        'analysis.yesterdayAvg': 'Yesterday Average',
        'analysis.lastWeekAvg': 'Last Week Average',
        'analysis.overallAvg': 'Overall Average',
        'analysis.weekAvg': 'Week Average',
        'analysis.monthAvg': 'Month Average',
        'analysis.weekPeak': 'Week Peak',
        'analysis.monthPeak': 'Month Peak',
        'analysis.overallPeak': 'All-time Peak',
        'analysis.overallMin': 'All-time Low',
        'analysis.change': 'Change',
        'listeners': 'listeners',
        'na': 'N/A'
      }
    };

    let currentLang = 'zh';

    function t(key) {
      return i18n[currentLang][key] || key;
    }

    function updateLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      refresh();
    }

    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        updateLanguage(btn.dataset.lang);
      });
    });

    // ========== 数据和图表 ==========
    let mainChart;
    let currentRange = 720;
    let chartType = 'raw'; // 'raw' 或 'smooth'
    let allData = [];
    let processedData = []; // 图表使用的处理后数据

    document.querySelectorAll('.time-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentRange = parseInt(btn.dataset.range);
        loadMainChart();
      });
    });

    document.querySelectorAll('.chart-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        chartType = btn.dataset.type;
        loadMainChart();
      });
    });

    // 加载数据概览（整合所有数据展示，独立获取数据）
    async function loadHeroSection() {
      try {
        // 获取统计数据和足够多的历史数据
        const [statsRes, heroDataRes] = await Promise.all([
          fetch('/api/stats'),
          fetch('/api/data?limit=250000')
        ]);

        const stats = await statsRes.json();
        const heroData = await heroDataRes.json();

        if (!stats || stats.totalRecords === 0) {
          document.getElementById('hero-content').innerHTML = `<div class="loading">${t('na')}</div>`;
          return;
        }

        const current = stats.latestCount;
        const nowUTC = new Date();

        // === 今日数据 (UTC) ===
        const todayStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate(), 0, 0, 0, 0));
        const todayData = heroData.filter(d => new Date(d.timestamp) >= todayStartUTC);
        const todayValues = todayData.map(d => d.listenerCount);
        const todayAvg = todayValues.length > 0 ? todayValues.reduce((a, b) => a + b, 0) / todayValues.length : current;
        const todayPeak = todayValues.length > 0 ? Math.max(...todayValues) : current;

        // 今日预测播放量
        const hoursElapsedUTC = (nowUTC - todayStartUTC) / (1000 * 60 * 60);
        const predictedStreams = hoursElapsedUTC > 0 ? Math.round((todayAvg * 24 * 60) / 3) : 0;

        // 对比1小时前
        const data1h = heroData.slice(-720);
        const avg1h = data1h.length > 0 ? data1h.reduce((s, d) => s + d.listenerCount, 0) / data1h.length : 0;
        const trend1h = avg1h > 0 ? ((current - avg1h) / avg1h * 100).toFixed(1) : 0;
        const isUp = parseFloat(trend1h) > 0;

        // === 过去7天数据 (UTC) ===
        const weekStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 6, 0, 0, 0));
        const thisWeekData = heroData.filter(d => new Date(d.timestamp) >= weekStartUTC);
        const thisWeekValues = thisWeekData.map(d => d.listenerCount);
        const thisWeekAvg = thisWeekValues.length > 0 ? thisWeekValues.reduce((a, b) => a + b, 0) / thisWeekValues.length : null;
        const thisWeekPeak = thisWeekValues.length > 0 ? Math.max(...thisWeekValues) : null;

        // === 近30天数据 (UTC) ===
        const monthStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 29, 0, 0, 0));
        const thisMonthData = heroData.filter(d => new Date(d.timestamp) >= monthStartUTC);
        const thisMonthValues = thisMonthData.map(d => d.listenerCount);
        const thisMonthAvg = thisMonthValues.length > 0 ? thisMonthValues.reduce((a, b) => a + b, 0) / thisMonthValues.length : null;
        const thisMonthPeak = thisMonthValues.length > 0 ? Math.max(...thisMonthValues) : null;

        // === 全部数据 ===
        const allValues = heroData.map(d => d.listenerCount);
        const overallAvg = allValues.reduce((a, b) => a + b, 0) / allValues.length;
        const overallPeak = Math.max(...allValues);

        // === 计算各时期预测每日播放量 ===
        // 公式: 平均听众 * 24小时 * 60分钟 / 3分钟(每首歌) = 每日播放
        const calcDailyStreams = (avg) => avg ? Math.round((avg * 24 * 60) / 3) : null;
        const thisWeekDailyStreams = calcDailyStreams(thisWeekAvg);
        const thisMonthDailyStreams = calcDailyStreams(thisMonthAvg);
        const overallDailyStreams = calcDailyStreams(overallAvg);

        // === 昨天数据 (用于对比) ===
        const yesterdayStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 1, 0, 0, 0, 0));
        const yesterdayData = heroData.filter(d => {
          const ts = new Date(d.timestamp);
          return ts >= yesterdayStartUTC && ts < todayStartUTC;
        });
        const yesterdayValues = yesterdayData.map(d => d.listenerCount);
        const yesterdayAvg = yesterdayValues.length > 0 ? yesterdayValues.reduce((a, b) => a + b, 0) / yesterdayValues.length : null;
        const yesterdayPeak = yesterdayValues.length > 0 ? Math.max(...yesterdayValues) : null;
        const yesterdayDailyStreams = calcDailyStreams(yesterdayAvg);

        // === 7-14天前数据 (用于对比) ===
        const lastWeekStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 13, 0, 0, 0));
        const lastWeekEndUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 6, 0, 0, 0));
        const lastWeekData = heroData.filter(d => {
          const ts = new Date(d.timestamp);
          return ts >= lastWeekStartUTC && ts < lastWeekEndUTC;
        });
        const lastWeekValues = lastWeekData.map(d => d.listenerCount);
        const lastWeekAvg = lastWeekValues.length > 0 ? lastWeekValues.reduce((a, b) => a + b, 0) / lastWeekValues.length : null;
        const lastWeekPeak = lastWeekValues.length > 0 ? Math.max(...lastWeekValues) : null;
        const lastWeekDailyStreams = calcDailyStreams(lastWeekAvg);

        // === 上月数据 (用于对比) ===
        const lastMonthStartUTC = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth() - 1, 1));
        const lastMonthData = heroData.filter(d => {
          const ts = new Date(d.timestamp);
          return ts >= lastMonthStartUTC && ts < monthStartUTC;
        });
        const lastMonthValues = lastMonthData.map(d => d.listenerCount);
        const lastMonthAvg = lastMonthValues.length > 0 ? lastMonthValues.reduce((a, b) => a + b, 0) / lastMonthValues.length : null;
        const lastMonthPeak = lastMonthValues.length > 0 ? Math.max(...lastMonthValues) : null;
        const lastMonthDailyStreams = calcDailyStreams(lastMonthAvg);

        // === 计算变化百分比 ===
        const calcChange = (current, previous) => {
          if (!current || !previous) return null;
          return ((current - previous) / previous * 100).toFixed(1);
        };

        const formatChange = (change) => {
          if (change === null) return '';
          const num = parseFloat(change);
          const arrow = num >= 0 ? '↗' : '↘';
          const cls = num >= 0 ? 'up' : 'down';
          return `<span class="metric-change ${cls}">${arrow}${Math.abs(num)}%</span>`;
        };


        // UTC日期格式化
        const utcDateStr = nowUTC.toISOString().split('T')[0];
        const yesterdayDateStr = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 1)).toISOString().split('T')[0];

        // 渲染完整的数据概览
        document.getElementById('hero-content').innerHTML = `
          <!-- 核心指标卡片 -->
          <div class="hero-main">
            <!-- 当前听众 -->
            <div class="metric-card">
              <div class="metric-label">${t('hero.current')}</div>
              <div class="metric-value">${current.toLocaleString()}</div>
              <div class="metric-compare">
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '今日平均' : 'Today Avg'}</span>
                  <span class="metric-compare-value">${todayAvg.toFixed(1)} ${formatChange(calcChange(current, todayAvg))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '昨日平均' : 'Yesterday Avg'}</span>
                  <span class="metric-compare-value">${yesterdayAvg ? yesterdayAvg.toFixed(1) : '-'} ${formatChange(calcChange(current, yesterdayAvg))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '近7天' : '7 Days'}</span>
                  <span class="metric-compare-value">${thisWeekAvg ? thisWeekAvg.toFixed(1) : '-'} ${formatChange(calcChange(current, thisWeekAvg))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '近30天' : '30 Days'}</span>
                  <span class="metric-compare-value">${thisMonthAvg ? thisMonthAvg.toFixed(1) : '-'} ${formatChange(calcChange(current, thisMonthAvg))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '历史平均' : 'All-time Avg'}</span>
                  <span class="metric-compare-value">${overallAvg.toFixed(1)} ${formatChange(calcChange(current, overallAvg))}</span>
                </div>
              </div>
            </div>

            <!-- 今日平均 -->
            <div class="metric-card">
              <div class="metric-label">${currentLang === 'zh' ? '今日平均' : 'Today Avg'} <span style="opacity:0.5;font-size:10px;">UTC ${utcDateStr}</span></div>
              <div class="metric-value">${todayAvg.toFixed(1)}</div>
              <div class="metric-compare">
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '昨日平均' : 'Yesterday Avg'}</span>
                  <span class="metric-compare-value">${yesterdayAvg ? yesterdayAvg.toFixed(1) : '-'} ${formatChange(calcChange(todayAvg, yesterdayAvg))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '近7天' : '7 Days'}</span>
                  <span class="metric-compare-value">${thisWeekAvg ? thisWeekAvg.toFixed(1) : '-'} ${formatChange(calcChange(todayAvg, thisWeekAvg))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '近30天' : '30 Days'}</span>
                  <span class="metric-compare-value">${thisMonthAvg ? thisMonthAvg.toFixed(1) : '-'} ${formatChange(calcChange(todayAvg, thisMonthAvg))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '历史平均' : 'All-time Avg'}</span>
                  <span class="metric-compare-value">${overallAvg.toFixed(1)} ${formatChange(calcChange(todayAvg, overallAvg))}</span>
                </div>
              </div>
            </div>

            <!-- 今日峰值 -->
            <div class="metric-card">
              <div class="metric-label">${currentLang === 'zh' ? '今日峰值' : 'Today Peak'} <span style="opacity:0.5;font-size:10px;">UTC</span></div>
              <div class="metric-value">${todayPeak.toLocaleString()}</div>
              <div class="metric-compare">
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '昨日峰值' : 'Yesterday Peak'}</span>
                  <span class="metric-compare-value">${yesterdayPeak ? yesterdayPeak.toLocaleString() : '-'} ${formatChange(calcChange(todayPeak, yesterdayPeak))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '近7天峰值' : '7 Days Peak'}</span>
                  <span class="metric-compare-value">${thisWeekPeak ? thisWeekPeak.toLocaleString() : '-'} ${formatChange(calcChange(todayPeak, thisWeekPeak))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '近30天峰值' : '30 Days Peak'}</span>
                  <span class="metric-compare-value">${thisMonthPeak ? thisMonthPeak.toLocaleString() : '-'} ${formatChange(calcChange(todayPeak, thisMonthPeak))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '历史峰值' : 'All-time Peak'}</span>
                  <span class="metric-compare-value">${overallPeak.toLocaleString()} ${formatChange(calcChange(todayPeak, overallPeak))}</span>
                </div>
              </div>
            </div>

            <!-- 今日预测播放 -->
            <div class="metric-card">
              <div class="metric-label">${currentLang === 'zh' ? '今日预测播放' : 'Est. Daily Streams'} <span style="opacity:0.5;font-size:10px;">UTC</span></div>
              <div class="metric-value">${predictedStreams.toLocaleString()}</div>
              <div class="metric-compare">
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '昨日预测' : 'Yesterday'}</span>
                  <span class="metric-compare-value">${yesterdayDailyStreams ? yesterdayDailyStreams.toLocaleString() : '-'} ${formatChange(calcChange(predictedStreams, yesterdayDailyStreams))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '近7天' : '7 Days'}</span>
                  <span class="metric-compare-value">${thisWeekDailyStreams ? thisWeekDailyStreams.toLocaleString() : '-'} ${formatChange(calcChange(predictedStreams, thisWeekDailyStreams))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '近30天' : '30 Days'}</span>
                  <span class="metric-compare-value">${thisMonthDailyStreams ? thisMonthDailyStreams.toLocaleString() : '-'} ${formatChange(calcChange(predictedStreams, thisMonthDailyStreams))}</span>
                </div>
                <div class="metric-compare-item">
                  <span class="metric-compare-label">${currentLang === 'zh' ? '历史预测' : 'All-time Avg'}</span>
                  <span class="metric-compare-value">${overallDailyStreams.toLocaleString()} ${formatChange(calcChange(predictedStreams, overallDailyStreams))}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      } catch (e) {
        console.error('Failed to load hero section:', e);
      }
    }

    // 计算线性回归趋势线
    function calculateTrendLine(values) {
      const n = values.length;
      if (n < 2) return values;

      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
      for (let i = 0; i < n; i++) {
        sumX += i;
        sumY += values[i];
        sumXY += i * values[i];
        sumX2 += i * i;
      }

      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;

      return values.map((_, i) => slope * i + intercept);
    }

    // 加载主图表
    async function loadMainChart() {
      try {
        // 性能优化：限制请求数据量
        const limit = currentRange === 0 ? 100000 : currentRange;
        const res = await fetch('/api/data?limit=' + limit);
        allData = await res.json();

        if (allData.length === 0) return;

        processedData = allData;

        // 平滑模式或大数据量：数据聚合
        const needsAggregation = chartType === 'smooth' || allData.length > 1000;

        if (needsAggregation) {
          // 根据数据量和时间范围动态计算聚合大小
          let aggregateSize;
          if (chartType === 'smooth') {
            aggregateSize = currentRange === 720 ? 12 :      // 1h: 每分钟 (12个点)
                            currentRange === 4320 ? 60 :     // 6h: 每5分钟 (60个点)
                            currentRange === 8640 ? 120 :    // 12h: 每10分钟 (120个点)
                            currentRange === 17280 ? 240 :   // 24h: 每20分钟 (240个点)
                            Math.max(60, Math.floor(allData.length / 500)); // all: 动态
          } else {
            // 原始模式大数据量：采样以保持约500个点
            aggregateSize = Math.max(1, Math.floor(allData.length / 500));
          }

          processedData = [];
          for (let i = 0; i < allData.length; i += aggregateSize) {
            const chunk = allData.slice(i, i + aggregateSize);
            const avgCount = chunk.reduce((sum, d) => sum + d.listenerCount, 0) / chunk.length;
            processedData.push({
              timestamp: chunk[Math.floor(chunk.length / 2)].timestamp,
              listenerCount: chartType === 'smooth' ? avgCount : Math.round(avgCount)
            });
          }
        }

        // 使用UTC时间格式化x轴标签
        const labels = processedData.map(d => {
          const date = new Date(d.timestamp);
          const hours = String(date.getUTCHours()).padStart(2, '0');
          const minutes = String(date.getUTCMinutes()).padStart(2, '0');

          if (currentRange >= 8640 || currentRange === 0) {
            // 长时间范围：显示日期+时间
            const month = date.getUTCMonth() + 1;
            const day = date.getUTCDate();
            return `${month}/${day} ${hours}:${minutes}`;
          } else {
            // 短时间范围：只显示时间
            return `${hours}:${minutes}`;
          }
        });
        const values = processedData.map(d => d.listenerCount);

        // 平滑模式下计算趋势线
        const trendLineData = chartType === 'smooth' ? calculateTrendLine(values) : null;

        const ctx = document.getElementById('main-chart').getContext('2d');

        const datasets = [{
          label: currentLang === 'zh' ? '听众数' : 'Listeners',
          data: values,
          borderColor: '#1DB954',
          borderWidth: 3,
          backgroundColor: (context) => {
            const ctx = context.chart.ctx;
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(29, 185, 84, 0.4)');
            gradient.addColorStop(1, 'rgba(29, 185, 84, 0)');
            return gradient;
          },
          fill: true,
          tension: chartType === 'smooth' ? 0.4 : 0.1,
          pointRadius: 0,
          pointHoverRadius: 8,
          pointHoverBackgroundColor: '#1DB954',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 3
        }];

        // 平滑模式下添加趋势线
        if (chartType === 'smooth' && trendLineData) {
          datasets.push({
            label: currentLang === 'zh' ? '趋势线' : 'Trend',
            data: trendLineData,
            borderColor: 'rgba(255, 165, 0, 0.8)',
            borderWidth: 2,
            borderDash: [8, 4],
            backgroundColor: 'transparent',
            fill: false,
            tension: 0,
            pointRadius: 0,
            pointHoverRadius: 0
          });
        }

        if (!mainChart) {
          mainChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { intersect: false, mode: 'index' },
              plugins: {
                legend: {
                  display: chartType === 'smooth',
                  position: 'top',
                  align: 'end',
                  labels: {
                    color: 'rgba(255, 255, 255, 0.7)',
                    usePointStyle: true,
                    pointStyle: 'line',
                    font: { size: 12 }
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.9)',
                  titleColor: '#1DB954',
                  bodyColor: '#fff',
                  titleFont: { size: 16, weight: '700' },
                  bodyFont: { size: 13, weight: '500' },
                  padding: 12,
                  displayColors: true,
                  callbacks: {
                    title: (items) => {
                      if (!items.length) return '';
                      const mainItem = items.find(i => i.datasetIndex === 0);
                      if (!mainItem) return '';
                      return mainItem.parsed.y.toLocaleString() + ' ' + t('listeners');
                    },
                    label: (ctx) => {
                      if (ctx.datasetIndex === 1) {
                        return (currentLang === 'zh' ? '趋势: ' : 'Trend: ') + ctx.parsed.y.toFixed(1);
                      }
                      const idx = ctx.dataIndex;
                      const dataPoint = processedData[idx];
                      if (!dataPoint) return '';

                      const date = new Date(dataPoint.timestamp);
                      const timeStr = date.toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'UTC'
                      });
                      return timeStr + ' UTC';
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  grid: { color: 'rgba(255, 255, 255, 0.05)' },
                  ticks: {
                    color: 'rgba(255, 255, 255, 0.5)',
                    callback: function(value) {
                      return Number.isInteger(value) ? value : '';
                    }
                  }
                },
                x: {
                  grid: { display: false },
                  ticks: { color: 'rgba(255, 255, 255, 0.5)', maxTicksLimit: 12 }
                }
              }
            }
          });
        } else {
          mainChart.data.labels = labels;
          mainChart.data.datasets = datasets;
          mainChart.options.plugins.legend.display = chartType === 'smooth';
          mainChart.update('none');
        }

        // 更新图表副标题显示数据点数量
        const subtitle = document.getElementById('chart-subtitle');
        if (subtitle) {
          const pointCount = processedData.length;
          const originalCount = allData.length;
          const rangeText = currentRange === 0
            ? (currentLang === 'zh' ? '全部数据' : 'All data')
            : (currentLang === 'zh' ? `最近${currentRange === 720 ? '1小时' : currentRange === 4320 ? '6小时' : currentRange === 8640 ? '12小时' : '24小时'}` : `Last ${currentRange === 720 ? '1h' : currentRange === 4320 ? '6h' : currentRange === 8640 ? '12h' : '24h'}`);
          const modeText = chartType === 'smooth' ? (currentLang === 'zh' ? '平滑' : 'Smooth') : (currentLang === 'zh' ? '原始' : 'Raw');
          subtitle.textContent = `${rangeText} · ${pointCount.toLocaleString()} ${currentLang === 'zh' ? '数据点' : 'points'} · ${modeText} (UTC)`;
        }
      } catch (e) {
        console.error('Failed to load main chart:', e);
      }
    }

    // 加载时段排行
    async function loadHourlyRanking() {
      try {
        const res = await fetch('/api/analytics/hourly');
        const hourlyData = await res.json();

        if (!hourlyData || hourlyData.length === 0) {
          document.getElementById('hourly-ranking').innerHTML = `<div class="loading">${t('hourly.noData')}</div>`;
          return;
        }

        // 按平均值排序（降序）- API返回的字段是avgCount
        const sorted = [...hourlyData].sort((a, b) => b.avgCount - a.avgCount);
        const maxAvg = sorted[0].avgCount;

        // UTC时区对应的各国本地时间
        const getRegionalTimes = (utcHour) => {
          const regions = [];
          // 美国东部 (UTC-5)
          const usEastern = (utcHour - 5 + 24) % 24;
          // 日本 (UTC+9)
          const japan = (utcHour + 9) % 24;
          // 英国 (UTC+0)
          const uk = utcHour;
          // 德国 (UTC+1)
          const germany = (utcHour + 1) % 24;
          // 巴西 (UTC-3)
          const brazil = (utcHour - 3 + 24) % 24;

          const formatTime = (hour) => {
            if (hour >= 6 && hour < 12) return currentLang === 'zh' ? '上午' : 'Morning';
            if (hour >= 12 && hour < 18) return currentLang === 'zh' ? '下午' : 'Afternoon';
            if (hour >= 18 && hour < 22) return currentLang === 'zh' ? '晚间' : 'Evening';
            return currentLang === 'zh' ? '深夜' : 'Night';
          };

          regions.push({ flag: '🇺🇸', name: 'US', hour: usEastern, period: formatTime(usEastern) });
          regions.push({ flag: '🇯🇵', name: 'JP', hour: japan, period: formatTime(japan) });
          regions.push({ flag: '🇬🇧', name: 'UK', hour: uk, period: formatTime(uk) });
          regions.push({ flag: '🇩🇪', name: 'DE', hour: germany, period: formatTime(germany) });
          regions.push({ flag: '🇧🇷', name: 'BR', hour: brazil, period: formatTime(brazil) });

          return regions;
        };

        const rows = sorted.map((h, idx) => {
          const barWidth = (h.avgCount / maxAvg * 100).toFixed(1);
          const regions = getRegionalTimes(h.hour);
          const isTop3 = idx < 3;
          const isBottom3 = idx >= sorted.length - 3;

          return `
            <div class="hourly-row">
              <div class="hourly-rank ${isTop3 ? 'top3' : ''}">#${idx + 1}</div>
              <div class="hourly-time">
                ${String(h.hour).padStart(2, '0')}:00 UTC
                ${isTop3 ? `<span class="insight-tag">${t('hourly.peak')}</span>` : ''}
                ${isBottom3 ? `<span class="insight-tag low">${t('hourly.low')}</span>` : ''}
              </div>
              <div class="hourly-regions">
                ${regions.map(r => `<span class="hourly-region">${r.flag} ${r.name} ${r.hour}:00 ${r.period}</span>`).join('')}
              </div>
              <div class="hourly-avg">
                ${h.avgCount.toLocaleString()}
                <div class="hourly-bar-container">
                  <div class="hourly-bar" style="width: ${barWidth}%"></div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('hourly-ranking').innerHTML = `
          <div class="hourly-table">
            <div class="hourly-row header">
              <div>${currentLang === 'zh' ? '排名' : 'Rank'}</div>
              <div>${currentLang === 'zh' ? 'UTC时间' : 'UTC Time'}</div>
              <div>${currentLang === 'zh' ? '各地时间' : 'Local Times'}</div>
              <div>${currentLang === 'zh' ? '平均听众' : 'Avg Listeners'}</div>
            </div>
            ${rows}
          </div>
        `;
      } catch (e) {
        console.error('Failed to load hourly ranking:', e);
        document.getElementById('hourly-ranking').innerHTML = `<div class="loading">${t('hourly.noData')}</div>`;
      }
    }

    // 检查状态
    async function checkStatus() {
      try {
        const res = await fetch('/api/status');
        const status = await res.json();

        const badge = document.getElementById('status-badge');
        const alertDiv = document.getElementById('error-alert');

        if (status.errorMessage) {
          badge.innerHTML = `<span class="status-dot" style="background: #ef4444;"></span><span>${t('status.error')}</span>`;
          alertDiv.style.display = 'flex';
          alertDiv.className = 'alert';
          alertDiv.innerHTML = `
            <div class="alert-icon">🚨</div>
            <div class="alert-content">
              <div class="alert-title">${status.errorMessage}</div>
              <div class="alert-message">Last success: ${status.lastSuccess ? new Date(status.lastSuccess).toLocaleString() : 'Never'}</div>
            </div>
            <button class="alert-action" onclick="handleLogin()">${t('action.login')}</button>
          `;
        } else {
          badge.innerHTML = `<span class="status-dot"></span><span>${t('status.live')}</span>`;
          alertDiv.style.display = 'none';
        }
      } catch (e) {
        console.error('Failed to check status:', e);
      }
    }

    // 登录处理
    function handleLogin() {
      alert('Login feature - please implement based on your authentication method');
    }

    // 清空数据
    async function handleClearData() {
      const confirmed = confirm('⚠️ Warning: This will permanently delete all historical data!\n\nAre you sure you want to clear the database?\n\nRecommended: Download CSV backup first.');
      if (!confirmed) return;

      const doubleConfirm = confirm('Final confirmation: Do you really want to delete all data?\n\nThis action cannot be undone!');
      if (!doubleConfirm) return;

      try {
        const res = await fetch('/api/clear-data', { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          alert('✅ ' + data.message);
          await refresh();
        } else {
          alert('❌ Failed: ' + data.message);
        }
      } catch (e) {
        alert('❌ Request failed: ' + e.message);
      }
    }

    // 刷新所有数据
    async function refresh() {
      await Promise.all([
        loadHeroSection(),
        loadMainChart(),
        loadHourlyRanking(),
        checkStatus()
      ]);
    }

    // 初始化
    async function init() {
      await refresh();
    }

    // 自动刷新（每5秒）
    init();
    setInterval(refresh, 5000);
  </script>

</body>
</html>
